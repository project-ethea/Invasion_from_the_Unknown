#textdomain wesnoth-Invasion_from_the_Unknown

[scenario]
    id=04_Over_the_Sands
    name= _ "Over the Sands"
    {MAP 04_Over_the_Sands.map}
    {TURNS 63 62 61}
    next_scenario=05a_Crossfire
    victory_when_enemies_defeated=no

    {DEATHS_ACT_1}

    {SCENARIO_MUSIC       "knolls.ogg"} {CONTINUE_PLAYING_STORY_MUSIC_FIRST}
    {EXTRA_SCENARIO_MUSIC "wanderer.ogg"}
    {EXTRA_SCENARIO_MUSIC "nunc_dimittis.ogg"}
    {EXTRA_SCENARIO_MUSIC "revelation.ogg"}

    {STORYTXT_OVER_THE_SANDS}

    {TWO_SUNS_DEFAULT_SCHEDULE}

    {DEHYDRATION_EVENTS}

    {SPAWN_CONTROLLER}

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        team_name=elves
        user_team_name= _ "team_name^Elves"

        shroud=yes
        fog=yes

        {GOLD 120 110 100}
        {INCOME 4 4 3}

        # wmllint: recognize Galas
        {CHARACTER_STATS_GALAS}
    [/side]
    # wmllint: validate-on

    [side]
        side=2
        team_name=enemies
        user_team_name= _ "team_name^Orcs"
        {RAGGED_FLAG}

        {GOLD 180 190 220}
        recruit=Orcish Warrior,Wolf Rider,Orcish Archer,Orcish Slayer,Orcish Crossbowman

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT caution 0.20}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "scout,fighter,archer,fighter,archer,mixed fighter"}
        [/ai]

        canrecruit=yes
        type=Orcish Warlord
        id=Karun Baghar
        name= _ "Karun Baghar"
        [modifications]
            {TRAIT_INTELLIGENT}
            {TRAIT_QUICK}
        [/modifications]
        [variables]
            immune_to_dehydration=yes
        [/variables]

        {GENERIC_UNIT () (Orcish Crossbowman) 77 22} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Orcish Crossbowman) 82 20} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Orcish Crossbowman) 75 17} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}

        {GENERIC_UNIT () (Goblin Knight) 74 17} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
    [/side]

#define OTS_AVOID_LOCATIONS
    # Try to not move human units to the eastern side of the map.
    {AI_SIMPLE_ALWAYS_ASPECT_VALUE avoid
    (
        x=60-100
        y=1-40
    )}
#enddef

    [side]
        side=3
        team_name=enemies
        user_team_name= _ "team_name^Barbarians"
        {RAGGED_FLAG}

        {GOLD 110 120 140}
        recruit=Thief,Footpad,Poacher

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution    0.10}
            {AI_SIMPLE_ALWAYS_ASPECT grouping   no}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "fighter,scout,archer"}
            {OTS_AVOID_LOCATIONS}
        [/ai]

        canrecruit=yes
        type=Huntsman
        id=Garren
        name= _" Garren"
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_STRONG}
        [/modifications]

        {NAMED_GENERIC_UNIT () (Outlaw) 35 32 Jurd   ( _ "Jurd")} {NO_UPKEEP_NO_OVERLAY} {FACING ne} {GUARDIAN} {GENDER male}
        {NAMED_GENERIC_UNIT () (Ranger) 31 38 Urthos ( _ "Urthos")} {NO_UPKEEP_NO_OVERLAY} {FACING ne} {GUARDIAN}

        {GENERIC_UNIT () (Footpad) 35 36} {NO_UPKEEP_NO_OVERLAY} {FACING ne} {GUARDIAN}
        {GENERIC_UNIT () (Rogue) 34 34} {NO_UPKEEP_NO_OVERLAY} {FACING ne} {GUARDIAN}

#ifndef EASY
        {GENERIC_UNIT () (Assassin) 25 31} {NO_UPKEEP_NO_OVERLAY} {FACING se} {GUARDIAN} {GENDER male}
#endif

        {GENERIC_UNIT () (Thief) 21 33} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {GENDER male}
        {GENERIC_UNIT () (Thief) 25 29} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {GENDER female}

        {GENERIC_UNIT () (Bandit) 28 30} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
#ifndef EASY
        {GENERIC_UNIT () (Bandit) 19 31} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
#endif
        {GENERIC_UNIT () (Thug)   25 33} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Thug)   23 27} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
    [/side]

    [side]
        side=4
        team_name=elves
        user_team_name= _ "team_name^Neutral Humans"
        {RAGGED_FLAG}

        {GOLD 180 190 200}
        recruit=Thug,Footpad,Dark Adept,Vampire Bat

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_NO_SCOUTS}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution    0.20}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "fighter,archer,scout,fighter,fighter,scout"}
            {OTS_AVOID_LOCATIONS}
        [/ai]

        canrecruit=yes
        type=Fugitive
        id=Neryan
        name= _ "Neryan"
        gender=female
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_INTELLIGENT}
        [/modifications]

        {GENERIC_UNIT () (Skeleton Archer) 20 4} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
#ifndef EASY
        {GENERIC_UNIT () (Skeleton Archer) 14 8} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
#endif
        {GENERIC_UNIT () (Skeleton Archer) 17 5} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
        {GENERIC_UNIT () (Skeleton Archer)  5 6} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
        {GENERIC_UNIT () (Skeleton Archer) 13 3} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}

        {GENERIC_UNIT () (Revenant) 27 11} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
        {GENERIC_UNIT () (Revenant) 25 16} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}

        {GENERIC_UNIT () (Highwayman)  18 8} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
#ifndef EASY
        {GENERIC_UNIT () (Bandit)      15 6} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
#endif
        {GENERIC_UNIT () (Bandit)      8  4} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
    [/side]

    [side]
        side=5
        team_name=enemies
        user_team_name= _ "team_name^Desert Creatures"

        hidden=yes
        no_leader=yes

        {NO_ECONOMY}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_NO_SCOUTS}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution    0.00}
            {AI_SIMPLE_ALWAYS_ASPECT grouping   no}
        [/ai]

        {GENERIC_UNIT () (Wolf) 81 28} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
        {GENERIC_UNIT () (Wolf) 80 29} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
        {GENERIC_UNIT () (Wolf) 81 29} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}

        {GENERIC_UNIT () (Wolf) 93 26}       {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
        {GENERIC_UNIT () (Great Wolf) 92 25} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}

        {GENERIC_UNIT () (Wolf) 96 12} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
        {GENERIC_UNIT () (Wolf) 96 11} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
        {GENERIC_UNIT () (Wolf) 97 12} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}

        {GENERIC_UNIT () (Wolf) 61 27}       {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
        {GENERIC_UNIT () (Wolf) 62 27}       {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
        {GENERIC_UNIT () (Great Wolf) 61 28} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}

        {GENERIC_UNIT () (Direwolf)   82  1} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
        {GENERIC_UNIT () (Wolf)       81  2} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
        {GENERIC_UNIT () (Great Wolf) 86  1} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}

        {GENERIC_UNIT () (Great Wolf) 49 38} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}
        {GENERIC_UNIT () (Great Wolf) 50 38} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}
        {GENERIC_UNIT () (Wolf)       49 39} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}

        {GENERIC_UNIT () (Giant Scorpion) 56 14} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Giant Scorpion) 55 17} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Giant Scorpion) 58 16} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}

        {GENERIC_UNIT () (Giant Scorpion) 59  2} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Giant Scorpion) 61  3} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Giant Scorpion) 67  2} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
    [/side]

    [side]
        side=6
        team_name=enemies
        user_team_name= _ "team_name^Errant Souls"

        hidden=yes
        no_leader=yes

        {NO_ECONOMY}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_NO_SCOUTS}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution    0.00}
            {AI_SIMPLE_ALWAYS_ASPECT grouping   no}
        [/ai]
    [/side]

    {STARTING_VILLAGES 1 4}
    {STARTING_VILLAGES 2 8}

    {PLACE_IMAGE "items/bones.png"           48 24}
    {PLACE_IMAGE "items/bones.png~FL(horiz)" 42 14}
    {PLACE_IMAGE "items/bones.png~FL(horiz)" 63 40}

    {PLACE_IMAGE "scenery/signpost.png" 32 32}

    #
    # Errant Souls
    #

#define OTS_SOUL _RESPAWN_TURNS _X _Y
#ifdef EASY
    {TIMED_SPAWNER {_RESPAWN_TURNS} (type=Errant Soul) 6 {_X} {_Y}}
#endif
#ifdef NORMAL
    {TIMED_SPAWNER {_RESPAWN_TURNS} (type=Errant Soul,Errant Soul,Errant Soul,Ghost) 6 {_X} {_Y}}
#endif
#ifdef HARD
    {TIMED_SPAWNER {_RESPAWN_TURNS} (type=Errant Soul,Errant Soul,Errant Soul,Ghost,Ghost) 6 {_X} {_Y}}
#endif
#enddef

    # NE region
    {OTS_SOUL 6 90  3}
    {OTS_SOUL 6 97  3}
    {OTS_SOUL 6 93  9}
    {OTS_SOUL 6 94  4}
    {OTS_SOUL 6 94  6}
    {OTS_SOUL 6 87  4}

    # Road
    {OTS_SOUL 6 55  6}
    {OTS_SOUL 6 56  9}
    {OTS_SOUL 6 53  8}
    {OTS_SOUL 6 59  8}
    {OTS_SOUL 6 60  5}
    {OTS_SOUL 6 57  7}

    # S oasis
    {OTS_SOUL 6 58 31}
    {OTS_SOUL 6 58 34}
    {OTS_SOUL 6 62 39}
    {OTS_SOUL 6 67 38}
    {OTS_SOUL 6 63 31}
    {OTS_SOUL 6 61 37}

    [event]
        name=prestart

        [deactivate_and_serialize_sides]
            side=3
            variable=late_side_barbarians
        [/deactivate_and_serialize_sides]

        [deactivate_and_serialize_sides]
            side=4
            variable=late_side_neutral
        [/deactivate_and_serialize_sides]

        #
        # Recall heroes
        #

        # wmllint: recognize Anlindë
        {RECALL_ANLINDE_AT    91 35}
        # wmllint: recognize Mal Keshar
        {RECALL_MAL_KESHAR_AT 92 36}

        {ELVISH_SUPPORTER (supporter)}

        {FACE_DIRECTION side=1 nw}

        [remove_shroud]
            side=1
            x=68-101
            y=12-41
        [/remove_shroud]

        {PLAYER_RECRUITMENT_SETUP_FOR_SCENARIO 4}

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Defeat the orcs controlling the oasis")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Galas")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anlindë")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Mal Keshar")}

            {TURNS_RUN_OUT}

            {OBJECTIVE_CARRYOVER}

            {OBJECTIVE_NOTE ( _ "Straying too far from the road is probably not the best thing to do")}
            {OBJECTIVE_NOTE ( _ "Sources of income are very rare in the desert; choose your recruits and recalls carefully")}
            {DEHYDRATION_NOTE}
        )}
    [/event]

    [event]
        name=start

        {LOCK_VIEW}

        [message]
            speaker=Mal Keshar
            message= _ "Ah, the surface! And the sunlight! Scorching hot sand everywhere as usual — how unpleasant."
        [/message]

        [message]
            role=supporter
            message= _ "This environment is even more unfavorable for us than the caves. My lord, there is an oasis north from here. If we want to advance across the sands we will need to make sure our people can rest and replenish supplies there. The problem is..."
        [/message]

        [scroll_to]
            x,y=77,19
        [/scroll_to]

        [message]
            speaker=Galas
            scroll=no
            message= _ "I heard the rumors already. The oasis appears to be controlled by orcs. Is there any other way through?"
        [/message]

        {HIGHLIGHT_GOAL (x,y=77,19)}

        [message]
            speaker=Mal Keshar
            message= _ "Definitely not, unless your intention is to retrace your steps across the surface... and risk facing the demons again without the tactical advantage of your towers and forests. Small orcish tribes like the one ahead generally lack any proper military discipline. Your forest-loving kin should be able to crush them with ease."
        [/message]

        [message]
            speaker=Galas
            message= _ "That isn’t exactly motivating. They have lived in these sands for an epoch or more. They are not the intruders."
        [/message]

        [message]
            speaker=Anlindë
            message= _ "Galas, if you want to lead our people... you will need to become accustomed to making hard decisions like this. There is much at stake — either the lives of a few orcs who would have no qualms about murdering us in our sleep, or the lives of our civilians and children, and our hope of protecting and rebuilding our civilization."
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Galas
            message= _ "I would never choose the orcs’ lives over ours... Let us prepare for the assault, then."
        [/message]

        [message]
            role=supporter
            message= _ "It is only going to become increasingly difficult and expensive to sustain our mounts in this hostile environment. Would that we could replace them with desert beasts."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "If it is your wish to ride sand lions, so be it. I’m sure you won’t mind if I dispatch a few bats and possibly one or two skeletal riders to scout ahead."
        [/message]

        [message]
            speaker=Anlindë
            message= _ "Our agreement did not include allowing you to make use of your foul sorcery in our presence."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Did it include <i>forbidding</i> me from doing so, though?"
        [/message]

        [message]
            speaker=Galas
            message= _ "Let him do as he wishes."
        [/message]

        {ALLOW_RECRUIT 1 ("Skeleton,Skeleton Archer,Skeleton Rider,Ghost,Vampire Bat,Walking Corpse")}

        [transient_message]
            message= _ "You can now recruit undead units.

Elvish units become gradually more expensive to recruit (but not recall) as you progress through scenarios."
        [/transient_message]

        {SHOW_DEHYDRATION_HELP}

        {UNLOCK_VIEW}
    [/event]

    {MAL_KESHAR_1ST_TIME_HELP}

    [event]
        name=side 1 turn 1 end

        # The supporter really shouldn't die before the first turn is over,
        # but one can never be too safe.
        {ELVISH_SUPPORTER (supporter)}

        [message]
            speaker=Anlindë
            message={ASIDE ( _ "Galas, it’s not even midday — has the heat atrophied your senses already?")}
        [/message]

        [message]
            speaker=Galas
            message={ASIDE ( _ "You defeated him once. Surely you could do it again if worst comes to worst. I need to know to what extent we can trust him.")}
        [/message]

        [message]
            role=supporter
            message={ASIDE ( _ "My lord, if you allow me to say so... he is a damned soul, a <i>necromancer</i>! You absolutely <i>cannot</i> place any trust in his words!")}
        [/message]

        [message]
            speaker=Galas
            message={ASIDE ( _ "I need to know his motives for offering us his help. If his intention is to strike us down and raise an army with our corpses, I would rather find out sooner than later.")}
        [/message]
    [/event]

    [event]
        name=turn 2

        [message]
            speaker=Mal Keshar
            # wmllint: local spelling Aaaand
            message= _ "Aaaand, the suns continue their journey through the skies! Hopefully your elves will withstand it long enough to reach the oasis, young leader!"
        [/message]

        {ELVISH_SUPPORTER (supporter)}

        [message]
            speaker=supporter
            message= _ "Will he ever stop mocking us?"
        [/message]
    [/event]

    #
    # Dialogue about water
    #

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            # Any unit with partially or completely uncovered feet
            type=Elvish Druid,Elvish Shyde
            [filter_location]
                terrain=W*
            [/filter_location]
        [/filter]

        [message]
            speaker=unit
            message= _ "female^Ahhh, the refreshing feeling of my feet in the water... I miss our peaceful valley..."
        [/message]
    [/event]

    ############################################################################
    #                                                                          #
    #                                ERRANT SOULS                              #
    #                                                                          #
    ############################################################################

    {FIRE_EVENT_ON_STUMBLE_UPON "found soul" (side=6)}

    [event]
        name=found soul

        [scroll_to]
            x,y=$x2,$y2
        [/scroll_to]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Galas
            message= _ "Those hostile spirits... Is this a trick of yours, Mal Keshar?"
        [/message]

        [message]
            speaker=Anlindë
            message= _ "No. They are corrupted souls who have haunted the desert for an eternity, victims of the destruction that turned Irdya into an endless desert. Physical weapons are of little use against them and they always find a way back — unless, of course, they are banished from our world by spellcasters capable of wielding the arcane fire... or possibly, a necromancer and his minions."
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]
    [/event]

    [event]
        name=last breath
        [filter]
            side=6
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [filter_second_attack]
            type=arcane
        [/filter_second_attack]

        [message]
            speaker=second_unit
            message= _ "Return to the darkness whence you came from!"
        [/message]
    [/event]

    [event]
        name=last breath
        first_time_only=no
        [filter]
            side=6
        [/filter]
        [filter_second]
            side=1
        [/filter_second]
        [filter_second_attack]
            type=arcane
        [/filter_second_attack]

        #
        # Bypass the die event defined by the SPAWN_CONTROLLER macro.
        #

        [floating_text]
            [filter]
                x,y=$x1,$y1
            [/filter]
            text="<span color='red'>"+_"banished"+"</span>" # wmllint: ignore
        [/floating_text]

        [kill]
            x,y=$x1,$y1
            animate=yes
            fire_event=no
        [/kill]
    [/event]

    ############################################################################
    #                                                                          #
    #                                 ORCS STAGE                               #
    #                                                                          #
    ############################################################################

    {FIRE_EVENT_ON_STUMBLE_UPON "found orc" (side=2)}

    [event]
        name=found orc

        [message]
            speaker=second_unit
            message= _ "Hah, the scouts weren’t hallucinating after all! It’s a party of bold little elves heading for our precious oasis. Go get them!"
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]
    [/event]

    [event]
        name=die
        [filter]
            race=orc
        [/filter]
        [filter_second]
            race=undead
        [/filter_second]

        [message]
            speaker=Mal Keshar
            message= _ "Yes, yes, this is more like old times!"
        [/message]
    [/event]

    [event]
        name=attack
        [filter]
            id=Karun Baghar
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [fire_event]
            name=attacked orc leader
        [/fire_event]
    [/event]

    [event]
        name=attack
        [filter_second]
            id=Karun Baghar
        [/filter_second]
        [filter]
            side=1
        [/filter]

        [fire_event]
            name=attacked orc leader
        [/fire_event]
    [/event]

    [event]
        name=attacked orc leader

        [message]
            speaker=Karun Baghar
            message= _ "Elves in <i>my</i> oasis... And you brought a <i>necromancer</i> with you, no less! Begone!"
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Karun Baghar
        [/filter]
        [filter_second]
            race=undead
        [/filter_second]

        [message]
            speaker=Mal Keshar
            message= _ "Any last words, <i>orc</i>?"
        [/message]

        [message]
            speaker=Karun Baghar
            message= _ "Damn... you—"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            id=Karun Baghar
        [/filter]

        [if]
            [have_unit]
                x,y=$x2,$y2
                [and]
                    race=bats
                    [or]
                        race=undead
                    [/or]
                [/and]
            [/have_unit]
            [then]
                [message]
                    speaker=Mal Keshar
                    message= _ "The chieftain kept a small hoard of gold in his tent. We shall surely find a use for it."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=second_unit
                    message= _ "The chieftain kept a small hoard of gold in his tent. We shall surely find a use for it."
                [/message]
            [/else]
        [/if]

        {RETRIEVE_GOLD {DIFF 60 55 50} }

        [fire_event]
            name=stage 2
        [/fire_event]
    [/event]

    ############################################################################
    #                                                                          #
    #                                 MAIN STAGE                               #
    #                                                                          #
    ############################################################################

    [event]
        name=stage 2

        {LOCK_VIEW}

        #
        # Create the barbarian scouts
        #

        {NAMED_GENERIC_UNIT 3 (Bandit)   47 24 Aetheran (  "Aetheran")} {NO_UPKEEP_NO_OVERLAY} {FACING ne}
        {NAMED_GENERIC_UNIT 3 (Trapper)  45 25 Mur      ( _ "Mur")}     {NO_UPKEEP_NO_OVERLAY} {FACING ne}
        {NAMED_GENERIC_UNIT 3 (Trapper)  46 22 Gaether  ( _ "Gaether")} {NO_UPKEEP_NO_OVERLAY} {FACING sw}
        {NAMED_GENERIC_UNIT 3 (Fugitive) 45 20 Merghyn  ( _ "Merghyn")} {NO_UPKEEP_NO_OVERLAY} {FACING ne} {GENDER male}

        [store_starting_location]
            side=2
        [/store_starting_location]

        [remove_terrain_overlays]
            terrain=*^Xo
            x=67-101
            y= 0-41
        [/remove_terrain_overlays]

        [remove_shroud]
            side=1
            x,y=$location.x,$location.y
            radius=16
        [/remove_shroud]

        [redraw]
            side=1
        [/redraw]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Anlindë
            message= _ "The oasis is ours now, but we may not tarry long. Our people can replenish supplies and grab anything of value left behind by the orcs, but it is imperative that we continue scouting ahead and clearing the path."
        [/message]

        [message]
            speaker=Galas
            message= _ "Is this what we have been reduced to? Looters and scavengers?"
        [/message]

        [message]
            speaker=Anlindë
            message= _ "Mal Keshar, where should we head now?"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "West."
        [/message]

        [message]
            race=elf
            [not]
                id=Galas,Anlindë
            [/not]
            message= _ "I thought we were supposed to head northwest!"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "First west, then we can resume traveling northwest. The sands north of here are especially unpleasant, with absolutely no sources of water or food for your troops for miles and miles. Your people would surely starve and perish. On the other hand, the sands and mountains to the west are all that stands between us and a river, and then a green valley leading to the very heart of Irdya."
        [/message]

        [message]
            speaker=Galas
            message= _ "The sooner we find land that isn’t completely covered in sand and infested with orcs..."
        [/message]

        [scroll_to]
            x,y=$location.x,$location.y
        [/scroll_to]

        {CLEAR_VARIABLE location}

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Proceed with Galas to the mountain range on the western side of the map")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Galas")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anlindë")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Mal Keshar")}

            {TURNS_RUN_OUT}

            {OBJECTIVE_CARRYOVER}

            {OBJECTIVE_NOTE ( _ "Straying too far from the road is probably not the best thing to do")}
            {OBJECTIVE_NOTE ( _ "Sources of income are very rare in the desert; choose your recruits and recalls carefully")}
            {DEHYDRATION_NOTE}
        )}

        {UNLOCK_VIEW}
    [/event]

#define OTS_CAPTURE_VILLAGES _SIDE _RADIUS
    [store_starting_location]
        side={_SIDE}
    [/store_starting_location]

    [capture_village]
        x,y=$location.x,$location.y
        radius={_RADIUS}
        side={_SIDE}
    [/capture_village]

    {CLEAR_VARIABLE location}
#enddef

    {FIRE_EVENT_ON_STUMBLE_UPON "found barbarians" (side=3)}

    [event]
        name=found barbarians

        #
        # Activate side 3.
        #

        [unserialize_and_activate_sides]
            side=3
            variable=late_side_barbarians
        [/unserialize_and_activate_sides]

        {CLEAR_VARIABLE late_side_barbarians}

        {OTS_CAPTURE_VILLAGES 3 6}

        [if]
            [have_unit]
                race=elf
                x,y=$x1,$y1
            [/have_unit]
            [then]
                [message]
                    speaker=unit
                    message= _ "Humans ahead. They appear to be bandits— Oh, damn it, they spotted us!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Galas
                    message= _ "There are bandits ahead—"
                [/message]
            [/else]
        [/if]

        [message]
            speaker=second_unit
            message= _ "What is this? Are those... elves? Like in the stories?"
        [/message]

        [message]
            speaker=Aetheran
            message= _ "Undead! They have brought the damned spawns of the darkness with them!"
        [/message]

        [message]
            speaker=Merghyn
            message= _ "Come on, men, it’s time to smash some bones!"
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Galas
            message= _ "I don’t suppose we would make a much better impression without the necromancer’s minions marching amongst us, would we?"
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]

        {OBJECTIVES (
            {HEADER_NEW_OBJECTIVES}

            {OBJECTIVE_VICTORY ( _ "Defeat the leader of the barbarians controlling the mountain pass")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Galas")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anlindë")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Mal Keshar")}

            {TURNS_RUN_OUT}

            {OBJECTIVE_CARRYOVER}

            {OBJECTIVE_NOTE ( _ "Straying too far from the road is probably not the best thing to do")}
            {OBJECTIVE_NOTE ( _ "Sources of income are very rare in the desert; choose your recruits and recalls carefully")}
            {DEHYDRATION_NOTE}
        )}
    [/event]

    [event]
        name=last breath
        [filter]
            id=Garren
        [/filter]
        [filter_second]
            race=elf
        [/filter_second]

        [message]
            speaker=Garren
            message= _ "Damn you... pointy-eared demons... ack—"
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Garren
        [/filter]
        [filter_second]
            [not]
                race=elf
            [/not]
        [/filter_second]

        [message]
            speaker=Garren
            message= _ "(<i>spits blood</i>) Go to hell, necromancer... ack—"
        [/message]

        [if]
            [have_unit]
                race=undead
                x,y=$x2,$y2
            [/have_unit]

            [then]
                [message]
                    speaker=Mal Keshar
                    message= _ "Now, don’t make this more difficult than it needs to be. You are a strong man — I would hate to waste your useful build tearing you into pieces before dealing the killing blow."
                [/message]

                [message]
                    speaker=Galas
                    message= _ "Mal Keshar, stop it. You are not allowed to torture our opponents... or... raise them as undead, for that matter."
                [/message]

                [message]
                    speaker=Mal Keshar
                    message= _ "What does it matter? These are merely barbarians. They know no laws and no honor."
                [/message]

                [message]
                    speaker=Anlindë
                    message= _ "Allow him to die in peace."
                [/message]

                [scroll_to_unit]
                    id=Mal Keshar
                [/scroll_to_unit]

                [delay]
                    time=750
                [/delay]

                [message]
                    speaker=Mal Keshar
                    message= _ "Pah, let one of your own finish the job instead. Such a waste."
                [/message]
            [/then]
        [/if]
    [/event]

    [event]
        name=die
        [filter]
            id=Garren
        [/filter]

        [fire_event]
            name=stage 3
        [/fire_event]
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=32,32
        [/filter]

        [redraw][/redraw]

        [allow_undo][/allow_undo]

        # wmllint: local spelling Arhaghen

        [message]
            speaker=narrator
            image=scenery/signpost.png
            message= _ "Eisenstone Clan — South Arhaghen Hills Fortress"
        [/message]
    [/event]

    ############################################################################
    #                                                                          #
    #                                FINAL STAGE                               #
    #                                                                          #
    ############################################################################

    [event]
        name=stage 3

        {LOCK_VIEW}

        {REPLACE_SCENARIO_MUSIC "revelation.ogg"}

        #
        # Activate side 4.
        #

        [unserialize_and_activate_sides]
            side=4
            variable=late_side_neutral
        [/unserialize_and_activate_sides]

        {CLEAR_VARIABLE late_side_neutral}

        {OTS_CAPTURE_VILLAGES 4 14}

        [teleport]
            [filter]
                id=Neryan
            [/filter]
            x,y=29,18
        [/teleport]

        [message]
            speaker=Galas
            message= _ "(<i>sighs</i>) Orcs, humans... Would that we weren’t forced to kill everything in our way."
        [/message]

        [message]
            speaker=Neryan
            message= _ "Hey, elves."
        [/message]

        [remove_terrain_overlays]
            terrain=*^Xo
            x=19-34
            y=21-24
        [/remove_terrain_overlays]

        [remove_shroud]
            side=1
            x,y=28,22
            radius=4
        [/remove_shroud]

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=28,22
        [/scroll_to]

        {MOVE_UNIT id=Neryan 28 23}

        [unit]
            type=Highwayman
            x,y=27,23
            side=4
            id=cutscene_bodyguard1
        [/unit]

        [unit]
            type=Bandit
            x,y=29,23
            side=4
            id=cutscene_bodyguard2
        [/unit]

        [unit]
            type=Dark Adept
            gender=male
            x,y=28,22
            side=4
            id=cutscene_bodyguard3
        [/unit]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Neryan
            message= _ "Ha, ha... Great job, disposing of those invaders was taking us a bit too long. Ahhhh... How may we repay you? Where is your leader?"
        [/message]

        [message]
            speaker=Galas
            message= _ "That would be me, lord Galas of the elves of the Valley of Elynia. Your men control this pass, I presume?"
        [/message]

        [message]
            speaker=Neryan
            message= _ "Yes... yes, we do. These lands belong to my people, the Eisenstone clan. We do not normally allow visitors in our territory because of... reasons... but perhaps we could make an exception for you and your advisor."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "(<i>coughs</i>)"
        [/message]

        [message]
            speaker=Neryan
            message= _ "... And the necromancer too, of course. We can provide you with food and water for your soldiers at affordable prices... if you are interested, that is!"
        [/message]

        [message]
            speaker=Galas
            message= _ "Thanks for the offer, but we will need supplies and safe passage for a much larger number of people... through your lands, if you don’t mind."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Neryan
            message= _ "... Lord Galas of the elves! Yes, yes, well... we have heard the rumors. Your people hunt down every human who approaches your sacred valley seeking shelter from the demons... You hunt our species like animals, yes, you do. What makes you think we will allow your <i>army</i> to take our lands and lives now, huh? Isn’t that what you came here for?"
        [/message]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Galas
            message= _ "Our intentions are not..."
        [/message]

        [modify_side]
            side=4
            team_name=enemies
        [/modify_side]

        [redraw][/redraw]

        [message]
            speaker=Neryan
            message= _ "<b>Enough!</b> If you know what’s good for you and your kind, you will turn back <i>now</i> or leave through the southwestern pass. Come on, men."
        [/message]

        [kill]
            id=cutscene_bodyguard1,cutscene_bodyguard2,cutscene_bodyguard3
        [/kill]

        {MOVE_UNIT id=Neryan 29 18}

        [store_starting_location]
            side=4
        [/store_starting_location]

        [teleport]
            [filter]
                id=Neryan
            [/filter]
            x,y=$location.x,$location.y
        [/teleport]

        {CLEAR_VARIABLE location}

        [redraw][/redraw]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Anlindë
            message= _ "Their intentions are more transparent than they realize — of course they were trying to set us a trap. Well... Although they have a few necromancers on their side, getting rid of them should be relatively easy."
        [/message]

        [message]
            speaker=Galas
            message= _ "What other options do we have, Mal Keshar?"
        [/message]

        #[remove_terrain_overlays]
        #    terrain=*^Xo
        #    x= 9-17
        #    y=33-40
        #[/remove_terrain_overlays]

        [remove_shroud]
            side=1
            x,y=17,35
            radius=7
        [/remove_shroud]

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=13,37
        [/scroll_to]

        [message]
            speaker=Mal Keshar
            scroll=no
            message= _ "The southwestern pass they mentioned, well, it leads to a completely uninhabited plateau, so it is a valid alternative if you want to avoid fighting the humans. Just note that there are barely any sources of water in that direction — your people would only be able to march at night."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Choosing that option would do little good for your popularity after accepting my offer, he, he."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Galas
            message= _ "Well..."

            [option]
                message= _ "Let us confront the humans."
                [command]
                    [message]
                        speaker=Mal Keshar
                        message= _ "Ha ha ha ha ha! I knew you wouldn’t turn down the possibility for a good fight, boy!"
                    [/message]

                    [message]
                        speaker=Galas
                        message= _ "We shall do this on my terms, though. That means: no killing unless strictly necessary, no torturing captured enemies, and no raising corpses. In particular, no harm must come to the clan leader. We may only assume control of their lands temporarily in order to allow our people through."
                    [/message]

                    [message]
                        speaker=Anlindë
                        message= _ "A sound plan, young leader, but... proving a point to those barbarians, is it really worth it?"
                    [/message]

                    [message]
                        speaker=Galas
                        message= _ "Only time will tell for sure."
                    [/message]

                    [fire_event]
                        name=stage 3 setup
                    [/fire_event]

                    {REPLACE_SCENARIO_MUSIC "loyalists.ogg"}
                    {APPEND_MUSIC           "wanderer.ogg"}
                    {APPEND_MUSIC           "breaking_the_chains.ogg"}
                [/command]
            [/option]

#ifdef 0
            #
            # FIXME: reenable once the new S5b enters production!
            #
            [option]
                message= _ "All this fighting is leading us nowhere. Let us proceed through the southwestern pass."
                [command]
                    [message]
                        speaker=Anlindë
                        message= _ "That is an ill-advised choice, Galas. Proving a point to those barbarians isn’t really worth it."
                    [/message]

                    [message]
                        speaker=Galas
                        message= _ "Only time will tell for sure."
                    [/message]

                    {ENDLEVEL_VICTORY yes} {OVERRIDE_NEXT_SCENARIO 05b_Cursed_Plateau}
                [/command]
            [/option]
#endif
        [/message]

        [scroll_to_unit]
            id=Galas
        [/scroll_to_unit]

        {UNLOCK_VIEW}
    [/event]

#define OTS_MAKE_IMMUNE_TO_UNDEAD_SPECIALS _SUF
    [object]
        silent=yes
        [filter]
            {_SUF}
        [/filter]
        [effect]
            apply_to=status
            add=undrainable
        [/effect]
        [effect]
            apply_to=status
            add=unplagueable
        [/effect]
    [/object]
#enddef

    [event]
        name=stage 3 setup

        #
        # Prevent side 4 units from being plagued or drained.
        #

        [store_unit_ids]
            [filter]
                side=4
                race=human
            [/filter]
            variable=side_4_living_units
        [/store_unit_ids]

        {FOREACH side_4_living_units k}
            {OTS_MAKE_IMMUNE_TO_UNDEAD_SPECIALS id=$side_4_living_units[$k].id}
        {NEXT k}

        {CLEAR_VARIABLE side_4_living_units}

        [event]
            name=prerecruit
            first_time_only=no
            [filter]
                side=4
                race=human
            [/filter]

            {OTS_MAKE_IMMUNE_TO_UNDEAD_SPECIALS x,y=$x1,$y1}
        [/event]

        {OBJECTIVES (
            {HEADER_NEW_OBJECTIVES}

            {OBJECTIVE_VICTORY ( _ "Capture the leader of the Eisenstone clan by reducing her to 0 hitpoints or lower")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Galas")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anlindë")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Mal Keshar")}

            {TURNS_RUN_OUT}

            {OBJECTIVE_CARRYOVER}

            {OBJECTIVE_NOTE ( _ "Plague and drain weapon specials have no effect on the Eisenstone clan humans for the remainder of this scenario")}
            {OBJECTIVE_NOTE ( _ "Straying too far from the road is probably not the best thing to do")}
            {OBJECTIVE_NOTE ( _ "Sources of income are very rare in the desert; choose your recruits and recalls carefully")}
            {DEHYDRATION_NOTE}
        )}
    [/event]

    [event]
        name=last breath
        [filter]
            id=Neryan
        [/filter]

        [message]
            speaker=Neryan
            message= _ "All right, elf lord! You got me and my people... Go ahead and serve us to your starving subjects, what do I care."
        [/message]

        [message]
            speaker=Galas
            message= _ "Of course... It didn’t occur to me that we could deal with our food shortage by feeding upon our prisoners. Sadly, I had a different fate in mind for you and your people, and honestly, I have to wonder where the absurd notion of elves hunting humans for food originated in the first place. Unarye, take this woman and the local necromancers to our camp."
        [/message]

        [hidden_unit]
            # wmllint: recognize Unarye
            {CHARACTER_STATS_UNARYE}
            side=1
            x,y=$x1,$y1
        [/hidden_unit]

        [message]
            speaker=Unarye
            message= _ "Yes, my lord."
        [/message]

        [message]
            speaker=Galas
            message= _ "Let us prepare things for the arrival of our main host."
        [/message]

        [kill]
            id=Unarye,Neryan
        [/kill]

        {ENDLEVEL_VICTORY yes}
    [/event]
[/scenario]

#undef OTS_SOUL
#undef OTS_MAKE_IMMUNE_TO_UNDEAD_SPECIALS
#undef OTS_AVOID_LOCATIONS
#undef OTS_CAPTURE_VILLAGES

# kate: indent-mode normal; encoding utf-8; space-indent on;
