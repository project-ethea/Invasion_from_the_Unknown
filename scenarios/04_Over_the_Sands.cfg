#textdomain wesnoth-Invasion_from_the_Unknown

[scenario]
    id=04_Over_the_Sands
    name= _ "Over the Sands"
    {MAP 04_Over_the_Sands.map}
    {TURNS 76 75 73}
    victory_when_enemies_defeated=no
    next_scenario=05a_Crossfire

    {DAWN1}
    {MORNING1}
    {MIDDAY1}
    {AFTERNOON1}
    {DUSK1}
    {SHORTDARK}
    {DAWN2}
    {MORNING2}
    {MIDDAY2}
    {AFTERNOON2}
    {DUSK2}
    {LONGDARK1}
    {LONGDARK2}
    {LONGDARK3}
    {LONGDARK4}

    [time_area]
        {UNDERGROUND}
        x=114,115,115,116,116,116,117,117,117,117,118,118,118,118,118,119,119,119,119,119,120,120,120,120,120,120
        y=45,44,45,43,44,45,42,43,44,45,41,42,43,44,45,41,42,43,44,45,40,41,42,43,44,45
    [/time_area]

    {EX_SCENARIO_MUSIC_PLAYLIST (
        {EX_MUSIC        "knolls.ogg"}
        {EX_MUSIC_APPEND "wanderer.ogg"}
        {EX_MUSIC_APPEND "nunc_dimittis.ogg"}
        {EX_MUSIC_APPEND "revelation.ogg"}
    )}

    {DEATHS_COMMON}

    {STORYTXT_OVER_THE_SANDS}
    {STORYMAP_OVER_THE_SANDS}

    [side]
        type=Elvish Hero
        id=Galas
        name= _ "Galas"
        unrenamable=yes
        side=1
        canrecruit=yes
        controller=human
        team_name=good
        user_team_name= _ "team_name^Elves"
        shroud,fog=yes,yes
    [/side]

    # Lanya's fort
    [side]
        side=2
        no_leader=yes
        team_name=good
        user_team_name= _ "team_name^Neutral humans"
        hidden=yes
        shroud,fog=yes,yes
        share_maps,share_view=no,no
        controller=null
        [ai]
            {ATTACK_DEPTH 2 3 4}
            aggression=1.0
            caution=0.0
            [avoid]
                x=28-120
                y=1-45
            [/avoid]
        [/ai]
    [/side]


    # Human baddies' fort
    [side]
        side=3
        no_leader=yes
        team_name=human_barbarians,roaming
        user_team_name= _ "team_name^Human barbarians"
        hidden=yes
        shroud,fog=yes,yes
        [ai]
            {ATTACK_DEPTH 3 3 4}
            grouping=no
            aggression=0.9
            caution=0.3
            {AI_TARGET (side=1) 10}
            {AI_TARGET (side=2) 1}
            [avoid]
                x=1-23 ,42-120
                y=19-45,1-45
            [/avoid]
        [/ai]
    [/side]

    # Orcs' fort
    [side]
        side=4
        no_leader=yes
        team_name=orcish_barbarians
        user_team_name= _ "team_name^Orcish barbarians"
        shroud,fog=yes,yes
        hidden=yes

        {GOLD 140 180 220}
        recruit="Orcish Warrior,Wolf Rider,Orcish Archer,Orcish Slayer,Orcish Crossbowman"

        [ai]
            {ATTACK_DEPTH 2 3 4}
            caution=0.2
            recruitment_pattern=scout,fighter,archer,fighter,archer
            [target]
                side=1
                value=10
            [/target]
            # Ignore beasts
            [target]
                side=5
                value=0
            [/target]
            [target]
                side=6
                value=0
            [/target]
            [avoid]
                x=30-45
                y=29-39
            [/avoid]
        [/ai]
    [/side]

    # Roaming ghosts and monsters shouldn't attack each other,
    # thus they share a team.

    [side]
        side=5
        no_leader=yes
        team_name=roaming
        user_team_name= _ "team_name^Roaming ghosts"
        hidden=yes
        [ai]
            aggression=1.0
            caution=0.0
            grouping=no
            {ATTACK_DEPTH 2 3 4}
            {AI_TARGET (side=1) 10.0}
            {AI_TARGET (side=2) 0.01}
            {AI_TARGET (side=3) 0.01}
            {AI_TARGET (side=4) 0.01}
        [/ai]
    [/side]

    [side]
        side=6
        no_leader=yes
        team_name=roaming
        user_team_name= _ "team_name^Roaming creatures"
        hidden=yes
        [ai]
            aggression=1.0
            caution=0.0
            grouping=no
            {ATTACK_DEPTH 2 3 4}
            {AI_TARGET (side=1) 10.0}
            {AI_TARGET (side=2) 0.01}
            {AI_TARGET (side=3) 0.01}
            {AI_TARGET (side=4) 0.01}
        [/ai]
    [/side]

#define __PLAYER_ACTIVATION_EVENT _EVENT_ID _SIDE _UNIT_ATTR _SIDE_ATTR
    [event]
        name={_EVENT_ID}
        first_time_only=yes

        [store_starting_location]
            side={_SIDE}
            variable="__leader_{_SIDE}_starting_loc"
        [/store_starting_location]

        [unit]
            {_UNIT_ATTR}
            side={_SIDE}
            x="$__leader_{_SIDE}_starting_loc.x"
            y="$__leader_{_SIDE}_starting_loc.y"
            canrecruit=yes
            unrenamable=yes
        [/unit]

        {CAPTURE_VILLAGES {_SIDE} "$__leader_{_SIDE}_starting_loc.x" "$__leader_{_SIDE}_starting_loc.y" 8}

        {CLEAR_VARIABLE "__leader_{_SIDE}_starting_loc"}

        [modify_side]
            side={_SIDE}
            hidden=no
            {_SIDE_ATTR}
        [/modify_side]
    [/event]
#enddef

    {__PLAYER_ACTIVATION_EVENT "activate neutral humans" 2
        (
            id=Lanya
            name= _ "Lanya"
            type=Fugitive
            [variables]
                immune_to_dehydration=yes
            [/variables]
        )
        (
            gold=500
            income=-2
            village_gold=0
        )
    }

    {__PLAYER_ACTIVATION_EVENT "activate barbarians" 3
        (
            id=Gledd
            name= _ "Gledd"
            type=Huntsman
            [variables]
                immune_to_dehydration=yes
            [/variables]
        )
        (
            {GOLD 100 125 150}
            recruit=Footpad,Thief,Thug,Poacher,Trapper,Outlaw,Rogue
        )
    }

    {__PLAYER_ACTIVATION_EVENT "activate orcs" 4
        (
            id=Karun Baghar
            name= _ "Karun Baghar"
            type=Orcish Warrior
            profile=portraits/orcs/warlord2.png
            [variables]
                immune_to_dehydration=yes
            [/variables]
        )
        (
            {GOLD 200 255 300}
            recruit=Orcish Warrior,Wolf Rider,Orcish Archer,Orcish Slayer,Orcish Crossbowman
        )
    }

#undef __PLAYER_ACTIVATION_EVENT

    {STARTING_VILLAGES 4 7}

    {PLACE_IMAGE (scenery/mine-abandoned.png) 5 29}
    {PLACE_IMAGE (items/bonestack.png) 27 19}
    {PLACE_IMAGE (items/bonestack.png) 23 9}
    {PLACE_IMAGE (items/bonestack.png) 5 5}
    {PLACE_IMAGE (items/bonestack.png) 16 4}

    [event]
        name=prestart
        {PLAYER_RECRUITMENT_SETUP_FOR_SCENARIO 4}

        {VARIABLE talked_about_elves no}
        # number of ghosts respawned on first or second dusk
        {VARIABLE roaming_ghosts_count ({DIFF 12 18 24})}
        {VARIABLE roaming_ghosts_throttle 0}
        # number of ghosts to kill before reducing respawn count by one
        {VARIABLE roaming_ghosts_throttle_max ({DIFF 1 2 3})}

        {RANDOM 5..10}
        {SCATTER_IMAGE (terrain=Dd,Ds) ($random)  (items/bones.png)}
        {CLEAR_VARIABLE random}

        #
        # Recall heroes
        #
        [recall]
            id=Anlindë
            x,y=118,41
        [/recall]
        [recall]
            id=Mal Keshar
            x,y=117,43
        [/recall]

        #
        # Capture initial villages for the elves
        #
        [capture_village]
            side=1
            x=116,118,120,120
            y=44 ,45 ,42 ,44
        [/capture_village]

        #
        # A guy or gal to taunt Malin
        #
        {ELVISH_SUPPORTER (supporter)}

        {EX_FOREACH_LOCATION (terrain=*^Zi) loc (
            {CONTINUOUS_SOUND_SOURCE "campfire_$loc.x|_$loc.y" $loc.x $loc.y (ambient/campfire.ogg)}
            {SOUND_SOURCE_RANGE 2 8}
        )}

        # Generate human barbarians
        {GENERIC_UNIT 3 (Outlaw)  83 43} {GUARDIAN} {NO_UPKEEP}
        {GENERIC_UNIT 3 (Footpad) 85 44} {GUARDIAN} {NO_UPKEEP} {MAKE_FACING_REVERSE}

        {GENERIC_UNIT 3 (Bandit)  39  9} {GUARDIAN} {NO_UPKEEP}
        {GENERIC_UNIT 3 (Thief)   40  7} {GUARDIAN} {NO_UPKEEP}
        {GENERIC_UNIT 3 (Footpad) 35  7} {GUARDIAN} {NO_UPKEEP}

        # Generate orcish barbarians
        {GENERIC_UNIT 4 (Orcish Grunt)   98 21} {GUARDIAN} {NO_UPKEEP}
        {GENERIC_UNIT 4 (Orcish Grunt)  105 21} {GUARDIAN} {NO_UPKEEP}
        {GENERIC_UNIT 4 (Orcish Grunt)   95 16} {GUARDIAN} {NO_UPKEEP} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 4 (Orcish Grunt)   98 13} {GUARDIAN} {NO_UPKEEP} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 4 (Orcish Grunt)  107 15} {GUARDIAN} {NO_UPKEEP}
        {GENERIC_UNIT 4 (Orcish Archer) 105 27} {NO_UPKEEP}
        {GENERIC_UNIT 4 (Orcish Archer) 100 19} {NO_UPKEEP}
        {GENERIC_UNIT 4 (Orcish Archer) 106 12} {NO_UPKEEP}
        {GENERIC_UNIT 4 ({DIFF (Orcish Assassin) (Orcish Slayer) (Orcish Slayer)}) 107 23} {NO_UPKEEP}
        {GENERIC_UNIT 4 (Wolf Rider) 102 24} {NO_UPKEEP}
        {GENERIC_UNIT 4 (Wolf Rider) 107 24} {NO_UPKEEP}

        # Generate roaming monsters
        {GENERIC_UNIT 6 (Wolf) 103 38} {DO_NOT_DEHYDRATE}
        {GENERIC_UNIT 6 (Wolf) 105 38} {DO_NOT_DEHYDRATE}
        {GENERIC_UNIT 6 (Wolf) 104 36} {DO_NOT_DEHYDRATE}

        {GENERIC_UNIT 6 (Wolf) 62 22} {DO_NOT_DEHYDRATE} {GUARDIAN}
        {GENERIC_UNIT 6 (Wolf) 62 23} {DO_NOT_DEHYDRATE} {GUARDIAN}
        {GENERIC_UNIT 6 (Wolf) 60 23} {DO_NOT_DEHYDRATE} {GUARDIAN}

        {GENERIC_UNIT 6 (Wolf) 55 37} {DO_NOT_DEHYDRATE} {GUARDIAN}
        {GENERIC_UNIT 6 (Wolf) 58 37} {DO_NOT_DEHYDRATE} {GUARDIAN} {MAKE_FACING_REVERSE}

        {GENERIC_UNIT 6 (Giant Mudcrawler) 31 1} {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Giant Mudcrawler) 34 2} {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Giant Mudcrawler) 28 1} {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Mudcrawler) 27 1} {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Mudcrawler) 20 3} {GUARDIAN}
        {GENERIC_UNIT 6 (Giant Mudcrawler) 12 2} {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Giant Mudcrawler) 3 2} {GUARDIAN}

        {GENERIC_UNIT 6 (Mudcrawler) 61 5} {GUARDIAN}
        {GENERIC_UNIT 6 (Mudcrawler) 61 2} {GUARDIAN}

        {GENERIC_UNIT 6 (Giant Scorpion) 73 17} {GUARDIAN}
        {GENERIC_UNIT 6 (Giant Scorpion) 78 18} {GUARDIAN}
        {GENERIC_UNIT 6 (Giant Scorpion) 56 8 } {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Giant Scorpion) 114 2} {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Giant Scorpion) 118 4} {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Giant Scorpion) 103 3} {GUARDIAN}

        {SCATTER_UNITS ({DIFF 4 6 9}) ({DIFF "Vampire Bat" "Vampire Bat,Vampire Bat,Blood Bat" "Vampire Bat,Vampire Bat,Blood Bat,Vampire Bat,Blood Bat,Dread Bat"}) (4) (
            x=35-112
            y=1-45
            [not]
                [filter][/filter]
            [/not]
            [not]
                [filter_adjacent_location]
                    [filter][/filter]
                [/filter_adjacent_location]
            [/not]
            [not]
                terrain=*^Xm
            [/not]
        ) (
            side=6
            random_traits=yes
            generate_name=yes
            ai_special=guardian
        )}

        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Galas, Anlindë, or Mal Keshar must reach the northwest border of the map.")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Anlindë")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
            {OBJECTIVE_NOTES   ( _ "Dehydration applies to living units.")}
        [/objectives]
    [/event]

    [event]
        name=start
        [message]
            speaker=Mal Keshar
            message= _ "Here you are, the outside. Not too different from the last report of some years ago... or perhaps centuries. I cannot tell which."
        [/message]

        [message]
            speaker=Galas
            message= _ "Everything in the distance is so...dry... There is no plant that could thrive in this heat!"
        [/message]

        [message]
            speaker=Anlindë
            message= _ "That is why our people moved to that valley, to protect themselves from death in the desert. Not all of them found the valley, though. We have always wondered what happened to the other group."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "They could only have died in the desert. The harsh suns and the lack of water and food are peril enough; savage orcs or nomadic human bandits complete the tale."
        [/message]

        [message]
            speaker=Galas
            message= _ "I suppose so. But, where are we? The ancient records will have nothing to say of this desert, which was likely a forest before the Fall."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Indeed it was! If I remember correctly, we are standing on Lintanir Forest, the southwestern part of the Northern Elves' homeland...but probably nothing is left of it, of course. Many eons ago, these dry mountains did not even exist."
        [/message]

        [message]
            speaker=Anlindë
            message= _ "Over time, supporting our people will be more difficult, especially here in the desert. Breeding horses for mounts is already difficult for want of fodder."
        [/message]

        [message]
            role=supporter
            message= _ "So, what now, necromancer? We have never been so far from the green of our valley! We will surely perish on these sands!"
        [/message]

        [message]
           speaker=Mal Keshar
           message= _ "You must fill your water reserves at this oasis before departing towards the Northwest. Make sure your healers are prepared to assist your soldiers. We should be able to find more water sources in these sands. I'll summon my scouts to explore the path ahead."
        [/message]
    [/event]

    {./dehydration}

    {MAL_KESHAR_1ST_TIME_HELP}

    {ROAMING_GHOSTS (5)
        (
            x=1-120
            y=1-45
            [not]
                x=1-30
                y=19-45
            [/not]
        )
        ({DIFF 12 18 24})
        ({DIFF 1 2 3})
    }

    [event]
        name=prerecruit
        [filter]
            side=1
            type=Elvish Warrior Spirit
        [/filter]

        [message]
            speaker=Mal Keshar
            message= _ "Come back to this world, from your eternal dream of battles, elvish hero of long past times! I call upon you!"
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]
    [/event]

    [event]
        name=recruit
        [filter]
            side=1
            type=Elvish Warrior Spirit
        [/filter]

        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=unit
            message= _ "At your service, masters!"
        [/message]

        [message]
            speaker=Galas
            message= _ "But, but, that's an elven warrior! Quite pale and... translucid, though. What is this, Mal Keshar?"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "This is one of your fallen kinsmen from battles past. In contrast with most of my minions, this elvish spirit does not fight unwillingly; he has been following you all this time, and while not having the power to materialize by himself, he has been waiting for the opportunity to fight for you once again. He just needed a little help from an expert, such as myself."
        [/message]

        [message]
            speaker=Galas
            message= _ "Are you saying that he has his own will, then?"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Exactly. Note that these spirits are stronger and deadlier when fighting in forests. Unfortunately, I am not sure whether there are any left in this age."
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]
    [/event]

    [event]
        name=attack_end
        [filter]
            side=1
            race=undead
            [or]
                race=elvish_spirits
            [/or]
            [not]
                id=Mal Keshar
            [/not]
        [/filter]

        [message]
            speaker=Galas
            message= _ "(shakes head) I see it but I don't believe it... Undead fighting for our cause..."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "At some point you'll get accustomed to that."
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]
    [/event]

    #
    # Sighted ghosts
    #

    [event]
        name=found ghost
        first_time_only=yes

        [message]
            speaker=Galas
            message= _ "A ghost?"
        [/message]

        [message]
            speaker=Anlindë
            message= _ "It seems hostile. Mal Keshar, can you do anything about it?"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "No. These ghosts have free will, and roam about these sands due to their painful deaths."
        [/message]
    [/event]

    {FIRE_EVENT_ON_STUMBLE_UPON "found ghost" (side=5)}

    #
    # Sighted orcs
    #

    [event]
        name=found orc

        [fire_event]
            name=activate orcs
        [/fire_event]

        [if]
            [have_unit]
                x,y=$x1,$y1
                [and]
                    race=elf
                    [or]
                        race=fairy
                    [/or]
                [/and]
            [/have_unit]
            [then]
                {VARIABLE talked_about_elves yes}

                [message]
                    speaker=second_unit
                    message= _ "Oh...elves? I must be hallucinating again..."
                [/message]

                [message]
                    speaker=unit
                    message= _ "This doesn't look good..."
                [/message]

                [message]
                    speaker=second_unit
                    message= _ "But I never had hallucinations that could speak. Intruders! And they are elves! Go get 'em!"
                [/message]

                [message]
                    speaker=Galas
                    message= _ "Anyone who dares oppose us shall perish, whether it be orc or human."
                [/message]

                [message]
                    speaker=Mal Keshar
                    message= _ "Orcs... Good. It has been a long time since I defeated one myself!"
                [/message]

                [message]
                    speaker=Galas
                    message= _ "We could ignore them and continue our journey, but I'm not sure if it would be a good idea."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=second_unit
                    message= _ "Undead! Everyone, to arms! It's an invasion!"
                [/message]

                [message]
                    speaker=Mal Keshar
                    message= _ "Somebody should catch that idiot and cut out his tongue. Now that he has given alarm to his friends, we will have to deal with them!"
                [/message]
            [/else]
        [/if]

        {SCROLL_TO $x1 $y1}
    [/event]

    {FIRE_EVENT_ON_STUMBLE_UPON "found orc" (side=4)}

    #
    # Defeated orcs
    #

    [event]
        name=last breath
        [filter]
            side=4
            canrecruit=yes
        [/filter]

        [message]
            speaker=unit
            message= _ "Argh! I'm vanquished by these puny invaders!"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            side=4
            canrecruit=yes
        [/filter]

        [if]
            [have_unit]
                x,y=$x2,$y2
                [and]
                    race=bats
                    [or]
                        type=Walking Corpse,Soulless,Ghoul_C,Necrophage
                    [/or]
                [/and]
            [/have_unit]
            [then]
                {VARIABLE capable_speaker "Mal Keshar"}
            [/then]
            [else]
                {VARIABLE capable_speaker "second_unit"}
            [/else]
        [/if]

        [message]
            speaker=$capable_speaker
            message= _ "This orc kept some gold in his tent. It is not more than a few dozen, but it is better than nothing."
        [/message]

        {RETRIEVE_GOLD {DIFF 45 40 36}}
    [/event]

    #
    # Sighted mudcrawlers
    #

    [event]
        name=found mudcrawler

        [message]
            speaker=second_unit
            message= _ "Rooaargh!!"
        [/message]

        [if]
            [have_unit]
                x,y=$x1,$y1
                [and]
                    race=elf
                    [or]
                        race=fairy
                    [/or]
                [/and]
            [/have_unit]
            [then]
                {VARIABLE elvish_speaker unit}
            [/then]
            [else]
                {VARIABLE elvish_speaker Galas}
            [/else]
        [/if]

        [message]
            speaker=$elvish_speaker
            message= _ "I have seen and heard about odd things in my life, but that is just ridiculous! A crawling glob of mud?"
        [/message]

        {CLEAR_VARIABLE elvish_speaker}

        [message]
            speaker=Mal Keshar
            message= _ "Crawling, yes. But it is not a simple glob of mud - it has been animated by magic means. Although they are not especially tough, if you get surrounded by a pack of them you will have serious trouble. Especially if you have been under these suns for too long. He, he."
        [/message]

        {SCROLL_TO $x1 $y1}
    [/event]

    {FIRE_EVENT_ON_STUMBLE_UPON "found mudcrawler" (
        type=Mudcrawler
        [or]
            type=Giant Mudcrawler
        [/or]
        [or]
            type=Mother Mudcrawler
        [/or]
    )}

    #
    # Sighted neutral humans
    #

    [event]
        name=moveto
        [filter]
            side=1
            x=1-25
            y=25-45
        [/filter]

        [redraw][/redraw]

        # FIXME: [allow_undo] is not safe if we're clearing shroud
        #        or fog here as well.

        [fire_event]
            name=activate neutral humans
        [/fire_event]
    [/event]

    #
    # Sighted human barbarians
    #

    [event]
        name=sighted
        [filter]
            side=3
            x=79-93
            y=38-45
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [redraw][/redraw]

        [message]
            speaker=unit
            message= _ "This is <i>our</i> oasis. Go away or we'll crush your skulls into the sand!"
        [/message]
    [/event]


    [event]
        name=sighted
        [filter]
            side=3
            x=35-46
            y= 3-10
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [redraw][/redraw]

        [message]
            speaker=unit
            message= _ "As if those damned bats weren't enough. Get away from our territory!"
        [/message]
    [/event]

    #
    # Entering human barbarians' territory
    #

    [event]
        name=moveto
        [filter]
            side=1
            x=23-53
            y=18-33
        [/filter]

        # FIXME: [allow_undo] is not safe if we're clearing shroud
        #        or fog here as well.

        [fire_event]
            name=activate barbarians
        [/fire_event]

        #
        # Try not to let the castle hexes unoccupied so the
        # player cannot use them to his advantage so quickly.
        #
#ifdef EASY
    #define __RANDOM_GUARDIAN _X _Y
        {RANDOM Footpad,Thief,Outlaw,Rogue}
        {GENERIC_UNIT 3 $random {_X} {_Y}} {NO_UPKEEP} {GUARDIAN}
    #enddef
#else
    #define __RANDOM_GUARDIAN _X _Y
        {RANDOM Outlaw,Rogue,Bandit}
        {GENERIC_UNIT 3 $random {_X} {_Y}} {NO_UPKEEP} {GUARDIAN}
    #enddef
#endif

        {__RANDOM_GUARDIAN 44 20}
        {__RANDOM_GUARDIAN 33 17}
        {__RANDOM_GUARDIAN 28 19}
        {__RANDOM_GUARDIAN 24 18}

        {GENERIC_UNIT 3 Footpad 14 14} {NO_UPKEEP} {GUARDIAN}
        {GENERIC_UNIT 3 Thief   25 11} {NO_UPKEEP} {GUARDIAN}
        {GENERIC_UNIT 3 Poacher 17  8} {NO_UPKEEP} {GUARDIAN}
        {GENERIC_UNIT 3 Thug    27 13} {NO_UPKEEP} {GUARDIAN}

        {GENERIC_UNIT 3 Thug    10 10} {NO_UPKEEP} {GUARDIAN}
        {GENERIC_UNIT 3 Trapper  7  8} {NO_UPKEEP} {GUARDIAN}
        {GENERIC_UNIT 3 Trapper 23 13} {NO_UPKEEP} {GUARDIAN}

        {RANDOM_PLACEMENT_AREA 47 20 5}

        {VARIABLE_RANDOM ambush_count.poachers ({DIFF 1    1..2 1..3})}
        {VARIABLE_RANDOM ambush_count.footpads ({DIFF 3..5 3..5 3..6})}
        {VARIABLE_RANDOM ambush_count.thugs    ({DIFF 2..3 2..4 2..4})}
        {VARIABLE_RANDOM ambush_count.trappers ({DIFF 1    1..2 1..2})}

#define __SPAWN_BARBARIANS _TYPE _AMOUNT
        {VARIABLE_RANDOM random_facing n,ne,se}
        {PLACE_UNITS_RANDOMLY ({_AMOUNT}) 3 ({_TYPE}) () ()
            (
                upkeep="loyal"
                random_gender=yes
                generate_name=yes
                random_traits=yes
                facing=$random_facing
                [variables]
                    immune_to_dehydration=yes
                [/variables]
            )
        }
#enddef

        {__SPAWN_BARBARIANS "Footpad" $ambush_count.footpads}
        {__SPAWN_BARBARIANS "Trapper" $ambush_count.trappers}
        {__SPAWN_BARBARIANS "Thug"    $ambush_count.thugs}
        {__SPAWN_BARBARIANS "Poacher" $ambush_count.poachers}

#undef __SPAWN_BARBARIANS

        {CLEAR_PLACEMENT_AREA}

        {CLEAR_VARIABLE ambush_count,random_facing,random}

        [redraw][/redraw]

        #
        # Prefer visible baddies when talking
        #

        [role]
            side=3
            canrecruit=no
            role=filthy
            [filter_location]
                x,y,radius=47,20,5
            [/filter_location]
        [/role]

        [message]
            role=filthy
            message= _ "Ha, ha, ha! We got you! There is no way out now!"
        [/message]

        [if]
            [have_unit]
                x,y=$x1,$y1
                [and]
                    [not]
                        type=Ghoul_C,Necrophage,Walking Corpse,Soulless
                    [/not]
                    [not]
                        race=bats
                    [/not]
                [/and]
            [/have_unit]
            [then]
                [message]
                    speaker=unit
                    message= _ "Aaah! Help!"
                [/message]
            [/then]
        [/if]

        [if]
            [have_unit]
                x=23-53
                y=18-33
                [and]
                    race=elf
                    [or]
                        race=fairy
                    [/or]
                [/and]
            [/have_unit]
            [then]
                {VARIABLE talked_about_elves yes}

                [message]
                    role=filthy
                    message= _ "Hey, wait, is that an elf? I thought they were long gone from the face of earth!"
                [/message]

                [message]
                    side=3
                    canrecruit=no
                    [filter_location]
                        x,y,radius=47,20,5
                    [/filter_location]
                    [not]
                        role=filthy
                    [/not]
                    message= _ "These pointy-eared demons just impossible to get rid of."
                [/message]

                [message]
                    role=filthy
                    message= _ "It matters little now. Kill it!"
                [/message]
            [/then]
            [else]
                [message]
                    role=filthy
                    message= _ "Undead! These damned abominations pursue us again!"
                [/message]

                [message]
                    side=3
                    canrecruit=no
                    [filter_location]
                        x,y,radius=47,20,5
                    [/filter_location]
                    [not]
                        role=filthy
                    [/not]
                    message= _ "Ah, but I love the sound of smashing skeletons!"
                [/message]
            [/else]
        [/if]

        [message]
            speaker=Anlindë
            message= _ "They are blocking our path through the mountains. We must defeat them before continuing."
        [/message]

        [objectives]
            side=1
            summary= _ "New objectives:"
            {OBJECTIVE_TO_WIN ( _ "Defeat the leader of the bandits who control the northwestern pass.")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Anlindë")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
            {OBJECTIVE_NOTES   ( _ "Dehydration applies to living units.")}
        [/objectives]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]
    [/event]

    #
    # Defeated barbarians
    #

    [event]
        name=last breath
        [filter]
            side=3
            canrecruit=yes
        [/filter]

        [message]
            speaker=unit
            message= _ "Ouch! Noo...I'm finished...and we have lost...our precious valley..."
        [/message]

        [message]
            speaker=Galas
            message= _ "The irony in this is unsettling."
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]
    [/event]

    [event]
        name=die
        [filter]
            side=3
            canrecruit=yes
        [/filter]

        [if]
            [have_unit]
                x,y=$x2,$y2
                [and]
                    [not]
                        type=Walking Corpse,Ghoul_C,Necrophage,Soulless
                    [/not]
                    [not]
                        race=bats
                    [/not]
                    # Do not let Galas go all chatty with three consecutive lines
                    [not]
                        id=Galas
                    [/not]
                [/and]
            [/have_unit]
            [then]
                [message]
                    speaker=second_unit
                    message= _ "These bandits seem to have accumulated some gold. It's not a great amount, but it will do for our needs."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Anlindë
                    message= _ "These bandits seem to have accumulated some gold. It's not a great amount, but it will do for our needs."
                [/message]
            [/else]
        [/if]

        {RETRIEVE_GOLD {DIFF 50 40 30}}

        [remove_shroud]
            side,x,y=1,13,10
            radius=6
        [/remove_shroud]

        [redraw][/redraw]

        [scroll_to]
            x,y=13,10
        [/scroll_to]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Galas
            message= _ "This seems to have been a colossal elvish fortress very long ago before the sand buried it in the ground. It is in a very convienient location - but we cannot tarry here for much longer, lest we become prey of better prepared barbarians."
        [/message]

        [message]
            speaker=Anlindë
            message= _ "At least we can replenish our supplies here and heal the wounded before continuing."
        [/message]

        [objectives]
            side=1
            {OBJECTIVE_TO_WIN_COMPLETE ( _ "Defeat the leader of the bandits who control the northwestern pass.")}
            {OBJECTIVE_TO_WIN ( _ "Galas, Anlindë, or Mal Keshar must reach the northwest border of the map.")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Anlindë")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
            {OBJECTIVE_NOTES   ( _ "Dehydration applies to living units.")}
        [/objectives]
    [/event]

    #
    # Elf or faerie stepping on road hexes, or a hex adjacent to one
    #

    [event]
        name=moveto
        [filter]
            side=1
            x=60-120
            y=1-45
            [and]
                race=elf
                [or]
                    race=fairy
                [/or]
            [/and]
            [and]
                [filter_location]
                    terrain=Rr
                [/filter_location]
                [or]
                    [filter_location]
                        [filter_adjacent_location]
                            terrain=Rr
                        [/filter_adjacent_location]
                    [/filter_location]
                [/or]
            [/and]
        [/filter]

        [redraw][/redraw]

        # FIXME: [allow_undo] is not safe if we're clearing shroud
        #        or fog here as well.

        [message]
            speaker=unit
            message= _ "After all this time, the old elven roads still exist under the sands. It is unfortunate that they cannot guide us anywhere now."
        [/message]
    [/event]

    #
    # Elf or faerie stepping on castle hexes, or a hex adjacent to one
    #

    [event]
        name=moveto
        [filter]
            side=1
            x=42-120
            y=1-45
            [and]
                race=elf
                [or]
                    race=fairy
                [/or]
            [/and]
            [and]
                [filter_location]
                    terrain=Chr
                [/filter_location]
                [or]
                    [filter_location]
                        [filter_adjacent_location]
                            terrain=Chr
                        [/filter_adjacent_location]
                    [/filter_location]
                [/or]
            [/and]
        [/filter]

        [redraw][/redraw]

        # FIXME: [allow_undo] is not safe if we're clearing shroud
        #        or fog here as well.

        [message]
            speaker=unit
            message= _ "Ah, the ruins of ancient elven castles. I wish they could still provide us with shelter from the harsh light of the suns."
        [/message]
    [/event]

    #
    # Northwest path (regular victory trigger)
    #

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x=1
            y=1-4
            [and]
                id=Galas
                [or]
                    id=Anlindë
                [/or]
                [or]
                    id=Mal Keshar
                [/or]
            [/and]
        [/filter]

        [redraw][/redraw]

        [if]
            [have_unit]
                side=3
                canrecruit=yes
            [/have_unit]
            [then]
                [message]
                    speaker=unit
                    message= _ "We can't continue without defeating these bandits first!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "The river continues to the northwest."
                [/message]

                [message]
                    speaker=Mal Keshar
                    message= _ "We should follow this river. Although I cannot know exactly where it leads, I suspect it should get us close to the Heart Mountains. It will also be easier for you to travel across the sands with an unlimited water supply by your side."
                [/message]

                {ENDLEVEL_VICTORY yes}
            [/else]
        [/if]
    [/event]

    #
    # Dialogue about water
    #

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            # Any unit with partially or completely uncovered feet
            type=Elvish Druid,Elvish Shyde,Faerie Dryad,Faerie Sprite,Fire Faerie
            [filter_location]
                terrain=W*
                [not]
                    x=110-120
                    y= 36-45
                [/not]
            [/filter_location]
        [/filter]

        [redraw][/redraw]

        [message]
            # She is feeling like a fish out of water, hence the emphasis. No pun intended.
            speaker=unit
            message= _ "Ahhh, the refreshing feel of my feet in the water of this oasis... I wish I could spend all the day here, instead of <i>fighting</i> enemies over the sands. Oh, how much I miss our peaceful valley..."
        [/message]
    [/event]

    #
    # Alternative valley
    #

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x= 1-26
            y=23-32
        [/filter]

        # FIXME: [allow_undo] is not safe if we're clearing shroud
        #        or fog here as well.

        [fire_event]
            name=activate neutral humans
        [/fire_event]

        # Generate neutral humans
        {GENERIC_UNIT 2 (Ranger)  26 27} {GUARDIAN} {NO_UPKEEP}
        {GENERIC_UNIT 2 (Ranger)  25 23} {GUARDIAN} {NO_UPKEEP} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 2 (Footpad) 17 27} {GUARDIAN} {NO_UPKEEP} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 2 (Bandit)  10 28} {GUARDIAN} {NO_UPKEEP}
        {GENERIC_UNIT 2 (Outlaw)  22 24} {GUARDIAN} {NO_UPKEEP}
        {GENERIC_UNIT 2 (Trapper) 22 27} {GUARDIAN} {NO_UPKEEP}

        {GENERIC_UNIT 2 (Ruffian) 10 26} {GUARDIAN} {NO_UPKEEP} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 2 (Thief)   7  26} {GUARDIAN} {NO_UPKEEP}
        {GENERIC_UNIT 2 (Ruffian) 18 22} {GUARDIAN} {NO_UPKEEP}
        {GENERIC_UNIT 2 (Rogue)   16 25} {GUARDIAN} {NO_UPKEEP}
        {GENERIC_UNIT 2 (Bandit)  17 21} {GUARDIAN} {NO_UPKEEP} {MAKE_FACING_REVERSE}

        [capture_village]
            side=2
            x,y=7,26
        [/capture_village]

        [modify_side]
            side=1
            share_maps,share_view=yes,yes
        [/modify_side]
        [modify_side]
            side=2
            share_maps,share_view=yes,yes
        [/modify_side]

        [store_gold]
            side=1
            variable=player_gold
        [/store_gold]

        [redraw][/redraw]

        [message]
            side=2
            canrecruit=no
            message= _ "Halt there, strangers! Do you come to our valley in peace, or not?"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Is that a trick question?"
        [/message]

        [message]
            speaker=Galas
            message= _ "We come in peace. We are just looking for water, food, and safe passage to the northwest."
        [/message]

        [message]
            speaker=Lanya
            message= _ "We have plenty of water and food here, but if you want to bring your men here, you will have to give us $free_value pieces of gold first. We need to be sure whether your intentions are good or not."
        [/message]

        [message]
            speaker=Mal Keshar
            message={ASIDE ( _ "If they actually have so much resources, why do they need our gold at all?")}
        [/message]

        [message]
            speaker=Anlindë
            message={ASIDE ( _ "I do not know. It might be a local custom.")}
        [/message]

        {VARIABLE alt_valley_fee_mode friendly}

        [fire_event]
            name=fee request
        [/fire_event]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x= 9-22
            y=20-29
        [/filter]

        [if]
            {VARIABLE_LEXICAL_EQUALS alt_valley_fee_mode hostile}
            [then]
                [fire_event]
                    name=fee request
                [/fire_event]
            [/then]
        [/if]
    [/event]

    [event]
        name=fee request
        first_time_only=no

        [if]
            {VARIABLE_LEXICAL_EQUALS alt_valley_fee_mode friendly}
            [or]
                {VARIABLE_LEXICAL_EQUALS alt_valley_fee_mode hostile}
            [/or]
            [then]
                [message]
                    speaker=Galas
                    message= _ "Um..."
                    [option]
                        message= _ "Very well. Here is the gold."
                        [show_if]
                            {VARIABLE_NUM_GREATER_OR_EQUAL_THAN player_gold $fee_value}
                        [/show_if]
                        [command]
                            [gold]
                                side=1
                                amount=-$fee_value
                            [/gold]

                            {VARIABLE alt_valley_fee_mode paid}

                            [message]
                                speaker=Lanya
                                message= _ "You are welcome, then. As long as you don't start pillaging our villages, that is. Know that if you do so, you'll encounter only problems."
                            [/message]

                            [event]
                                name=capture
                                [filter]
                                    side=1
                                    x= 1-26
                                    y=23-32
                                [/filter]

                                {VARIABLE alt_valley_fee_mode attacked}

                                [fire_event]
                                    name=valley attacked
                                [/fire_event]
                            [/event]
                        [/command]
                    [/option]
                    [option]
                        message= _ "I have changed my mind. We have come to take over your valley."
                        [command]
                            {VARIABLE alt_valley_fee_mode attacked}

                            [fire_event]
                                name=valley attacked
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        message= _ "I think we'll just leave for the moment."
                        [show_if]
                            {VARIABLE_NUM_GREATER_OR_EQUAL_THAN player_gold $fee_value}
                        [/show_if]
                        [command]
                            [if]
                                {VARIABLE_LEXICAL_EQUALS alt_valley_fee_mode friendly}
                                [then]
                                    [message]
                                        speaker=Lanya
                                        message= _ "Very well, then."
                                    [/message]
                                    {VARIABLE alt_valley_fee_mode hostile}
                                [/then]
                                [else]
                                    [fire_event]
                                        name=valley attacks
                                    [/fire_event]
                                [/else]
                            [/if]
                        [/command]
                    [/option]
                    [option]
                        message= _ "Unfortunately, we don't have that much gold."
                        [show_if]
                            {VARIABLE_NUM_LESS_THAN player_gold $fee_value}
                        [/show_if]
                        [command]
                            [if]
                                {VARIABLE_LEXICAL_EQUALS alt_valley_fee_mode friendly}
                                [then]
                                    [message]
                                        speaker=Lanya
                                        message= _ "That's unfortunate indeed. Please leave our valley immediately, or we might have to take action."
                                    [/message]
                                    {VARIABLE alt_valley_fee_mode hostile}
                                [/then]
                                [else]
                                    [fire_event]
                                        name=valley attacks
                                    [/fire_event]
                                [/else]
                            [/if]
                        [/command]
                    [/option]
                [/message]
            [/then]
        [/if]
    [/event]

    [event]
        name=valley attacks

        [message]
            speaker=Lanya
            message= _ "We already told you to leave our valley unless you are willing to pay! Get rid of these invaders!"
        [/message]

        [fire_event]
            name=valley hostile
        [/fire_event]
    [/event]

    [event]
        name=valley attacked

        [message]
            speaker=Lanya
            message= _ "I should have known you could not be trusted. Get rid of the invaders, now!"
        [/message]

        [fire_event]
            name=valley hostile
        [/fire_event]
    [/event]

    [event]
        name=valley hostile

        #
        # Regretful decision eh?
        #

        [modify_side]
            side=2
            team_name=valley
            controller=ai
            gold={DIFF 200 250 325}
            income={DIFF 4 6 9}
            valley_gold=2
        [/modify_side]

        {GENERIC_UNIT 2 Bandit 15 25} {NO_UPKEEP} {GUARDIAN}
        {GENERIC_UNIT 2 Bandit 17 24} {NO_UPKEEP} {GUARDIAN}
        {GENERIC_UNIT 2 Highwayman 13 22} {NO_UPKEEP} {GUARDIAN}
        {GENERIC_UNIT 2 Huntsman 13 24} {NO_UPKEEP} {GUARDIAN}
        {GENERIC_UNIT 2 Outlaw 17 21} {NO_UPKEEP} {GUARDIAN}
        {GENERIC_UNIT 2 Assassin 14 23} {NO_UPKEEP} {GUARDIAN}
        {GENERIC_UNIT 2 Assassin 16 22} {NO_UPKEEP} {GUARDIAN}
        {GENERIC_UNIT 2 Assassin 19 28} {NO_UPKEEP} {GUARDIAN}
        {GENERIC_UNIT 2 Assassin 15 27} {NO_UPKEEP} {GUARDIAN}

        {VARIABLE alt_valley_fee_mode enemies}
    [/event]

    [event]
        name=last breath
        [filter]
            id=Lanya
        [/filter]

        [message]
            speaker=Lanya
            message= _ "Curse you, invaders... Think about... what you've done to...our people..."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=4-6,5
            y=28 ,29
        [/filter]

        [if]
            {VARIABLE_LEXICAL_NOT_EQUALS alt_valley_fee_mode enemies}
            [then]
                [terrain]
                    terrain=Uh
                    x=5
                    y=30
                [/terrain]

                [redraw][/redraw]

                [message]
                    speaker=unit
                    message= _ "There is a cave entrance here. I wonder where it leads."
                [/message]

                [message]
                    speaker=Lanya
                    message= _ "That path leads to an old mountain pass that goes high above the ground, where still the height of the surrounding peaks does not allow sunlight to illuminate it most of the time. We believe it leads to the Mountains of the West - but I'd recommend you to avoid that pass. It is said that strange things happen and can be glimpsed at night."
                [/message]
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x=1
            y=43-45
            [and]
                id=Galas
                [or]
                    id=Anlindë
                [/or]
                [or]
                    id=Mal Keshar
                [/or]
            [/and]
        [/filter]

        [redraw][/redraw]

        [allow_undo][/allow_undo]

        [message]
            speaker=Mal Keshar
            message= _ "So what do you choose, Galas? Should we go this way or not?"
        [/message]

        [message]
            speaker=Galas
            message= _ "Uh..."
            [option]
                message= _ "Yes, let's go through the mountain pass."
                [command]
                    {ENDLEVEL_VICTORY yes}
                    {OVERRIDE_NEXT_SCENARIO 05b_Cursed_Plateau}
                [/command]
            [/option]
            [option]
                message= _ "No. Perhaps later, if I change my mind."
                [command]
                    [message]
                        speaker=Mal Keshar
                        message= _ "Very well."
                    [/message]
                [/command]
            [/option]
        [/message]
    [/event]

    #
    # Victory event
    #

    [event]
        name=victory
        #
        # Galas wonders
        #
        [if]
            [variable]
                name=talked_about_elves
                boolean_equals=yes
            [/variable]
            [then]
                [message]
                    speaker=Galas
                    message= _ "We are too far from our home region, yet these sand dwellers talk about our race as if they had met us recently.  After so many eons, shouldn't they have at least forgotten the name of our race?"
                [/message]

                [message]
                    speaker=Anlindë
                    message= _ "I suppose that due to their nomadic nature and better resistance to the heat of the desert, the barbarians we have fought here may have already met our hunters and guards before. Anyway, we should not let small questions such as this delay us any further."
                [/message]
            [/then]
        [/if]
    [/event]
[/scenario]
