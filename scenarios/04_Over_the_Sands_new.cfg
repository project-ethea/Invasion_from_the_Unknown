#textdomain wesnoth-Invasion_from_the_Unknown

[scenario]
    id=04_Over_the_Sands
    name= _ "Over the Sands"
    {MAP 04_Over_the_Sands_new.map}
    {TURNS 73 70 68}
    victory_when_enemies_defeated=no
    next_scenario=05a_Crossfire

    {DAWN1}
    {MORNING1}
    {MIDDAY1}
    {AFTERNOON1}
    {DUSK1}
    {SHORTDARK}
    {DAWN2}
    {MORNING2}
    {MIDDAY2}
    {AFTERNOON2}
    {DUSK2}
    {LONGDARK1}
    {LONGDARK2}
    {LONGDARK3}
    {LONGDARK4}

    [time_area]
        {UNDERGROUND}
        x=114,115,115,116,116,116,117,117,117,117,118,118,118,118,118,119,119,119,119,119,120,120,120,120,120,120
        y=45,44,45,43,44,45,42,43,44,45,41,42,43,44,45,41,42,43,44,45,40,41,42,43,44,45
    [/time_area]

    {EX_SCENARIO_MUSIC_PLAYLIST (
        {EX_MUSIC        "knolls.ogg"}
        {EX_MUSIC_APPEND "wanderer.ogg"}
        {EX_MUSIC_APPEND "nunc_dimittis.ogg"}
        {EX_MUSIC_APPEND "revelation.ogg"}
    )}

    {DEATHS_COMMON}

    {STORYTXT_OVER_THE_SANDS}
    {STORYMAP_OVER_THE_SANDS}

    [side]
        type=Elvish Hero
        id=Galas
        name= _ "Galas"
        unrenamable=yes
        side=1
        canrecruit=yes
        controller=human
        team_name=good
        user_team_name= _ "team_name^Elves"
        shroud,fog=yes,yes
    [/side]

    # Lanya's fort
    [side]
        side=2
        no_leader=yes
        team_name=good
        user_team_name= _ "team_name^Neutral humans"
        hidden=yes
        shroud,fog=yes,yes
        share_maps,share_view=no,no
        [ai]
            {ATTACK_DEPTH 2 3 4}
            aggression=1.0
            caution=0.0
            [avoid]
                x=28-120
                y=1-45
            [/avoid]
        [/ai]
    [/side]


    # Human baddies' fort
    [side]
        side=3
        no_leader=yes
        team_name=human_barbarians
        user_team_name= _ "team_name^Human barbarians"
        hidden=yes
        [ai]
            {ATTACK_DEPTH 3 3 4}
            grouping=no
            aggression=0.9
            caution=0.3
            {AI_TARGET (side=1) 10}
            {AI_TARGET (side=2) 1}
            [avoid]
                x=1-23 ,42-120
                y=19-45,1-45
            [/avoid]
        [/ai]
    [/side]

    # Orcs' fort
    [side]
        side=4
        no_leader=yes
        team_name=orcish_barbarians
        user_team_name= _ "team_name^Orcish barbarians"
        shroud,fog=yes,yes

        id=Karun Baghar
        name= _ "Karun Baghar"
        type=Orcish Warrior
        profile=portraits/orcs/warlord2.png
        canrecruit=yes
        unrenamable=yes

        {GOLD 140 180 220}
        recruit="Orcish Warrior,Wolf Rider,Orcish Archer,Orcish Slayer,Orcish Crossbowman"

        [ai]
            {ATTACK_DEPTH 2 3 4}
            caution=0.2
            recruitment_pattern=scout,fighter,archer,fighter,archer
            [target]
                side=1
                value=10
            [/target]
            # Ignore beasts
            [target]
                side=5
                value=0
            [/target]
            [target]
                side=6
                value=0
            [/target]
            [avoid]
                x=30-45
                y=29-39
            [/avoid]
        [/ai]
    [/side]

    # Roaming ghosts and monsters shouldn't attack each other,
    # thus they share a team.

    [side]
        side=5
        no_leader=yes
        team_name=roaming
        user_team_name= _ "team_name^Roaming ghosts"
        hidden=yes
        [ai]
            aggression=1.0
            caution=0.0
            grouping=no
            {ATTACK_DEPTH 2 3 4}
            {AI_TARGET (side=1) 6}
            {AI_TARGET (side=2) 1}
            {AI_TARGET (side=3) 1}
            {AI_TARGET (side=4) 1}
        [/ai]
    [/side]

    [side]
        side=6
        no_leader=yes
        team_name=roaming
        user_team_name= _ "team_name^Roaming creatures"
        hidden=yes
        [ai]
            aggression=1.0
            caution=0.0
            grouping=no
            {ATTACK_DEPTH 2 3 4}
            {AI_TARGET (side=1) 10}
            {AI_TARGET (side=2) 3}
            {AI_TARGET (side=3) 3}
            {AI_TARGET (side=4) 3}
        [/ai]
    [/side]

#define __PLAYER_ACTIVATION_EVENT _EVENT_ID _SIDE _UNIT_ATTR _SIDE_ATTR
    [event]
        name={_EVENT_ID}
        first_time_only=yes

        [store_starting_location]
            side={_SIDE}
            variable="__leader_{_SIDE}_starting_loc"
        [/store_starting_location]

        [unit]
            {_UNIT_ATTR}
            side={_SIDE}
            x="$__leader_{_SIDE}_starting_loc.x"
            y="$__leader_{_SIDE}_starting_loc.y"
            canrecruit=yes
            unrenamable=yes
        [/unit]

        {CAPTURE_VILLAGES {_SIDE} "$__leader_{_SIDE}_starting_loc.x" "$__leader_{_SIDE}_starting_loc.y" 8}

        {CLEAR_VARIABLE "__leader_{_SIDE}_starting_loc"}

        [modify_side]
            side={_SIDE}
            hidden=no
            {_SIDE_ATTR}
        [/modify_side]
    [/event]
#enddef

    {__PLAYER_ACTIVATION_EVENT "activate neutral humans" 2
        (
            id=Lanya
            name= _ "Lanya"
            type=Fugitive
        )
        (
            {GOLD 15 25 35}
            income=-2
            village_gold=0
        )
    }

    {__PLAYER_ACTIVATION_EVENT "activate barbarians" 3
        (
            id=Gledd
            name= _ "Gledd"
            type=Huntsman
        )
        (
            {GOLD 100 125 150}
            recruit=Footpad,Thief,Thug,Poacher,Trapper,Outlaw,Rogue
        )
    }

#undef __PLAYER_ACTIVATION_EVENT

    {STARTING_VILLAGES 4 7}

    {PLACE_IMAGE (scenery/mine-abandoned.png) 5 29}
    {PLACE_IMAGE (scenery/bonestack.png) 27 19}
    {PLACE_IMAGE (scenery/bonestack.png) 23 9}
    {PLACE_IMAGE (scenery/bonestack.png) 5 5}
    {PLACE_IMAGE (scenery/bonestack.png) 16 4}

    [event]
        name=prestart
        {PLAYER_RECRUITMENT_SETUP_FOR_SCENARIO 4}

        {VARIABLE talked_about_elves no}
        # number of ghosts respawned on first or second dusk
        {VARIABLE roaming_ghosts_count ({DIFF 12 18 24})}
        {VARIABLE roaming_ghosts_throttle 0}
        # number of ghosts to kill before reducing respawn count by one
        {VARIABLE roaming_ghosts_throttle_max ({DIFF 1 2 3})}

        {RANDOM 5..10}
        {SCATTER_IMAGE (terrain=Dd,Ds) ($random)  (items/bones.png)}
        {CLEAR_VARIABLE random}

        #
        # Recall heroes
        #
        [recall]
            id=Anlindë
            x,y=118,41
        [/recall]
        [recall]
            id=Mal Keshar
            x,y=117,43
        [/recall]

        #
        # Capture initial villages for the elves
        #
        [capture_village]
            side=1
            x=116,118,120,120
            y=44 ,45 ,42 ,44
        [/capture_village]

        #
        # A guy or gal to taunt Malin
        #
        {ELVISH_SUPPORTER (supporter)}

        {EX_FOREACH_LOCATION (terrain=*^Zi) loc (
            {CONTINUOUS_SOUND_SOURCE "campfire_$loc.x|_$loc.y" $loc.x $loc.y (ambient/campfire.ogg)}
            {SOUND_SOURCE_RANGE 2 8}
        )}

        # Generate neutral humans

        # Generate human barbarians
        {GENERIC_UNIT 3 (Outlaw) 83 43} {GUARDIAN}
        {GENERIC_UNIT 3 (Footpad) 85 44} {GUARDIAN} {MAKE_FACING_REVERSE}

        # Generate orcish barbarians
        {GENERIC_UNIT 4 (Orcish Grunt) 98 21}  {GUARDIAN}
        {GENERIC_UNIT 4 (Orcish Grunt) 105 21} {GUARDIAN}
        {GENERIC_UNIT 4 (Orcish Grunt) 95 16}  {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 4 (Orcish Grunt) 98 13}  {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 4 (Orcish Grunt) 107 15} {GUARDIAN}
        {GENERIC_UNIT 4 (Orcish Archer) 105 27}
        {GENERIC_UNIT 4 (Orcish Archer) 100 19}
        {GENERIC_UNIT 4 (Orcish Archer) 106 12}
        {GENERIC_UNIT 4 ({DIFF (Orcish Assassin) (Orcish Slayer) (Orcish Slayer)}) 107 23}
        {GENERIC_UNIT 4 (Wolf Rider) 102 24}
        {GENERIC_UNIT 4 (Wolf Rider) 107 24}

        # Generate roaming monsters
        {GENERIC_UNIT 6 (Wolf) 103 38} {DO_NOT_DEHYDRATE}
        {GENERIC_UNIT 6 (Wolf) 105 38} {DO_NOT_DEHYDRATE}
        {GENERIC_UNIT 6 (Wolf) 104 36} {DO_NOT_DEHYDRATE}

        {GENERIC_UNIT 6 (Wolf) 62 22} {DO_NOT_DEHYDRATE} {GUARDIAN}
        {GENERIC_UNIT 6 (Wolf) 62 23} {DO_NOT_DEHYDRATE} {GUARDIAN}
        {GENERIC_UNIT 6 (Wolf) 60 23} {DO_NOT_DEHYDRATE} {GUARDIAN}

        {GENERIC_UNIT 6 (Wolf) 55 37} {DO_NOT_DEHYDRATE} {GUARDIAN}
        {GENERIC_UNIT 6 (Wolf) 58 37} {DO_NOT_DEHYDRATE} {GUARDIAN} {MAKE_FACING_REVERSE}

        {GENERIC_UNIT 6 (Giant Mudcrawler) 31 1} {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Giant Mudcrawler) 34 2} {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Giant Mudcrawler) 28 1} {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Mudcrawler) 27 1} {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Mudcrawler) 20 3} {GUARDIAN}
        {GENERIC_UNIT 6 (Giant Mudcrawler) 12 2} {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Giant Mudcrawler) 3 2} {GUARDIAN}

        {GENERIC_UNIT 6 (Mudcrawler) 61 5} {GUARDIAN}
        {GENERIC_UNIT 6 (Mudcrawler) 61 2} {GUARDIAN}

        {GENERIC_UNIT 6 (Giant Scorpion) 73 17} {GUARDIAN}
        {GENERIC_UNIT 6 (Giant Scorpion) 78 18} {GUARDIAN}
        {GENERIC_UNIT 6 (Giant Scorpion) 56 8 } {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Giant Scorpion) 114 2} {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Giant Scorpion) 118 4} {GUARDIAN} {MAKE_FACING_REVERSE}
        {GENERIC_UNIT 6 (Giant Scorpion) 103 3} {GUARDIAN}

        {SCATTER_UNITS ({DIFF 4 6 9}) ({DIFF "Vampire Bat" "Vampire Bat,Vampire Bat,Blood Bat" "Vampire Bat,Vampire Bat,Blood Bat,Vampire Bat,Blood Bat,Dread Bat"}) (4) (
            x=35-112
            y=1-45
            [not]
                [filter][/filter]
            [/not]
            [not]
                [filter_adjacent_location]
                    [filter][/filter]
                [/filter_adjacent_location]
            [/not]
            [not]
                terrain=*^Xm
            [/not]
        ) (
            side=6
            random_traits=yes
            generate_name=yes
        )}

        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Galas, Anlindë, or Mal Keshar must reach the northwest border of the map.")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Anlindë")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
            {OBJECTIVE_NOTES   ( _ "Dehydration applies to living units.")}
        [/objectives]
    [/event]

    [event]
        name=start
        [message]
            speaker=Mal Keshar
            message= _ "Here you are, the outside. Not too different from the last report of some years ago... or perhaps centuries. I cannot tell which."
        [/message]

        [message]
            speaker=Galas
            message= _ "Everything in the distance is so...dry... There is no plant that could thrive in this heat!"
        [/message]

        [message]
            speaker=Anlindë
            message= _ "That is why our people moved to that valley, to protect themselves from death in the desert. Not all of them found the valley, though. We have always wondered what happened to the other group."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "They could only have died in the desert. The harsh suns and the lack of water and food are peril enough; savage orcs or nomadic human bandits complete the tale."
        [/message]

        [message]
            speaker=Galas
            message= _ "I suppose so. But, where are we? The ancient records will have nothing to say of this desert, which was likely a forest before the Fall."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Indeed it was! If I remember correctly, we are standing on Lintanir Forest, the southwestern part of the Northern Elves' homeland...but probably nothing is left of it, of course. Many eons ago, these dry mountains did not even exist."
        [/message]

        [message]
            speaker=Anlindë
            message= _ "Over time, supporting our people will be more difficult, especially here in the desert. Breeding horses for mounts is already difficult for want of fodder."
        [/message]

        [message]
            role=supporter
            message= _ "So, what now, necromancer? We have never been so far from the green of our valley! We will surely perish on these sands!"
        [/message]

        [message]
           speaker=Mal Keshar
           message= _ "You must fill your water reserves at this oasis before departing towards the Northwest. Make sure your healers are prepared to assist your soldiers. We should be able to find more water sources in these sands. I'll summon my scouts to explore the path ahead."
        [/message]
    [/event]

    {./dehydration}

    {ROAMING_GHOSTS (5)
        (
            x=1-120
            y=1-45
            [not]
                x=1-30
                y=19-45
            [/not]
        )
        ({DIFF 12 18 24})
        ({DIFF 1 2 3})
    }

    #
    # Sighted ghosts
    #

    [event]
        name=found ghost
        first_time_only=yes

        [message]
            speaker=Galas
            message= _ "A ghost?"
        [/message]

        [message]
            speaker=Anlindë
            message= _ "It seems hostile. Mal Keshar, can you do anything about it?"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "No. These ghosts have free will, and roam about these sands due to their painful deaths."
        [/message]
    [/event]

    {FIRE_EVENT_ON_STUMBLE_UPON "found ghost" (side=5)}

    #
    # Sighted orcs
    #

    [event]
        name=found orc

        [fire_event]
            name=activate orcs
        [/fire_event]

        [if]
            [have_unit]
                x,y=$x1,$y1
                [and]
                    race=elf
                    [or]
                        race=fairy
                    [/or]
                [/and]
            [/have_unit]
            [then]
                {VARIABLE talked_about_elves yes}

                [message]
                    speaker=unit
                    message= _ "Oh...elves? I must be hallucinating again..."
                [/message]

                [message]
                    speaker=second_unit
                    message= _ "This doesn't look good..."
                [/message]

                [message]
                    speaker=unit
                    message= _ "But I never had hallucinations that could speak. Intruders! And they are elves! Go get 'em!"
                [/message]

                [message]
                    speaker=Galas
                    message= _ "Anyone who dares oppose us shall perish, whether it be orc or human."
                [/message]

                [message]
                    speaker=Mal Keshar
                    message= _ "Orcs... Good. It has been a long time since I defeated one myself!"
                [/message]

                [message]
                    speaker=Galas
                    message= _ "We could ignore them and continue our journey, but I'm not sure if it would be a good idea."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "Undead! Everyone, to arms! It's an invasion!"
                [/message]

                [message]
                    speaker=Mal Keshar
                    message= _ "Somebody should catch that idiot and cut out his tongue. Now that he has given alarm to his friends, we will have to deal with them!"
                [/message]
            [/else]
        [/if]

        {SCROLL_TO $x1 $y1}
    [/event]

    {FIRE_EVENT_ON_STUMBLE_UPON "found orc" (side=4)}

    #
    # Defeated orcs
    #

    [event]
        name=last breath
        [filter]
            side=4
            canrecruit=yes
        [/filter]

        [message]
            speaker=unit
            message= _ "Argh! I'm vanquished by these puny invaders!"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            side=4
            canrecruit=yes
        [/filter]

        [if]
            [have_unit]
                x,y=$x2,$y2
                [and]
                    race=bats
                    [or]
                        type=Walking Corpse,Soulless,Ghoul_C,Necrophage
                    [/or]
                [/and]
            [/have_unit]
            [then]
                {VARIABLE capable_speaker "Mal Keshar"}
            [/then]
            [else]
                {VARIABLE capable_speaker "second_unit"}
            [/else]
        [/if]

        [message]
            speaker=$capable_speaker
            message= _ "This orc kept some gold in his tent. It is not more than a few dozen, but it is better than nothing."
        [/message]

        {RETRIEVE_GOLD {DIFF 45 40 36}}
    [/event]

    #
    # Sighted mudcrawlers
    #

    [event]
        name=found mudcrawler

        [message]
            speaker=second_unit
            message= _ "Rooaargh!!"
        [/message]

        [if]
            [have_unit]
                x,y=$x1,$y1
                [and]
                    race=elf
                    [or]
                        race=fairy
                    [/or]
                [/and]
            [/have_unit]
            [then]
                {VARIABLE elvish_speaker unit}
            [/then]
            [else]
                {VARIABLE elvish_speaker Galas}
            [/else]
        [/if]

        [message]
            speaker=$elvish_speaker
            message= _ "I have seen and heard about odd things in my life, but that is just ridiculous! A crawling glob of mud?"
        [/message]

        {CLEAR_VARIABLE elvish_speaker}

        [message]
            speaker=Mal Keshar
            message= _ "Crawling, yes. But it is not a simple glob of mud - it has been animated by magic means. Although they are not especially tough, if you get surrounded by a pack of them you will have serious trouble. Especially if you have been under these suns for too long. He, he."
        [/message]

        {SCROLL_TO $x1 $y1}
    [/event]

    {FIRE_EVENT_ON_STUMBLE_UPON "found mudcrawler" (
        type=Mudcrawler
        [or]
            type=Giant Mudcrawler
        [/or]
        [or]
            type=Mother Mudcrawler
        [/or]
    )}

    #
    # Sighted neutral humans
    #

    [event]
        name=moveto
        [filter]
            side=1
            x=1-25
            y=25-45
        [/filter]

        [redraw][/redraw]

        # FIXME: [allow_undo] is not safe if we're clearing shroud
        #        or fog here as well.

        [fire_event]
            name=activate neutral humans
        [/fire_event]
    [/event]

    #
    # Sighted human barbarians
    #

    [event]
        name=sighted
        [filter]
            side=3
            x=79-93
            y=38-45
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [redraw][/redraw]

        [message]
            speaker=unit
            message= _ "This is <i>our</i> oasis. Go away or we'll crush your skulls into the sand!"
        [/message]
    [/event]

    #
    # Elf or faerie stepping on road hexes, or a hex adjacent to one
    #

    [event]
        name=moveto
        [filter]
            side=1
            x=60-120
            y=1-45
            [and]
                race=elf
                [or]
                    race=fairy
                [/or]
            [/and]
            [and]
                [filter_location]
                    terrain=Rr
                [/filter_location]
                [or]
                    [filter_location]
                        [filter_adjacent_location]
                            terrain=Rr
                        [/filter_adjacent_location]
                    [/filter_location]
                [/or]
            [/and]
        [/filter]

        [redraw][/redraw]

        # FIXME: [allow_undo] is not safe if we're clearing shroud
        #        or fog here as well.

        [message]
            speaker=unit
            message= _ "After all this time, the old elven roads still exist under the sands. It is unfortunate that they cannot guide us anywhere in these new times."
        [/message]
    [/event]

    #
    # Elf or faerie stepping on castle hexes, or a hex adjacent to one
    #
    [event]
        name=moveto
        [filter]
            side=1
            x=42-120
            y=1-45
            [and]
                race=elf
                [or]
                    race=fairy
                [/or]
            [/and]
            [and]
                [filter_location]
                    terrain=Chr
                [/filter_location]
                [or]
                    [filter_location]
                        [filter_adjacent_location]
                            terrain=Chr
                        [/filter_adjacent_location]
                    [/filter_location]
                [/or]
            [/and]
        [/filter]

        [redraw][/redraw]

        # FIXME: [allow_undo] is not safe if we're clearing shroud
        #        or fog here as well.

        [message]
            speaker=unit
            message= _ "Ah, the ruins of ancient elven castles. I wish they could still provide us with shelter from the harsh light of Naia and Sela."
        [/message]
    [/event]

    #
    # Victory event
    #

    [event]
        name=victory
        #
        # Galas wonders
        #
        [if]
            [variable]
                name=talked_about_elves
                boolean_equals=yes
            [/variable]
            [then]
                [message]
                    speaker=Galas
                    message= _ "Something disturbs me. These sand dwellers talk about our race as if they had met us recently. After so many eons, shouldn't they have at least forgotten our name?"
                [/message]

                [message]
                    speaker=Anlindë
                    message= _ "I think so, and I wonder too what they meant. But anyway, we should not let small questions such as this delay us any further. We have a mission to complete."
                [/message]
            [/then]
        [/if]
    [/event]


[/scenario]
