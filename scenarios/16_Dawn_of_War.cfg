#textdomain wesnoth-Invasion_from_the_Unknown

[scenario]
    id=16_Dawn_of_War
    name= _ "Dawn of War"
    {MAP 16_Dawn_of_War.map}
    {TURNS 32 29 27}
    next_scenario=17_Voice_of_the_Armageddon
    victory_when_enemies_defeated=no

    {SCENARIO_MUSIC "underground.ogg"} {CONTINUE_PLAYING_STORY_MUSIC_FIRST}

    {LONGDARK1}
    {LONGDARK2}
    {LONGDARK3}
    {LONGDARK4}
    {DAWN1}
    {MORNING1}
    {MIDDAY1}
    {AFTERNOON1}
    {DUSK1}
    {SHORTDARK}
    {DAWN2}
    {MORNING2}
    {MIDDAY2}
    {AFTERNOON2}
    {DUSK2}

    {SHAXTHAL_SET_SURFACE_VARIATIONS_FLAG}

    {STORYTXT_DAWN_OF_THE_GREAT_WAR}

    {DEATHS_ACT_3}

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        team_name=good
        user_team_name= _ "team_name^Galas"

        shroud=yes
        fog=yes

        # NOTE: gold must be 6 * recall_cost at the very minimum in order to
        #       let the player recall units on the first turn.
        {GOLD 180 170 160}

        # wmllint: recognize Galas
        {CHARACTER_STATS_GALAS}
    [/side]
    # wmllint: validate-on

    [side]
        side=2
        team_name=good
        user_team_name= _ "team_name^Alliance"
        {ALLIANCE_FLAG}

        {GOLD 200 190 180}
        recruit=Aragwaith Archer,Aragwaith Witch,Aragwaith Swordsman,Aragwaith Spearman,Aragwaith Scout,Aragwaith Eagle Rider,Aragwaith Wizard,Aragwaith Lancer,Aragwaith Pikeman,Aragwaith Guard,Aragwaith Longswordsman

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 1.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution    0.0}
        [/ai]

        canrecruit=yes
        type=Aragwaith Captain
        id=Ivancyn
        name= _ "Ivancyn"
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_DEXTROUS}
        [/modifications]
    [/side]

    [side]
        side=3
        team_name=good
        user_team_name= _ "team_name^Alliance"
        {ALLIANCE_FLAG}

        {GOLD 200 180 175}
        recruit=Orcish Archer,Orcish Assassin,Saurian Augur,Orcish Grunt,Wolf Rider,Goblin Spearman

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_UTBS_DAY_ASPECT      aggression 0.8}
            {AI_SIMPLE_UTBS_TWILIGHT_ASPECT aggression 0.9}
            {AI_SIMPLE_UTBS_NIGHT_ASPECT    aggression 1.0}

            {AI_SIMPLE_UTBS_DAY_ASPECT      caution    0.2}
            {AI_SIMPLE_UTBS_TWILIGHT_ASPECT caution    0.3}
            {AI_SIMPLE_UTBS_NIGHT_ASPECT    caution    0.5}
        [/ai]

        canrecruit=yes
        type=Orcish Slurbow
        id=Zirshe
        name= _ "Zirshe"
        gender=female
        [modifications]
            {TRAIT_QUICK}
            {TRAIT_RESILIENT}
        [/modifications]
    [/side]

    [side]
        side=4
        team_name=enemies
        user_team_name= _ "team_name^Chaos Empire"
        {CHAOS_FLAG}

        {GOLD 240 260 275}
        {INCOME 0 4 6}
        recruit=Shaxthal Rayblade,Dark Knight,Chaos Invader,Chaos Raider,Chaos Invoker,Automaton

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression    1.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution       0.0}
            {AI_SIMPLE_ALWAYS_ASPECT village_value 0.0}

            {AI_SAVE_GOLD_DEFAULT}

            {AI_RECRUITMENT_ALWAYS_ASPECT (
                {AI_RECRUIT_LIMIT "Shaxthal Rayblade" 4}
                {AI_RECRUIT_LIMIT "Dark Knight"       2}
                {AI_RECRUIT_LIMIT "Automaton"         2}
            )}
        [/ai]

        canrecruit=yes
        type=Chaos Razerman
        id=Obandur
        name= _ "Obandur"
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_INTELLIGENT}
        [/modifications]
    [/side]

    [side]
        side=5
        team_name=enemies
        user_team_name= _ "team_name^Chaos Empire"
        {CHAOS_FLAG}

        {GOLD 190 200 210}
        recruit=Automaton,Chaos Hound,Chaos Headhunter,Chaos Invader,Demon

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression    0.80}
            {AI_SIMPLE_ALWAYS_ASPECT caution       0.15}
            {AI_SIMPLE_ALWAYS_ASPECT village_value 0.25}
        [/ai]

        canrecruit=yes
        type=Gutwrencher Imp
        id=Zulthor
        name= _ "Zulthor"
        [modifications]
            {TRAIT_SLOW}
            {TRAIT_RESILIENT}
        [/modifications]
    [/side]

    [side]
        side=6
        team_name=enemies
        user_team_name= _ "team_name^Chaos Empire"
        {CHAOS_FLAG}

        {GOLD 230 240 250}
        {INCOME 2 3 4}
        recruit=Shaxthal Runner Drone,Shaxthal Protector Drone,Chaos Hound,Chaos Headhunter,Imp,Chaos Invoker

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_UTBS_TOD_ASPECT aggression    0.80 0.90 1.00}
            {AI_SIMPLE_UTBS_TOD_ASPECT caution       0.50 0.25 0.00}
            {AI_SIMPLE_UTBS_TOD_ASPECT village_value 0.10 0.50 0.20}

            {AI_RECRUITMENT_ALWAYS_ASPECT (
                {AI_RECRUIT_LIMIT "Shaxthal Protector Drone" 2}
                {AI_RECRUIT_LIMIT "Shaxthal Runner Drone"    6}
            )}

            [goal]
                [criteria]
                    id=Mal Keshar
                [/criteria]
                value=9.0
            [/goal]
            [goal]
                [criteria]
                    id=Elynia
                [/criteria]
                value=10.0
            [/goal]
        [/ai]

        canrecruit=yes
        type=Chaos Lorekeeper
        id=Karin-Ilyanai
        name= _ "Karin-Ilyanai"
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_INTELLIGENT}
        [/modifications]
    [/side]

    [side]
        side=7
        team_name=enemies
        user_team_name= _ "team_name^Chaos Empire"
        {CHAOS_FLAG}

        {GOLD 280 300 320}
        {INCOME 3 4 5}
        recruit=Shaxthal Runner Drone,Chaos Invoker,Chaos Raider,Chaos Invader,Demon,Demon Grunt,Demon Zephyr

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_UTBS_TOD_ASPECT aggression    0.60 0.75 0.95}
            {AI_SIMPLE_UTBS_TOD_ASPECT caution       0.30 0.20 0.05}
            {AI_SIMPLE_UTBS_TOD_ASPECT village_value 0.10 0.30 0.25}

            {AI_RECRUITMENT_ALWAYS_ASPECT (
                {AI_RECRUIT_LIMIT "Shaxthal Runner Drone" 8}
                {AI_RECRUIT_LIMIT "Demon Zephyr"          6}
                {AI_RECRUIT_LIMIT "Demon Grunt"           6}
            )}

            [goal]
                [criteria]
                    id=Galas
                [/criteria]
                value=10.0
            [/goal]
        [/ai]

        canrecruit=yes
        type=Hell Overlord
        id=Ben
        name= _ "Ben"
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
    [/side]

    [side]
        side=8
        team_name=enemies
        user_team_name= _ "team_name^Wild Animals"

        no_leader=yes
        hidden=yes

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression       100.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution            0.00}
            {AI_SIMPLE_ALWAYS_ASPECT simple_targeting    yes}
            {AI_SIMPLE_ALWAYS_ASPECT grouping             no}
        [/ai]

        {SIDE_GENERIC_UNIT (Shaxthal Razorbird) 18 34}
        {SIDE_GENERIC_UNIT (Shaxthal Razorbird) 28 34}
        {SIDE_GENERIC_UNIT (Shaxthal Razorbird) 12 46}
        {SIDE_GENERIC_UNIT (Shaxthal Razorbird) 21 48}
        {SIDE_GENERIC_UNIT (Shaxthal Razorbird) 35 39}
        {SIDE_GENERIC_UNIT (Shaxthal Razorbird) 25 40}
    [/side]

    [side]
        side=9
        team_name=enemies
        user_team_name= _ "team_name^Wild Animals"
        color=pink

        no_leader=yes
        hidden=yes

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression       100.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution            0.00}
            {AI_SIMPLE_ALWAYS_ASPECT simple_targeting    yes}
            {AI_SIMPLE_ALWAYS_ASPECT grouping             no}
        [/ai]

        {SIDE_GENERIC_UNIT (Falcon) 27 53}
        {SIDE_GENERIC_UNIT (Falcon)  4 47}
        {SIDE_GENERIC_UNIT (Falcon) 13 38}
        {SIDE_GENERIC_UNIT (Falcon) 28 40}
        {SIDE_GENERIC_UNIT (Falcon) 27 42}
        {SIDE_GENERIC_UNIT (Falcon) 46 36}
    [/side]

    [side]
        side=10
        controller=null
        team_name=good
        user_team_name= _ "team_name^Galas"
        color=red

        {NO_ECONOMY}
        no_leader=yes
        hidden=yes
    [/side]

    {STARTING_VILLAGES 2 4}
    {STARTING_VILLAGES 3 4}

    {STARTING_VILLAGES 4 6}
    {STARTING_VILLAGES 5 6}
    {STARTING_VILLAGES 6 4}
    {STARTING_VILLAGES 7 4}

    {NPC_BIRD_BEHAVIOR_WHOLE_MAP 8}

    {NPC_BIRD_BEHAVIOR_WHOLE_MAP 9}

    [event]
        name=prestart

        #
        # Replace the turn limit for the initial section.
        #

        [store_turns]
            variable=dow_real_turn_limit
        [/store_turns]

        [modify_turns]
            side=1
            value=5
        [/modify_turns]

        #
        # Disable AI sides.
        #

        [modify_side]
            [filter_side]
                [not]
                    side=1,10
                [/not]
            [/filter_side]
            controller=null
        [/modify_side]

        #
        # Disallow Galas from straying off path at the start.
        #

        [store_unit]
            [filter]
                id=Galas
            [/filter]
            kill=no
            variable=galas_backup_store
        [/store_unit]

        [object]
            silent=yes
            [filter]
                id=Galas
            [/filter]
            [effect]
                apply_to=movement_costs
                replace=true
                [movement_costs]
                    deep_water={UNREACHABLE}
                    shallow_water={UNREACHABLE}
                    reef={UNREACHABLE}
                    swamp_water={UNREACHABLE}
                    forest={UNREACHABLE}
                    hills={UNREACHABLE}
                    mountains={UNREACHABLE}
                    village={UNREACHABLE}
                    castle={UNREACHABLE}
                    fungus={UNREACHABLE}
                [/movement_costs]
            [/effect]
            [effect]
                apply_to=movement
                set=4
            [/effect]
        [/object]

        [store_starting_location]
            side=9
            variable=goal_loc
        [/store_starting_location]

        {PLACE_IMAGE items/goplate.png $goal_loc.x $goal_loc.y}

        [remove_shroud]
            side=1
            [filter]
                id=Galas
            [/filter]
            radius=6
        [/remove_shroud]

        {PLAYER_RECRUITMENT_SETUP_FOR_SCENARIO 16}

        #
        # Recall heroes
        #

        # wmllint: recognize Elynia
        {RECALL_ELYNIA_AT     20 15}
        # wmllint: recognize Mal Keshar
        {RECALL_MAL_KESHAR_AT 20 17}
        # wmllint: recognize Erathan
        {RECALL_ERATHAN_AT    21 17}
        # wmllint: recognize Igor
        {RECALL_IGOR_AT       26 17}

        [modify_unit]
            [filter]
                id=Elynia,Mal Keshar,Erathan,Igor
            [/filter]
            side=10
        [/modify_unit]

        {FACE_UNIT side=10 id=Galas}

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Rendezvous with your allies")}

            {OBJECTIVE_DEFEAT ( _ "Death of Galas")}

            {TURNS_RUN_OUT}
        )}

        {VARIABLE shadowm_talk 1}
    [/event]

    [event]
        id=shadowm_talk_controller
        name=moveto
        first_time_only=no
        [filter]
            #id=Galas
            side=1
        [/filter]

        [fire_event]
            name=shadowm_talk_$shadowm_talk
        [/fire_event]

        {VARIABLE_INC shadowm_talk}
    [/event]

    # wmllint: unbalanced-on
    # wmlindent: start ignoring
#define DOW_SHADOWM_TALK_EVENT _NUM
    # wmlxgettext: [event]
    [/event]
    [event]
        name="shadowm_talk_{_NUM}"
    # wmlxgettext: [/event]
#enddef
    # wmlindent: stop ignoring
    # wmllint: unbalanced-off

    [event]
        name=start

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "A cold gust of wind blows..."
        [/message]

        {MYSTERIOUS_VOICE ( _ "Galas...")}

        [message]
            speaker=Galas
            message= _ "Huh?"
        [/message]

        #
        # End of start event.
        #

        {DOW_SHADOWM_TALK_EVENT 1}

        {MYSTERIOUS_VOICE ( _ "Galas.")}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Galas
            message= _ "Is anybody there?"
        [/message]

        {MYSTERIOUS_VOICE ( _ "Only the darkness within your heart, Galas.")}

        {DOW_SHADOWM_TALK_EVENT 2}

        {MYSTERIOUS_VOICE ( _ "The darkness, and the fear... They feed me, Galas. I grow stronger with them.")}

        {DOW_SHADOWM_TALK_EVENT 3}

        {MYSTERIOUS_VOICE ( _ "You cannot escape the darkness within your heart, and thus you cannot escape us. And your friend, the sorceress... neither could she.")}

        {MYSTERIOUS_VOICE ( _ "And you will suffer the same fate as she if you refuse our generous offer.")}

        [event]
            remove=yes
            id=shadowm_talk_controller
        [/event]

        {CLEAR_VARIABLE shadowm_talk}
    [/event]

#define DOW_ENEMIES_NOT_DEFEATED
    [have_unit]
        canrecruit=yes
        [filter_side]
            [enemy_of]
                side=1
            [/enemy_of]
        [/filter_side]
    [/have_unit]
#enddef

#define DOW_ENEMIES_DEFEATED
    [not]
        {DOW_ENEMIES_NOT_DEFEATED}
    [/not]
#enddef

#define DOW_NOTE_ONLY_ON_FIRST_TURN
    {OBJECTIVE_NOTE_SHOW_IF ({VARIABLE_NUMERICAL_EQUALS turn_number $initial_turn})}
#enddef

#define DOW_NOTE_ONLY_ON_GAMEPLAY_TURNS
    {OBJECTIVE_NOTE_SHOW_IF ({VARIABLE_NUMERICAL_GREATER_THAN turn_number $initial_turn})}
#enddef

    {FIRE_EVENT_ON_STUMBLE_UPON "begin regular gameplay" side=10}

    [event]
        name=begin regular gameplay

        [remove_terrain_overlays]
            terrain=*^Xo
        [/remove_terrain_overlays]

        [redraw][/redraw]

        [capture_village]
            side=1
            x=1-100
            y=1-11
            [or]
                x,y=$goal_loc.x,$goal_loc.y
                radius=6
            [/or]
        [/capture_village]

        {MOVE_UNIT id=Galas $goal_loc.x $goal_loc.y}
        [+move_unit]
            check_passability=no
        [/move_unit]

        {VARIABLE initial_turn $turn_number}

        [modify_turns]
            value=$dow_real_turn_limit
        [/modify_turns]

        {REMOVE_IMAGE $goal_loc.x $goal_loc.y}

        #
        # Restore heroes.
        #

        [modify_unit]
            [filter]
                side=10
            [/filter]
            side=1
        [/modify_unit]

        [unstore_unit]
            variable=galas_backup_store
            find_vacant=no
            x,y=$goal_loc.x,$goal_loc.y
        [/unstore_unit]

        {CLEAR_VARIABLE galas_backup_store,goal_loc,dow_real_turn_limit}

        #
        # Re-enable AI sides.
        #

        [modify_side]
            [filter_side]
                [not]
                    side=1,10
                [/not]
            [/filter_side]
            controller=ai
        [/modify_side]

        [modify_side]
            side=1
            shroud=no
            fog=no
        [/modify_side]

        [redraw]
            side=1
        [/redraw]

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Sneak past enemy lines and make it to the south edge of the map with Galas, Elynia or Mal Keshar")}
            {OBJECTIVE_BONUS           ( _ "Optional: Defeat all enemy leaders (Bonus)")}
            {OBJECTIVE_SHOW_IF         ({DOW_ENEMIES_NOT_DEFEATED})}
            {OBJECTIVE_BONUS_COMPLETED ( _ "Optional: Defeat all enemy leaders (Bonus)")}
            {OBJECTIVE_SHOW_IF         ({DOW_ENEMIES_DEFEATED})}

            {OBJECTIVE_DEFEAT  ( _ "Death of Galas")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Mal Keshar")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Erathan")}
            {OBJECTIVE_DEFEAT  ( _ "Losing both ally leaders")}

            {TURNS_RUN_OUT}

            {OBJECTIVE_CARRYOVER_NO_BONUS}

            {OBJECTIVE_NOTE ( _ "After this scenario, you will only be able to recruit undead units (except Dark Adepts) and faeries")}
            {OBJECTIVE_NOTE ( _ "Any veteran units that you do not recall during this scenario will be permanently lost")}
            {OBJECTIVE_NOTE ( _ "You may recall or recruit elves only during the first gameplay turn (turn $initial_turn)")}
            {DOW_NOTE_ONLY_ON_FIRST_TURN}
            {OBJECTIVE_NOTE ( _ "You may not recall or recruit elvish units")}
            {DOW_NOTE_ONLY_ON_GAMEPLAY_TURNS}
        )}

        {REPLACE_SCENARIO_MUSIC "battle.ogg"}
        {APPEND_MUSIC           "the_city_falls.ogg"}
        {APPEND_MUSIC           "casualties_of_war.ogg"}
        {APPEND_MUSIC           "loyalists.ogg"}

        [message]
            speaker=Zirshe
            message= _ "A large Chaos battalion has set up camp near the mountains. It is paramount that we block their advance here. Charge!"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "So, what are we going to do? Run across the battlefield with wild abandon?"
        [/message]

        [message]
            speaker=Galas
            message= _ "Well, our priority is to sneak past the enemy lines and make it to the mountain pass. We are not meant to actively participate in this battle, but helping our allies on our way to enemy territory would be highly beneficial to everyone."
        [/message]

        [message]
            speaker=Elynia
            message= _ "Let us see if we can... The followers of Uria seem to have sent more battle-hardened troops this time."
        [/message]

        [message]
            speaker=Galas
            message= _ "No matter. I trust that you two can handle it."
        [/message]

        [event]
            name=side 3 turn end

            [fire_event]
                name=mysterious invitation
            [/fire_event]
        [/event]

        [event]
            name=new turn

            #
            # Remove the ability to recruit or recall elves.
            #

            [modify_side]
                side=1
                recruit="Dark Adept,Faerie Sprite,Skeleton,Skeleton Archer,Skeleton Rider,Ghost,Vampire Bat,Walking Corpse"
            [/modify_side]

            [kill]
                side=1
                race=elf
                x,y=recall,recall
            [/kill]
        [/event]
    [/event]

    [event]
        name=mysterious invitation

        [message]
            speaker=Galas
            message= _ "And so it begins..."
        [/message]

        {MYSTERIOUS_VOICE ( _ "The beginning of your revenge, Galas? It would have been better for you to join us than setting off on this pointless journey that resulted in the sorceress’ death. Your people would have been safe under Uria’s protection.")}

        {MYSTERIOUS_VOICE ( _ "You cannot conceal your bloodlust from me, Galas. But there are better ways to satiate this desire. If you come to me, if you bring the Lady of Light to me... Uria might yet give your people a chance.")}

        [message]
            speaker=Elynia
            message= _ "Galas?"
        [/message]

        {MYSTERIOUS_VOICE ( _ "You know where to find me. I eagerly await your answer, Galas.")}

        [message]
            speaker=Elynia
            message= _ "Galas? Is something the matter? You seem pale."
        [/message]

        [message]
            speaker=Galas
            message= _ "No... (<i>shakes head</i>) no, not really."
        [/message]

        [message]
            speaker=Elynia
            message= _ "Galas, if you feel weak or ill, or need to rest, just remember that I am here to help you."
        [/message]
    [/event]

    [event]
        name=enemies defeated

        [show_objectives][/show_objectives]
    [/event]

    [event]
        name=side 2 turn 7 # turn 5 + 2

        [message]
            speaker=Mal Keshar
            message= _ "This is such a disgrace. Why am I even allowing this elf to command me like a minion when <b>I</b> should be the one ordering his corpse around. Elynia! Help me! You have the power to put an end to my suffering!"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Normally, I would be happy to oblige. But as it turns out, Galas is quite fond of you for reasons I can’t even begin to understand. He would not be pleased if he found out I turned his necromancer friend into a steaming pile of ash."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Pah, you sound so sure of yourself. Hear me, then: some day, this kid will bite the dust, and I will be free to do as I wish. Then we shall duel to the death and show the world that not even the Lady of Light can banish Mal Keshar the Eternal from Irdya. Just you wait."
        [/message]
    [/event]

    [event]
        name=side 2 turn 7 end

        [message]
            speaker=Elynia
            message= _ "Oh, please. It’s not as if Anlindë cast some sort of curse on you that compels you to obey and follow Galas as long as he lives... right?"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "... right."
        [/message]
    [/event]

#define DOW_IS_ENEMY
    [filter_side]
        [enemy_of]
            side=1
        [/enemy_of]
        [not]
            side=8,9
        [/not]
    [/filter_side]
#enddef

#define DOW_FIRE_EVENT_CHANCE _CHANCE _EVENT
    {VARIABLE_RANDOM temp_event_chance 0..100}

    [if]
        {VARIABLE_NUMERICAL_LESS_THAN_OR_EQUAL temp_event_chance {_CHANCE}}
        [then]
            [fire_event]
                name={_EVENT}
                [primary_unit]
                    x,y=$x1,$y1
                [/primary_unit]
                # We don't need the second unit for the use cases below -- which, in fact,
                # don't have a second unit at all.
                #[secondary_unit]
                #    x,y=$x2,$y2
                #[/secondary_unit]
            [/fire_event]
        [/then]
    [/if]

    {CLEAR_VARIABLE temp_event_chance}
#enddef

#define DOW_FIRE_EVENT_CHANCE_SLF _CHANCE _EVENT _SLF
    [if]
        [have_unit]
            x,y=$x1,$y1
            [filter_location]
                {_SLF}
            [/filter_location]
        [/have_unit]
        [then]
            {DOW_FIRE_EVENT_CHANCE {_CHANCE} {_EVENT}}
        [/then]
    [/if]
#enddef

    #
    # Village pillaging logic.
    #

    [event]
        name=capture
        first_time_only=no
        [filter]
            {DOW_IS_ENEMY}
        [/filter]

        {DOW_FIRE_EVENT_CHANCE 20 ("pillage village")}
    [/event]

    [event]
        name=pillage village
        #first_time_only=yes

        [message]
            side=$unit.side
            canrecruit=yes
            scroll=no
            message= _ "Leave nothing standing! Burn the heathens alive!"
        [/message]

        [message]
            race=aragwaith
            scroll=no
            message= _ "They are burning the villages of our people! This atrocity will not go unpunished. Don’t bother taking prisoners, just crush them all!"
        [/message]
    [/event]

#define DOW_BURN_SOUNDS _DELAY
    [sound]
        name="torch.ogg"
    [/sound]

    [delay]
        time={_DELAY}
    [/delay]

    [sound]
        name="wose-die.ogg"
    [/sound]
#enddef

    [event]
        name=pillage village
        first_time_only=no

        {DOW_BURN_SOUNDS 200}

        [terrain]
            x,y=$x1,$y1
            terrain=^Dr
            layer=overlay
        [/terrain]

        {ADD_GOLD $unit.side 16 32 48}

        [redraw][/redraw]
    [/event]

    #
    # Terrain destruction logic.
    #

#define DOW_GRASSLAND_DAMAGE_CASE _CASE _REPLACEMENT
    [if]
        {VARIABLE_LEXICAL_CONTAINS locs[$k].terrain {_CASE}^}
        [then]
            [terrain]
                x,y=$locs[$k].x,$locs[$k].y
                terrain={_REPLACEMENT}
                layer=base
            [/terrain]
        [/then]
    [/if]
#enddef

    [event]
        name=damage grassland
        first_time_only=no

        [remove_terrain_overlays]
            x,y=$x1,$y1
            radius=1
            terrain=*^Gvs,*^Efm
        [/remove_terrain_overlays]

        [store_locations]
            x,y=$x1,$y1
            radius=1
            terrain=G*^*
            variable=locs
        [/store_locations]

        {FOREACH locs k}
            {DOW_GRASSLAND_DAMAGE_CASE Gg  Gs} # Green -> semi-dry
            {DOW_GRASSLAND_DAMAGE_CASE Gs  Gd} # Semi-dry -> dry
            {DOW_GRASSLAND_DAMAGE_CASE Gll Gd} # Leafy -> dry
            {DOW_GRASSLAND_DAMAGE_CASE Gd  Re} # Dry -> regular dirt
        {NEXT k}

        {CLEAR_VARIABLE locs}
    [/event]

    [event]
        name=destroy windmill
        first_time_only=no

        {DOW_BURN_SOUNDS 200}

        [terrain]
            x,y=$x1,$y1
            terrain=^Dr
            layer=overlay
        [/terrain]
    [/event]

    [event]
        name=destroy roads
        first_time_only=no

        [terrain]
            x,y=$x1,$y1
            radius=1
            [and]
                terrain=Rd,Rp,Rd^*,Rp^*
            [/and]
            terrain=Rd
            layer=base
        [/terrain]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            {DOW_IS_ENEMY}
        [/filter]

        {DOW_FIRE_EVENT_CHANCE_SLF 60 ("damage grassland") terrain=G*^*,*^Gvs,*^Efm,!,*^F*}

        {DOW_FIRE_EVENT_CHANCE_SLF 75 ("destroy windmill") terrain=*^Wm}

        {DOW_FIRE_EVENT_CHANCE_SLF 33 ("destroy roads")    terrain=Rd,Rp,Rd^*,Rp^*}

        [redraw][/redraw]
    [/event]

    #
    # Enemies burn forests (100% chance).
    #

    [event]
        name=moveto
        first_time_only=no
        [filter]
            {DOW_IS_ENEMY}

            [filter_location]
                terrain=*^F*
            [/filter_location]
        [/filter]

        [terrain]
            x,y=$x1,$y1
            radius=1
            [and]
                terrain=*^F*
            [/and]
            terrain=Rb
        [/terrain]

        [redraw][/redraw]

        [fire_event]
            name=discuss burning forests
            [primary_unit]
                x,y=$x1,$y1
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=discuss burning forests

        [message]
            #
            # Try to have this line be read by a faerie other than Elynia.
            #
            race=faerie
            [not]
                id=Elynia
            [/not]
            [or]
                id=Elynia
            [/or]
            scroll=no
            message= _ "Those monsters are burning down the forest! Why would people do this in a world where all verdant land is more precious than gold?"
        [/message]

        [message]
            speaker=Galas
            scroll=no
            message= _ "We shall make them pay dearly for this."
        [/message]
    [/event]

    #
    # Moving south of the river.
    #

    [event]
        name=moveto
        [filter]
            id=Galas,Elynia,Mal Keshar
            x=1-100
            y=40-53
        [/filter]

        [allow_undo][/allow_undo]

        [message]
            speaker=unit
            message= _ "We are almost there..."
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Galas,Elynia,Mal Keshar
            x=1-100
            y=54
        [/filter]
        [filter_condition]
            {DOW_ENEMIES_NOT_DEFEATED}
        [/filter_condition]

        [message]
            speaker=Elynia
            message= _ "Galas, are you sure we should proceed south before finishing the battle here?"
        [/message]

        [message]
            speaker=Galas
            message= _ "Hm..."
            [option]
                message= _ "You are right, it would not be good form for us to leave our allies to fight on their own."
                [command]
                    [message]
                        speaker=Galas
                        message= _ "We shall stay for a little longer."
                    [/message]
                [/command]
            [/option]
            [option]
                message= _ "Time is of the essence. We shall proceed south as swiftly as we may."
                [command]
                    [message]
                        speaker=Elynia
                        message= _ "Very well, then."
                    [/message]

                    {ENDLEVEL_VICTORY no}
                [/command]
            [/option]
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Galas,Elynia,Mal Keshar
            x=1-100
            y=54
        [/filter]
        [filter_condition]
            {DOW_ENEMIES_DEFEATED}
        [/filter_condition]

        {ENDLEVEL_VICTORY yes}
    [/event]

    #
    # Ally leaders death.
    #
    [event]
        name=die
        [filter]
            canrecruit=yes
            [filter_side]
                [allied_with]
                    side=1
                [/allied_with]
            [/filter_side]
        [/filter]
        [filter_condition]
            [not]
                [have_unit]
                    canrecruit=yes
                    [filter_side]
                        [allied_with]
                            side=1
                        [/allied_with]
                    [/filter_side]
                    [not]
                        x,y=$x1,$y1
                    [/not]
                [/have_unit]
            [/not]
        [/filter_condition]

        [message]
            speaker=Galas
            message= _ "The alliance forces are being decimated! We must fall back and call for reinforcements now, otherwise the legions of Uria will surely lay waste to the Aragwaith country!"
        [/message]

        {ENDLEVEL_DEFEAT}
    [/event]

    #
    # Shaxthal-related events.
    #

    [event]
        name=recruit
        [filter]
            race=shaxthal
        [/filter]

        #
        # Defer talk event until the AI side's turn ends so that there are
        # hopefully a few more Shaxthal units in sight.
        #
        [event]
            name=side turn end
            delayed_variable_substitution=no

            [fire_event]
                name=shaxthal sighted
                [primary_unit]
                    x,y=$x1,$y1
                [/primary_unit]
            [/fire_event]
        [/event]
    [/event]

    [event]
        name=shaxthal sighted

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Zirshe
            message= _ "Look out! They brought numbers of some sort of metallic war-beast with them!"
        [/message]

        [message]
            speaker=Elynia
            message= _ "What in the world are those things? Wait, could it be those creatures Lord Torancyn mentioned?"
        [/message]

        [message]
            speaker=Erathan
            message= _ "Indeed. ‘Shaxthals’, as the enemy calls them. The name supposedly means ‘Invincibles’ in some dead language. Rumor has it that all settlements upon which they are unleashed fall in a matter of hours, leaving no survivors; thus their existence remains one of the best guarded secrets of the Chaos Empire."
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]
    [/event]

    [event]
        name=attacker hits
        [filter]
            race=shaxthal
        [/filter]
        [filter_attack]
            name=energy shock
        [/filter_attack]

        [fire_event]
            name=shaxthal ranged attack
            [primary_unit]
                x,y=$x1,$y1
            [/primary_unit]
            [secondary_unit]
                x,y=$x2,$y2
            [/secondary_unit]
        [/fire_event]
    [/event]

    [event]
        name=defender hits
        [filter_second]
            race=shaxthal
        [/filter_second]
        [filter_second_attack]
            name=energy shock
        [/filter_second_attack]

        [fire_event]
            name=shaxthal ranged attack
            [primary_unit]
                x,y=$x2,$y2
            [/primary_unit]
            [secondary_unit]
                x,y=$x1,$y1
            [/secondary_unit]
        [/fire_event]
    [/event]

    [event]
        name=shaxthal ranged attack

        [message]
            # May match low level undead, this is intentional.
            speaker=second_unit
            message= _ "Aiyeee!!!" # wmllint: no spellcheck
        [/message]

        [message]
            speaker=Galas
            scroll=no
            message= _ "What was that? I have never seen anything like it before!"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            type=Skeleton Archer,Bone Shooter,Banebow,Skeleton,Deathblade,Revenant,Draug,Death Baron,Death Knight,Skeleton Rider,Bone Knight
        [/filter]
        [filter_second]
            race=shaxthal
        [/filter_second]

        [message]
            speaker=Mal Keshar
            scroll=no
            message= _ "Ugh. Galas, what the hell? You ought to know better than this! Do you have any idea how much it costs me to summon these skeleton warriors?!"
        [/message]

        [message]
            speaker=Galas
            scroll=no
            message= _ "You are right, that wasn’t my brightest move. Sorry."
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            race=shaxthal
        [/filter]

        [if]
            [have_unit]
                x,y=$x2,$y2
                race=bats,undead
                [not]
                    type=Lich
                [/not]
            [/have_unit]
            [then]
                [fire_event]
                    name=shaxthal fell
                    [primary_unit]
                        id=Mal Keshar
                    [/primary_unit]
                [/fire_event]
            [/then]
            [else]
                [fire_event]
                    name=shaxthal fell
                    [primary_unit]
                        x,y=$x2,$y2
                    [/primary_unit]
                [/fire_event]
            [/else]
        [/if]
    [/event]

    [event]
        name=shaxthal fell

        [if]
            {VARIABLE_LEXICAL_EQUALS unit.gender female}
            [then]
                [message]
                    speaker=unit
                    message= _ "female^Well, so much for the ‘invincible’ part. But what is this? I have managed to remove one of its armor plates and there is living flesh inside, although it smells much like a rotting corpse... So it is a living creature after all! But it seems completely unlike anything I have ever seen. What kind of foul sorcery is this?"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "Well, so much for the ‘invincible’ part. But what is this? I have managed to remove one of its armor plates and there is living flesh inside, although it smells much like a rotting corpse... So it is a living creature after all! But it seems completely unlike anything I have ever seen. What kind of foul sorcery is this?"
                [/message]
            [/else]
        [/if]

        [message]
            id=Erathan
            [not]
                x,y=$x1,$y1
            [/not]
            [or]
                id=Ivancyn
            [/or]
            message= _ "I haven’t the slightest idea. Nobody from our country has ever seen one of these abominations in the flesh. It’s very likely that they specifically created them to serve as the Empire’s living weapons. I shudder to think there might be thousands of them en route to our lands..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "I simply cannot begin to fathom the sort of twisted mind that would create a new form of life for the express purpose of slaughtering whole civilizations. These are slaves!"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Hm. Their flesh begins to disintegrate once you breach their metallic exteriors. And it seems they don’t even have a skeleton inside, much like insects. Pah! What a waste of time. I can’t work with this!"
        [/message]

        [message]
            speaker=Elynia
            message= _ "I would not let you anyway."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Oh, Elynia, you truly are the life of the party."
        [/message]
    [/event]

    #
    # Enemy leader deaths.
    #

    [event]
        name=last breath
        [filter]
            id=Ben
        [/filter]

        [message]
            speaker=Ben
            message= _ "Your boldness has sealed your doom, elf. Even if you manage to survive the trials that await you at the Pass of Ilgrid, the Master and the Warlord will ensure you pay dearly for your insolence, yes..."
        [/message]

        [message]
            speaker=Galas
            # po: Again, the warlord's gender has not revealed to Galas & co.
            # po: yet, at this point in the story.
            message= _ "The Warlord is... alive? Where is he?!"
        [/message]

        [message]
            speaker=Ben
            message= _ "Heh, heh, I am not telling you heathens anything... May Uria bless the souls of the fallen!"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            id=Ben
        [/filter]

        [message]
            speaker=Galas
            message= _ "So he committed suicide. The coward."
        [/message]

        [message]
            speaker=Elynia
            message= _ "I suppose it comes with the territory of worshiping demon goddesses that instigate death and destruction on a world scale. The things I have heard from the northerners’ spies are truly horrifying."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Such as?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Binding the souls of fallen powerful demons to the bodies of other creatures like humans, orcs, even beasts; pulling the spirits of deceased warriors of past ages back into this world; torturing and experimenting on large numbers of all manner of living creatures and feeding upon their energy... Galas?"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Perhaps he would prefer to not be reminded of his comrades’ fate back at your eponymous valley, don’t you think?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Yes... that was highly improper of me. I am sorry, Galas."
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Zulthor
        [/filter]

        [message]
            speaker=Zulthor
            message= _ "Argh, such a shameful death! I beg your mercy, Uria..."
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Karin-Ilyanai
        [/filter]

        [message]
            speaker=Karin-Ilyanai
            # po: The Voice of Uria is the Chaos Emperor, and the Fire is the Warlord
            message= _ "Oooooh, striking me down hardly makes a difference in the grand scheme of things. May the Voice and the Fire of Uria have mercy on your pitiful souls..."
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Obandur
        [/filter]

        [message]
            speaker=Obandur
            message= _ "Yechnagoth shall feast on your souls some day, you unworthy fools... some day... some... day..."
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            id=Obandur
        [/filter]

        [message]
            speaker=Mal Keshar
            message= _ "How about we make sure to cut their windpipes open from now on so they cannot give these irritating cookie-cutter dying speeches?"
        [/message]
    [/event]

    [event]
        name=victory

        #
        # Set the new recruit list for the next scenarios.
        #
        [modify_side]
            side=1
            recruit="Faerie Sprite,Skeleton,Skeleton Archer,Skeleton Rider,Ghost,Vampire Bat,Walking Corpse"
        [/modify_side]

        #
        # Clear the whole recall list.
        #
        [kill]
            side=1
            x,y=recall,recall
        [/kill]

        [role]
            role=talking_elf
            race=elf
            [not]
                id=Galas
            [/not]
            side=1
        [/role]

        [if]
            [have_unit]
                role=talking_elf
            [/have_unit]
            [then]
                [message]
                    role=talking_elf
                    message= _ "Galas, sir, we can’t just say farewell and let you go on alone. Even though you have stepped down, we have followed and served you for so long that it doesn’t feel right to part ways here."
                [/message]

                [message]
                    speaker=Galas
                    message= _ "Well..."
                [/message]

                [message]
                    speaker=Elynia
                    message={ASIDE ( _ "Galas, this is supposed to be an </i>infiltration<i> mission. It would be unwise to let your men come with us. We can’t even guarantee our own survival!")}
                [/message]

                [message]
                    speaker=Galas
                    message= _ "... I..."
                [/message]

                [message]
                    role=talking_elf
                    message= _ "My lord, we understand well the risks involved in this mission. This is not a choice we made lightly. But you will need all the help you can get to reach the Empire’s capital alive. Please! Let us accompany you one last time."
                [/message]

                [delay]
                    time=750
                [/delay]

                [message]
                    speaker=Galas
                    message= _ "(<i>chuckles</i>) I doubt I will ever convince you otherwise. Very well, you may come with us if you wish. But understand that the odds are not in our favor; it’s likely you will never see your loved ones again."
                [/message]

                [message]
                    role=talking_elf
                    message= _ "We know, sir, and they do as well. But hasn’t it always been this way since Uria’s followers first set foot in our valley?"
                [/message]

                [message]
                    speaker=Galas
                    message= _ "Perhaps—"
                [/message]
            [/then]
        [/if]

        {MYSTERIOUS_VOICE ( _ "You are bold for coming to my domain, Galas. But, how long will it be before you succumb to the temptation of the power of Uria?")}

        [message]
            speaker=Galas
            message= _ "Only time can tell... what fate has in store for us..."
        [/message]

        {CLEAR_VARIABLE initial_turn,shadowm_talk}
    [/event]
[/scenario]

#undef DOW_SHADOWM_TALK_EVENT
#undef DOW_ENEMIES_NOT_DEFEATED
#undef DOW_ENEMIES_DEFEATED
#undef DOW_NOTE_ONLY_ON_FIRST_TURN
#undef DOW_NOTE_ONLY_ON_GAMEPLAY_TURNS
#undef DOW_IS_ENEMY
#undef DOW_FIRE_EVENT_CHANCE
#undef DOW_FIRE_EVENT_CHANCE_SLF
#undef DOW_BURN_SOUNDS
#undef DOW_GRASSLAND_DAMAGE_CASE

# kate: indent-mode normal; encoding utf-8; space-indent on;
