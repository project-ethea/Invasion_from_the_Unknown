#textdomain wesnoth-Invasion_from_the_Unknown
[scenario]
    id=22A_Innuendo
    name= _ "Innuendo"
    {MAP 22A_Innuendo.map}
    turns=-1
    next_scenario=22B_Gauntlet
    victory_when_enemies_defeated=no

    {EX_SCENARIO_MUSIC_PLAYLIST (
        {EX_MUSIC        "knalgan_theme.ogg"}
        {EX_MUSIC_APPEND "nunc_dimittis.ogg"}
        {EX_MUSIC_APPEND "the_king_is_dead.ogg"}
    )}

    {INDOORS_HIVE}

    {DEATHS_END}
    {GLAMOUR_INIT_STUB}

    {STORYTXT_INNUENDO}
    {STORYMAP_INNUENDO}

    [side]
        type=Elvish Hero
        description=Galas
        user_description= _ "Galas"
        unrenamable=yes
        side=1
        canrecruit=yes
        controller=human
        team_name=good
        user_team_name= _ "team_name^Galas"
        shroud=yes
        income=-2
        village_gold=0
        {SHROUD_DATA 22A_Innuendo.shroud}
    [/side]

    # Boss supporters
    [side]
        side=2
        controller=ai
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        {HAS_KAMIKAZE_BEHAVIOR}
    [/side]

    # Boss
    [side]
        side=3
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        {HAS_BOSS_BEHAVIOR}
    [/side]

    # Assault Drones
    [side]
        side=4
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Assault Drone) 33 22}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Assault Drone) 35 39}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Assault Drone) 30 35}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Assault Drone) 31 29}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Runner Drone) 2 26}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Runner Drone) 21 25}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Assault Drone) 14 16}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Assault Drone) 16 19}
        {MAKE_FACING_REVERSE}

        {GENERIC_UNIT_AUTOSIDE (Shaxthal Assault Drone) 55 39}
        {MAKE_FACING_REVERSE}
#ifndef EASY
        {GENERIC_UNIT_AUTOSIDE (Shaxthal Assault Drone) 52 40}
        {MAKE_FACING_REVERSE}
#endif
#ifndef EASY
        {GENERIC_UNIT_AUTOSIDE (Shaxthal Protector Drone) 47 35}
        {MAKE_FACING_REVERSE}
#endif
        {GENERIC_UNIT_AUTOSIDE (Shaxthal Protector Drone) 44 36}
        {MAKE_FACING_REVERSE}

        {HAS_KAMIKAZE_BEHAVIOR}
    [/side]

    # Dwelling Drones
    [side]
        side=5
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 30 33}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 27 35}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 25 28}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 21 30}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Protector Drone) 36 21}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Runner Drone) 34 24}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Runner Drone) 40 23}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Protector Drone) 19 34}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 28 22}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 3 36}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Runner Drone) 4 15}

        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 24 22}
        {MAKE_FACING_REVERSE}
#ifdef HARD
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 22 23}
        {MAKE_FACING_REVERSE}
#endif
        {HAS_KAMIKAZE_BEHAVIOR}
    [/side]

    # Guardians
    [side]
        side=6
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        {GENERIC_GUARDIAN_AUTOSIDE (Worker Droid) 23 33}
        {GENERIC_GUARDIAN_AUTOSIDE (Worker Droid) 15 38}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Gutwrencher Imp) 5 31}
        {GENERIC_GUARDIAN_AUTOSIDE (Psy Crawler) 5 32}
        {GENERIC_GUARDIAN_AUTOSIDE (Psy Crawler) 6 31}
        {GENERIC_GUARDIAN_AUTOSIDE (Psy Crawler) 6 32}
        {GENERIC_GUARDIAN_AUTOSIDE (Psy Mindraider) 13 38}
        {GENERIC_GUARDIAN_AUTOSIDE (Blood Imp) 15 33}
        {GENERIC_GUARDIAN_AUTOSIDE (Imp) 11 37}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Blood Imp) 4 38}
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Soulhunter) 10 36}
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Headhunter) 12 24}
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Headhunter) 17 27}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Magus) 13 14}
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Invoker) 11 9}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Marauder) 26 15}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Minor Imp) 7 37}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Minor Imp) 12 34}
        {GENERIC_GUARDIAN_AUTOSIDE (Minor Imp) 13 31}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Minor Imp) 18 32}
        {GENERIC_GUARDIAN_AUTOSIDE (Iron Golem) 5 24}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Worker Droid) 8 25}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Worker Droid) 10 26}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Goliath) 10 33}
        {GENERIC_GUARDIAN_AUTOSIDE (Goliath) 21 19}
        {MAKE_FACING_REVERSE}
#ifndef EASY
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Lore) 25 31}
        {GENERIC_GUARDIAN_AUTOSIDE (Goliath) 7 28}
        {GENERIC_UNIT_AUTOSIDE (Hellhound) 49 38}
        {MAKE_FACING_REVERSE}
#endif
        {GENERIC_GUARDIAN_AUTOSIDE (Automaton) 9 26}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Demon Zephyr) 5 22}
        {GENERIC_GUARDIAN_AUTOSIDE (Demon) 1 17}

        {GENERIC_GUARDIAN_AUTOSIDE (Shadow Spawn) 24 11}
        {GENERIC_GUARDIAN_AUTOSIDE (Shadow Spawn) 9 10}

        {GENERIC_GUARDIAN_AUTOSIDE (Shadow Spawn) 30 3}
        {GENERIC_GUARDIAN_AUTOSIDE (Shadow Spawn) 30 1}
        {GENERIC_GUARDIAN_AUTOSIDE (Shadow Spawn) 32 3}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shadow Spawn) 32 1}
        {MAKE_FACING_REVERSE}

        {HAS_KAMIKAZE_BEHAVIOR}
    [/side]

    # Doors (fake player)
    [side]
        side=7
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {IS_NPC}
        {CHAOS_FLAG}

        {HAS_KAMIKAZE_BEHAVIOR}
    [/side]

    # Matrices
    [side]
        side=8
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {HAS_KAMIKAZE_BEHAVIOR}

        {CHAOS_FLAG}

        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 17 23}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 12 20}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 22 16}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 26 12}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 27 8}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 11 14}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 10 12}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 14 19}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 30 22}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 35 22}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 39 26}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 32 25}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 3 14}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 2 14}

        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 37 40}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 32 38}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 30 38}
    [/side]

    # NOTE: Reserved item/unit positions (the random location touchgem uses this table):
    # 7,18
    # 13,10
    # 19,10
    # 19,16
    # 21,13
    # 26,10

    {PLACE_IMAGE ("items/barrel.png") 11 18}
    {PLACE_IMAGE ("items/barrel.png") 19 22}
    {PLACE_IMAGE ("items/barrel.png") 15 27}

    {PLACE_IMAGE ("scenery/enchantress-statue-w.png") 45 3}
    {PLACE_IMAGE ("scenery/enchantress-statue-w.png") 44 6}

    {PLACE_IMAGE ("scenery/bookshelf-full.png~FL(horiz)") 17 31}
    {PLACE_IMAGE ("scenery/bookshelf.png") 3 34}
    {PLACE_IMAGE ("scenery/dinnertable.png") 16 37}
    {PLACE_IMAGE ("scenery/chair-s.png") 16 36}
    {PLACE_IMAGE ("scenery/chair-n.png") 16 38}
    {PLACE_IMAGE ("scenery/chair-se.png") 15 37 }
    {PLACE_IMAGE ("scenery/chair-sw.png") 17 37 }
    {PLACE_IMAGE ("scenery/chair-nw.png") 17 38 }
    {PLACE_IMAGE ("items/altar-bloody.png") 11 34}
    {PLACE_IMAGE ("scenery/monolith4.png") 5 35}
    {PLACE_IMAGE ("scenery/monolith1.png") 8 37}
    {PLACE_IMAGE ("scenery/monolith2.png") 10 32}
    {PLACE_IMAGE ("scenery/monolith3.png") 13 36}
    {PLACE_IMAGE ("scenery/rock-cairn.png") 12 40}
    {PLACE_IMAGE ("scenery/hero-statue-w.png") 22 37}
    {PLACE_IMAGE ("items/bones.png~FL(horiz)") 19 36}
    {PLACE_IMAGE ("items/bones.png") 15 30}
    {PLACE_IMAGE ("items/ornate2.png") 6 38}
    {PLACE_IMAGE ("scenery/gibs1.png") 25 38}
    {PLACE_IMAGE ("scenery/gibs1.png") 21 24}
    {PLACE_IMAGE ("items/bones.png~FL(horiz)") 13 21}
    {PLACE_IMAGE ("items/bones.png") 3 16}
    {PLACE_IMAGE ("items/brazier-lit1.png") 29 14}
    {PLACE_IMAGE ("items/brazier-lit1.png") 36 18}
    {PLACE_IMAGE ("items/brazier-lit1.png") 34 8}
    {PLACE_IMAGE ("items/brazier-lit1.png") 16 24}
    {PLACE_IMAGE ("items/brazier-lit1.png") 2 39}
    #{PLACE_IMAGE ("items/brazier-lit1.png") 39 36}
    #{PLACE_IMAGE ("items/brazier.png") 36 34}
    {PLACE_IMAGE ("items/brazier.png") 35 33}
    {PLACE_IMAGE ("items/brazier-lit1.png") 40 30}
    {PLACE_IMAGE ("items/brazier-lit1.png") 36 29}
    {PLACE_IMAGE ("items/brazier.png") 31 20}
    {PLACE_IMAGE ("items/brazier.png") 20 26}
    {PLACE_IMAGE ("items/brazier-lit1.png") 13 27}
    {PLACE_IMAGE ("items/brazier.png") 10 24}
    {PLACE_IMAGE ("items/brazier.png") 2 25}
    {PLACE_IMAGE ("items/brazier-lit1.png") 3 21}
    {PLACE_IMAGE ("items/brazier-lit1.png") 10 40}
    {PLACE_IMAGE ("items/brazier.png") 19 40}
    {PLACE_IMAGE ("items/brazier-lit1.png") 19 32}
    {PLACE_IMAGE ("items/brazier-lit1.png") 14 29}
    {PLACE_IMAGE ("items/brazier.png") 11 30}
    {PLACE_IMAGE ("items/brazier.png") 5 30}
    {PLACE_IMAGE ("items/brazier-lit1.png") 29 29}
    {PLACE_IMAGE ("items/brazier.png") 26 30}
    {PLACE_IMAGE ("items/brazier-lit1.png") 22 32}
    {PLACE_IMAGE ("items/brazier-lit1.png") 22 34}
    {PLACE_IMAGE ("items/brazier.png") 26 32}
    {PLACE_IMAGE ("items/brazier.png") 30 30}
    {PLACE_IMAGE ("items/brazier-lit1.png") 21 35}
    {PLACE_IMAGE ("items/brazier-lit1.png") 27 24}
    {PLACE_IMAGE ("items/brazier-lit1.png") 33 21}
    {PLACE_IMAGE ("items/brazier-lit1.png") 29 26}
    {PLACE_IMAGE ("items/brazier.png") 2 28}
    {PLACE_IMAGE ("items/brazier-lit1.png") 7 27}
    {PLACE_IMAGE ("items/brazier-lit1.png") 2 35}
    {PLACE_IMAGE ("items/brazier-lit1.png") 10 34}
    {PLACE_IMAGE ("items/brazier-lit1.png") 1 15}
    {PLACE_IMAGE ("items/brazier-lit1.png") 23 18}
    {PLACE_IMAGE ("items/brazier.png") 25 15}
    {PLACE_IMAGE ("items/brazier-lit1.png") 32 18}
    {PLACE_IMAGE ("items/brazier-lit1.png") 39 16}
    {PLACE_IMAGE ("items/brazier-lit1.png") 36 11}
    {PLACE_IMAGE ("items/brazier-lit1.png") 29 7}

    {PLACE_IMAGE ("items/coffin-closed.png") 6 21}
    {PLACE_IMAGE ("items/coffin-closed.png") 5 10}
    {PLACE_IMAGE ("items/box.png") 16 10}
    {PLACE_IMAGE ("items/altar-evil.png") 9 15}
    {PLACE_IMAGE ("items/altar-bloody.png") 27 14}
    {PLACE_IMAGE ("scenery/trash.png") 19 13}
    {PLACE_IMAGE ("items/coffin-closed.png") 23 11}

    {PLACE_IMAGE ("items/brazier-lit1.png") 43 32}
    {PLACE_IMAGE ("items/brazier-lit1.png") 38 34}
    {PLACE_IMAGE ("items/brazier.png") 46 33}
    {PLACE_IMAGE ("items/brazier-lit1.png") 41 36}
    {PLACE_IMAGE ("items/brazier.png") 49 35}
    {PLACE_IMAGE ("items/brazier.png") 44 37}
    {PLACE_IMAGE ("items/brazier-lit1.png") 52 36}
    {PLACE_IMAGE ("items/brazier-lit1.png") 47 39}
    {PLACE_IMAGE ("items/brazier.png") 55 38}
    {PLACE_IMAGE ("items/brazier-lit1.png") 50 40}

    {SETUP_SHAXTHAL_ROAMING_SOUND_EFFECTS}

    {FINAL_SCENARIO_PLAYER_RECRUITMENT}

    [event]
        name=turn 2
        [terrain]
            x=35,39,36,39
            y=30,30,32,32
            terrain=Re
        [/terrain]
    [/event]

    [event]
        name=prestart
        # wmllint: recognize Igor
        # wmllint: recognize Erathan
        # wmllint: recognize Elynia
        # wmllint: recognize Mal Keshar
        # wmllint: recognize Lédinor
        # wmllint: recognize Rurhló
        # wmllint: recognize Garg
        # Scatter gibs all over the place
        {EX_SCATTER_IMAGE (
            {RECT 1 1 40 40}
            terrain=Ryd,Rr,Yr^Xp,Yr,Yl
            ) 32 ("scenery/gibs1.png,scenery/gibs2.png,scenery/gibs3.png")}

        {VARIABLE must_seek_prison no}
        {VARIABLE have_drake no}
        {VARIABLE have_troll no}

        # Generate door locations from the map; slower than hardcoding at runtime,
        # but it makes it easier for writing the WML on my part :-)
        [store_locations]
            terrain=Xg^Z*
            variable=door_tilemap_store
        [/store_locations]
        {FOREACH door_tilemap_store k}
        [unit]
            side=7
            [modifications]
                {TRAIT_MECHANICAL}
            [/modifications]
            type=Door
            x=$door_tilemap_store[$k].x
            y=$door_tilemap_store[$k].y
            description=door_at_x$door_tilemap_store[$k].x|_y$door_tilemap_store[$k].y|
        [/unit]
        {NEXT k}
        {CLEAR_VARIABLE door_tilemap_store}
        # Recall heroes
        {RECALL_POS Elynia 37 32}
        {RECALL_POS (Mal Keshar) 38 31}
        {RECALL_POS Erathan 36 30}
        {RECALL Igor}

        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Explore and find your way to the main Keep with Galas, Elynia, Mal Keshar or Erathan")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Erathan")}
            {OBJECTIVE_NOTES ( _ "Your troops will not available for recalling or recruiting after the first turn is over, so you should choose your units carefully and try to keep them alive until the end of the mission. There is no turn limit.")}
        [/objectives]
    [/event]

#ifdef EASY
    [event]
        name=prestart
        [terrain]
            x=35,39,36,39
            y=30,30,32,32
            terrain=Ce
        [/terrain]
    [/event]
    [event]
        name=turn 2
        [terrain]
            x=35,39,36,39
            y=30,30,32,32
            terrain=Re
        [/terrain]
    [/event]
#endif

    [event]
        name=start
        {MSG_UNIT (Elynia) ( _ "A presence... a strong presence fills this whole place...")}
        [message]
            speaker=narrator
            caption= _ "Looming Voice coming from Everywhere"
            message= _ "And then you dared enter my base. You are more foolish than I thought, but never mind. I have been waiting for you, specially for Galas and... Elynia..."
            image=units/random-enemy.png
        [/message]
        {MSG_UNIT (Elynia) ( _ "Reveal yourself, you coward fiend! Who are you?")}
        {MSG_NARRATOR ( _ "(silence)")}
        {MSG_UNIT (Elynia) ( _ "Nothing. Whoever it is, it still hides from us.")}
        {MSG_UNIT (Galas) ( _ "So close, yet so far... We will have to find a way to open these iron gates.")}
        # FIXME: Is " a la antiqua" a latin phrase for "in the olde' style"?
        {MSG_UNIT (Mal Keshar) ( _ "Oh, please, this is not grandma's house. Just blow them up or crush them down and we can continue,  a la antiqua.")}
        {MSG_UNIT (Galas) ( _ "I was about to suggest that.")}
        {MSG_UNIT (Elynia) ( _ "Galas, it seems that some of our comrades didn't resist the temptation to come in.")}
        {MSG_UNIT (Galas) ( _ "Oh... alright, but we can't go all together. Letting the weakest ones go with us could put us all in risk.")}
        {MSG_NARRATOR ( _ "Choose your recruits and recalls carefully. They won't require income, but you should try to keep them alive for as long as possible")}
    [/event]

    # ================== ITEMS' CODE ==================

#define __CHECK_PRISONERS
    [if]
        [have_unit]
            description=Lédinor
            side=1
        [/have_unit]
        {VARIABLE_BOOLEAN_EQUALS have_drake yes}
        {VARIABLE_BOOLEAN_EQUALS have_troll yes}
        [then]
            {VARIABLE must_seek_prison no}
            [objectives]
                side=1
                {OBJECTIVE_TO_WIN ( _ "Explore and find your way to the main Keep with Galas, Elynia, Mal Keshar or Erathan")}
                {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
                {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
                {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
                {OBJECTIVE_TO_LOSE ( _ "Death of Lédinor")}
                {OBJECTIVE_TO_LOSE ( _ "Death of Erathan")}
                {OBJECTIVE_NOTES ( _ "Your troops will not available for recalling or recruiting after the first turn is over, so you should choose your units carefully and try to keep them alive until the end of the mission. There is no turn limit.")}
            [/objectives]
        [/then]
    [/if]
#enddef

    # Elvish prisoner
    [item]
        x,y=23,14
        image="units/elves-wood/lord.png~RC(magenta>red)"
    [/item]
    [item]
        x,y=23,14
        image="items/cage.png"
    [/item]
    [event]
        name=moveto
        [filter]
            side,x,y=1,23,14
        [/filter]
        {REMOVE_IMAGE $x1 $y1}
        [unit]
            type=Elvish Lord
            description=Lédinor
            user_description= _ "Lédinor"
            unrenamable=yes
            hitpoints=2
            upkeep=loyal
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_DEXTROUS}
            [/modifications]
            side=1
            x=$x1
            y=$y1
            {IS_HERO}
            profile=portraits/ledinor.png
        [/unit]
        {REDRAW}
        {DELAY 600}
        {MSG_UNIT Galas ( _ "My lord, Lédinor! But... what did these beasts do with you?!")}
        {MSG_UNIT Elynia ( _ "He looks awfully weak and tortured. Come, this shall heal you.")}
        [scroll_to]
            x=$x1
            y=$y1
        [/scroll_to]
        {PLAY_SOUND heal.wav}
        {FULL_HEAL (description=Lédinor)}
        {REDRAW}
        {DELAY 600}
        {MSG_UNIT Lédinor ( _ "Ah... thanks, I feel much better. I thought my life would slowly end in these dungeons; why did you come here? This is a dangerous place.")}
        {MSG_UNIT Galas ( _ "We'll tell you in the way. It's a long story.")}
        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Search for prisoners and set them free")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Lédinor")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Erathan")}
            {OBJECTIVE_NOTES ( _ "Your troops will not available for recalling or recruiting after the first turn is over, so you should choose your units carefully and try to keep them alive until the end of the mission. There is no turn limit.")}
        [/objectives]
        {__CHECK_PRISONERS}
        {SCROLL_TO $x1 $y1}
    [/event]

    # Drake prisoner
    [item]
        x,y=20,14
        image="units/drakes/sky.png~RC(magenta>red)~FL(horiz)"
    [/item]
    [item]
        x,y=20,14
        image="items/cage.png"
    [/item]
    [event]
        name=moveto
        [filter]
            x,y=20,14
            side=1
        [/filter]
        {VARIABLE have_drake yes}
        {REMOVE_IMAGE 20 14}
        {EX_LOYAL_UNIT (Sky Drake) ("Rurhló") ( _ "Rurhló") 1 20 14}
        {MSG_UNIT ("Rurhló") ( _ "Thanks for freeing me, noble ones. In exchange, I'll join you in your quest!")}
        {__CHECK_PRISONERS}
        {SCROLL_TO $x1 $y1}
    [/event]

    # Troll prisoner
    [item]
        x,y=22,9
        image="units/trolls/whelp.png~RC(magenta>red)~FL(horiz)"
    [/item]
    [item]
        x,y=22,9
        image="items/cage.png"
    [/item]
    [event]
        name=moveto
        [filter]
            x,y=22,9
            side=1
        [/filter]
        {VARIABLE have_troll yes}
        {REMOVE_IMAGE 22 9}
        {EX_LOYAL_UNIT (Troll Whelp) ("Garg") ( _ "Garg") 1 22 9}
        {MSG_UNIT ("Garg") ( _ "Garg is thankful to you, good ones. Garg will follow you and get revenge on the bad ones.")}
        {__CHECK_PRISONERS}
        {SCROLL_TO $x1 $y1}
    [/event]

    # Strength potion at 28,18 (+8 HP, +1 melee damage)
    {PICK_UP (items/potion-red.png) 28 18
    ( _ "It is a strength potion. The flaks contains enough for only one of us, but surely we can make good use of it in this creepy fortress. Who should take it?")
    (
        [object]
            id=strength_potion_25_1
            name= _ "Potion of Strength"
            image=icons/potion-red-1.png
            duration=forever
            description= _ "This potion has increased the drinker's strength until the end of this mission. Their hitpoints are increased by 8, and their melee attacks deal 1 extra damage point."
            cannot_use_message= _ "This potion can only be used by living beings. Let other take it."
            [filter]
                x,y=28,18
                [not]
                    race=undead
                [/not]
                [not]
                    race=elvish_spirits
                [/not]
            [/filter]
            [then]
                [removeitem]
                    x,y=28,18
                [/removeitem]
            [/then]
            [effect]
                apply_to=attack
                range=melee
                increase_damage=1
            [/effect]
            [effect]
                apply_to=hitpoints
                increase_total=8
                heal_full=yes
            [/effect]
        [/object]
    )}

    # Potion at 24,20 (+1 MP, +1 ranged attack)
    {PICK_UP (items/potion-cyan.png) 24 20
    ( _ "Interesting. I have heard of special potions like this that increase your agility in various ways, but never thought that one of them could be hidden in these chambers. I wonder how much of it has been supplied to the Chaos followers.")
    (
        [object]
            id=deftness_potion_25_1
            name= _ "Potion of Deftness"
            image=icons/potion-cyan-2.png
            duration=forever
            description= _ "This magic potion will increase the drinker's movement points by one (quick), and increase the inflicted base damage of its ranged attacks by one (dextrous), if applicable."
            cannot_use_message= _ "This potion can only be used by living beings. Let other take it."
            [filter]
                x,y=24,20
                [not]
                    race=undead
                [/not]
                [not]
                    race=elvish_spirits
                [/not]
            [/filter]
            [then]
                [removeitem]
                    x,y=24,20
                [/removeitem]
            [/then]
            [effect]
                apply_to=attack
                range=ranged
                increase_damage=1
            [/effect]
            [effect]
                apply_to=movement
                increase=1
            [/effect]
        [/object]
    )}

    # Amulet at 34,36
    {PICK_UP (items/ankh-necklace.png) 34 36
    ( _ "Oh, an amulet and a scroll. I'll read it... 'this amulet will imbue missiles shot at long-range by the bearer with arcane energy, to cast fear and despair upon their unholy enemies. Those goons probably hid it in this well-guarded place because they could not figure how to use it properly, but perhaps we have more luck.")
    (
        [object]
            id=amulet_25_1
            name= _ "Amulet of the Arcane Flows"
            image=items/ankh-necklace.png
            duration=forever
            description= _ "This amulet will grant the bearer's arcane power to their ranged attacks, and increase their resistance to arcane damage by 10%."
            cannot_use_message= _ "This amulet can only be used by living beings that are not faeries or bats. Let other unit take it."
            [filter]
                x,y=34,36
                [not]
                    race=undead
                [/not]
                [not]
                    race=elvish_spirits
                [/not]
                [not]
                    race=fairy
                [/not]
                [not]
                    race=bats
                [/not]
            [/filter]
            [then]
                [removeitem]
                    x,y=34,36
                [/removeitem]
            [/then]
            [effect]
                apply_to=attack
                range=ranged
                set_type=arcane
            [/effect]
            [effect]
                apply_to=resistance
                replace=false
                [resistance]
                    arcane=-10%
                [/resistance]
            [/effect]
        [/object]
    )}

    # Touchgem at 3,15, and its forcefield
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=14-16
            y=17-19
            side=1
        [/filter]
        {ALLOW_UNDO}
        [if]
            {VARIABLE_NUM_EQUALS touchgem_3_15 0}
            [then]
                {MSG_NARRATOR (_"Find the touchgem trigger to deactivate this magic force-field.")}
            [/then]
        [/if]
    [/event]
    [event]
        name=prestart
        {VARIABLE touchgem_3_15 0}
    [/event]
    [event]
        name=victory
        {CLEAR_VARIABLE touchgem_3_15}
    [/event]
    [item]
        x,y=3,15
        image=items/ball-green.png
    [/item]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=3,15
            side=1
        [/filter]
        [if]
            {VARIABLE_NUM_EQUALS touchgem_3_15 0}
            [then]
                {VARIABLE touchgem_3_15 1}
                [terrain]
                    x=14-16
                    y=18
                    terrain=Ryd # wmllint: ignore
                [/terrain]
                [terrain]
                    x,y=15,18
                    terrain=Rr
                [/terrain]
                [remove_shroud]
                    {RECT 13 17 16 18}
                    side=1
                [/remove_shroud]
                {MSG_NARRATOR (_"Touchgem triggered. A magic force-field is deactivated.")}
                {SCROLL_TO_LOCATION_AND_RETURN_TO_PRIMARY_UNIT 15 18}
            [/then]
            [else]
                {MSG_NARRATOR (_"Touchgem already triggered.")}
                #[allow_undo]
                #[/allow_undo]
            [/else]
        [/if]
    [/event]

    # Touchgem at random location, its forcefield, and its prestart generator
    [event]
        name=prestart
        {VARIABLE touchgem_random_location_table[0].x 7}
        {VARIABLE touchgem_random_location_table[0].y 18}

        {VARIABLE touchgem_random_location_table[1].x 13}
        {VARIABLE touchgem_random_location_table[1].y 10}

        {VARIABLE touchgem_random_location_table[2].x 19}
        {VARIABLE touchgem_random_location_table[2].y 10}

        {VARIABLE touchgem_random_location_table[3].x 19}
        {VARIABLE touchgem_random_location_table[3].y 16}

        {VARIABLE touchgem_random_location_table[4].x 21}
        {VARIABLE touchgem_random_location_table[4].y 13}

        {VARIABLE touchgem_random_location_table[5].x 26}
        {VARIABLE touchgem_random_location_table[5].y 10}

        {VARIABLE_RANDOM touchgem_random_location_table_choice 0..5}

        {VARIABLE touchgem_random_x $touchgem_random_location_table[$touchgem_random_location_table_choice].x}
        {VARIABLE touchgem_random_y $touchgem_random_location_table[$touchgem_random_location_table_choice].y}

        {CLEAR_VARIABLE touchgem_random_location_table_choice}
        {CLEAR_VARIABLE touchgem_random_location_table}

        {VARIABLE touchgem_random 0}
        [item]
            x,y=$touchgem_random_x|,$touchgem_random_y|
            image=items/ball-blue.png
        [/item]
        [event]
            name=moveto
            first_time_only=no
            [filter]
                x,y=$touchgem_random_x|,$touchgem_random_y|
                side=1
            [/filter]
            [if]
                {VARIABLE_NUM_EQUALS touchgem_random 0}
                [then]
                    {VARIABLE touchgem_random 1}
                    [terrain]
                        x=18,19
                        y=19,20
                        terrain=Ryd # wmllint: ignore
                    [/terrain]
                    [remove_shroud]
                        {RECT 17 19 20 20}
                        side=1
                    [/remove_shroud]
                    {MSG_NARRATOR (_"Touchgem triggered. A magic force-field is deactivated.")}
                    {SCROLL_TO_LOCATION_AND_RETURN_TO_PRIMARY_UNIT 18 19}
                [/then]
                [else]
                    {MSG_NARRATOR (_"Touchgem already triggered.")}
                    #[allow_undo]
                    #[/allow_undo]
                [/else]
            [/if]
        [/event]
    [/event]
    [event]
        name=victory
        {CLEAR_VARIABLE touchgem_random}
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=17-18,19
            y=20   ,21
            side=1
        [/filter]
        [allow_undo][/allow_undo]
        [if]
            {VARIABLE_NUM_EQUALS touchgem_random 0}
            [then]
                {MSG_NARRATOR (_"Find the touchgem trigger to deactivate this magic force-field.")}
            [/then]
        [/if]
    [/event]

    # Victory code
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=30-32,1
            description=Galas
            {OR (
            description=Mal Keshar
            x,y=30-32,1
            )}
            {OR (
            description=Elynia
            x,y=30-32,1
            )}
            {OR (
            description=Erathan
            x,y=30-32,1
            )}
        [/filter]
        {ALLOW_UNDO}
        {REDRAW}
        [if]
            {VARIABLE_BOOLEAN_EQUALS must_seek_prison yes}
            [then]
                {MSG_SPEAKER unit ( _ "We cannot advance without searching for prisoners in the dungeon and freeing them!")}
            [/then]
            [else]
                {ENDLEVEL_CONTINUE}
            [/else]
        [/if]
    [/event]

    # Enemy boss code
    [event]
        name=moveto
        [filter]
            side=1
            x=30-39
            y=12-17
        [/filter]
        [unit]
            side=3
            description=Hell Gatekeeper
            user_description= _ "Hell Gatekeeper"
            type=Armageddon Imp
            canrecruit=yes
            x,y=33,15
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            description=shaxthal1
            user_description= _ "Hive Sentinel"
            type=Shaxthal Sentry Drone
            x,y=32,14
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            description=shaxthal2
            user_description= _ "Hive Defender"
            type=Shaxthal Assault Drone
            x,y=34,15
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            user_description= _ "Hive Defender"
            type=Shaxthal Protector Drone
            x,y=33,16
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            user_description= _ "Biomechanical Drone"
            type=Shaxthal Runner Drone
            x,y=34,11
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            generate_description=yes
            type=Demon Grunt
            x,y=36,12
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            user_description= _ "Metallic Guardian"
            type=Automaton
            x,y=38,13
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            user_description= _ "Biomechanical Drone"
            type=Shaxthal Runner Drone
            x,y=39,15
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            user_description= _ "Crawling Horror"
            type=Psy Crawler
            x,y=39,17
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            generate_description=yes
            type=Chaos Marauder
            x,y=37,18
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            generate_description=yes
            type=Blood Imp
            x,y=35,18
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            generate_description=yes
            type=Doom Guard
            x,y=33,18
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            user_description= _ "Shadow Minion"
            type=Shadow Minion
            x,y=31,18
            {FACING_REVERSE}
        [/unit]
        {MSG_UNIT (Hell Gatekeeper) ( _ "Your foolishness ends here with your death, enemies of the Master! We were sent to stop you from reaching the Gate of Inferno by the Shadow Master, and this time you have no escapatory.")}
        {MSG_UNIT (shaxthal1) ( _ "Ssslay... ssslash... flesshhh...")}
        {MSG_UNIT (shaxthal2) ( _ "Shriak! Greeeeshaaaahhhh...")}
        # Possibly breaking the 4th wall in here :)
        {MSG_UNIT (Galas) ( _ "Ah, the Shadow Master! I cannot wait to meet him personally anymore... get out of our path, you bastards!")}
        {MSG_UNIT (Mal Keshar) ( _ "Damned we are, is it that there is an unlimited source of enemy bosses?")}
        {MSG_UNIT (Galas) ( _ "Haven't you said that many times already?")}
        {MSG_UNIT (Mal Keshar) ( _ "Uh.")}

        [event]
            name=die
            [filter]
                description=Hell Gatekeeper
            [/filter]
            {TREMOR}

            [terrain]
                x=31,32-33,34
                y=11,10   ,9
                terrain=Ryd # wmllint: ignore
            [/terrain]

            {MSG_NARRATOR (_"A wall moves.")}
            [unit]
                side=6
                generate_description=yes
                type=Demon Warrior
                x,y=29,8
                random_gender=yes
            [/unit]
            [unit]
                side=6
                generate_description=yes
                type=Imp
                x,y=30,7
            [/unit]
            [unit]
                side=6
                generate_description=yes
                type=Imp
                x,y=29,7
            [/unit]
            [remove_shroud]
                side=1
                {RECT 28 6 34 10}
            [/remove_shroud]
            {REDRAW}
            {MSG_SUF (x,y=29,8) ( _ "Get back, filthy rebels! No living ones should tresspass these gates!")}
            {MSG_UNIT (Galas) ( _ "Aha, the entrance hall of Inferno!")}
            {MSG_UNIT (Elynia) ( _ "This place must have been severily corrupted to cause this anomaly that connects our world with the demonic homeland.")}
            {MSG_UNIT (Galas) ( _ "Can you close it?")}
            {MSG_UNIT (Elynia) ( _ "No, it is not safe until we discover who did this; bending our space-time to build this connection requires great powers, and I would not doubt that the author of it can open the connection from the other side if its closed from ours.")}
            {SCROLL_TO $x1 $y1}
        [/event]
    [/event]

    [event]
        name=victory
        {GAUNTLET_SAVE_RECALL_METALIST}
        {CLEAR_VARIABLE must_seek_prison}
        {CLEAR_VARIABLE have_drake}
        {CLEAR_VARIABLE have_troll}
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            {RECT 7 9 24 18}
        [/filter]
        {MSG_UNIT Galas ( _ "I think I've just heard a voice, calling for help.")}
        {MSG_UNIT (Mal Keshar) ( _ "And? We can't explore the whole place now, we lack the necessary time for that.")}
        {MSG_UNIT Galas ( _ "Yes, but if it's a prisoner, it would be cruel on our part to leave them abandoned in these dungeons.")}
        {MSG_UNIT (Mal Keshar) ( _ "Alright, search for it.")}
        {VARIABLE must_seek_prison yes}
        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Search for prisoners and set them free")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Erathan")}
            {OBJECTIVE_NOTES ( _ "Your troops will not available for recalling or recruiting after the first turn is over, so you should choose your units carefully and try to keep them alive until the end of the mission. There is no turn limit.")}
        [/objectives]
    [/event]

    # Glyph at (35,2), and its forcefield
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=34
            y=3-5
            side=1
        [/filter]
        {ALLOW_UNDO}
        [if]
            {VARIABLE_NUM_EQUALS touchgem_35_2 0}
            [then]
                {MSG_NARRATOR (_"You may not pass yet.")}
            [/then]
        [/if]
    [/event]
    [event]
        name=prestart
        {VARIABLE touchgem_35_2 0}
    [/event]
    [event]
        name=victory
        {CLEAR_VARIABLE touchgem_35_2}
    [/event]
    {ITEM_CRYSTAL_GLYPH 35 2}
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=35,2
            side=1
            [not]
                description=Elynia
            [/not]
        [/filter]
        {ALLOW_UNDO}
        {REDRAW}
        [if]
            {VARIABLE_NUM_EQUALS touchgem_35_2 0}
            [then]
                {MSG_NARRATOR (_"Only recognized ones may activate this glyph.")}
            [/then]
            [else]
                {MSG_NARRATOR (_"Glyph already activated.")}
            [/else]
        [/if]
    [/event]

    {PLACE_IMAGE (items/goplate.png) 55 7}

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=35,2
            description=Elynia
        [/filter]
        {ALLOW_UNDO}
        {REDRAW}
        [if]
            {VARIABLE_NUM_EQUALS touchgem_35_2 0}
            [then]
                {VARIABLE touchgem_35_2 1}
                [terrain]
                    x=35
                    y=4-5
                    terrain=Ryd # wmllint: ignore
                [/terrain]
                [terrain]
                    x=33-34
                    y=2-4
                    terrain=Ryd # wmllint: ignore
                [/terrain]
                [remove_shroud]
                    {RECT 33 3 38 5}
                    side=1
                [/remove_shroud]
                {MSG_NARRATOR (_"Touchgem triggered. A magic force-field is deactivated.")}
                {SCROLL_TO_LOCATION_AND_RETURN_TO_PRIMARY_UNIT 36 4}
            [/then]
            [else]
                {MSG_NARRATOR (_"Glyph already activated.")}
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=55,3-9
            description=Galas
            {OR (
            description=Mal Keshar
            x,y=55,3-9
            )}
            {OR (
            description=Elynia
            x,y=55,3-9
            )}
            {OR (
            description=Erathan
            x,y=55,3-9
            )}
        [/filter]
        {ALLOW_UNDO}
        {REDRAW}
        {MSG_NARRATOR ( _ "Sorry, the secret scenario is still under construction. You may not play it yet.")}
#         [if]
#             {VARIABLE_BOOLEAN_EQUALS must_seek_prison yes}
#             [then]
#                 {MSG_SPEAKER unit ( _ "We cannot advance without searching for prisoners in the dungeon and freeing them!")}
#             [/then]
#             [else]
#                 {ENDLEVEL_CONTINUE}
#                 {OVERRIDE_NEXT_SCENARIO ("22C_The_Backyard")}
#             [/else]
#         [/if]
    [/event]

    {SET_LABEL 14 15 ( _ "The Dungeon")}
[/scenario]

#undef __CHECK_PRISONERS
