#textdomain wesnoth-Invasion_from_the_Unknown
[scenario]
    id=22A_Innuendo
    name= _ "Innuendo"
    {MAP 22A_Innuendo.map}
    {TURNS 82 75 68}
    next_scenario=22B_Face_of_the_Enemy
    victory_when_enemies_defeated=no

    {EX_SCENARIO_MUSIC_PLAYLIST (
        {EX_MUSIC        "heroes_rite.ogg"}
        {EX_MUSIC_APPEND "suspense.ogg"}
    )}

    {INDOORS_HIVE}

    {DEATHS_END}
    {GLAMOUR_INIT_STUB}
    {GLAMOUR_EVENTS}

    {STORYTXT_INNUENDO}
    {STORYMAP_INNUENDO}

    # NOTE: Reserved item/unit positions (the random location touchgem uses this table):
    # 3,7
    # 5,6
    # 12,4
    # 16,6

    [side]
        type=Elvish Hero
        id=Galas
        name= _ "Galas"
        unrenamable=yes
        side=1
        canrecruit=yes
        controller=human
        team_name=good
        user_team_name= _ "team_name^Galas"
        shroud=yes
        income=-2
        village_gold=0
        {SHROUD_DATA 22A_Innuendo.shroud}
    [/side]

    # Boss supporters
    [side]
        side=2
        controller=ai
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        {HAS_KAMIKAZE_BEHAVIOR}
    [/side]

    # Boss
    [side]
        side=3
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        {HAS_BOSS_BEHAVIOR}
    [/side]

    # Assault Drones
    [side]
        side=4
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Assault Drone) 33 22}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Assault Drone) 35 39}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Assault Drone) 30 35}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Assault Drone) 31 29}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Runner Drone) 2 26}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Runner Drone) 21 25}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Assault Drone) 14 16}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Assault Drone) 16 19}
        {MAKE_FACING_REVERSE}

        {GENERIC_UNIT_AUTOSIDE (Shaxthal Assault Drone) 55 39}
        {MAKE_FACING_REVERSE}
#ifndef EASY
        {GENERIC_UNIT_AUTOSIDE (Shaxthal Assault Drone) 52 40}
        {MAKE_FACING_REVERSE}
#endif
#ifndef EASY
        {GENERIC_UNIT_AUTOSIDE (Shaxthal Protector Drone) 47 35}
        {MAKE_FACING_REVERSE}
#endif
        {GENERIC_UNIT_AUTOSIDE (Shaxthal Protector Drone) 44 36}
        {MAKE_FACING_REVERSE}

        {HAS_KAMIKAZE_BEHAVIOR}
    [/side]

    # Dwelling Drones
    [side]
        side=5
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 30 33}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 27 35}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 25 28}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 21 30}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Protector Drone) 36 21}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Runner Drone) 34 24}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Runner Drone) 40 23}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Protector Drone) 19 34}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 28 22}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 3 36}
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Runner Drone) 4 15}

        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 24 22}
        {MAKE_FACING_REVERSE}
#ifdef HARD
        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Sentry Drone) 22 23}
        {MAKE_FACING_REVERSE}
#endif
        {HAS_KAMIKAZE_BEHAVIOR}
    [/side]

    # Guardians
    [side]
        side=6
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {CHAOS_FLAG}
        {GENERIC_GUARDIAN_AUTOSIDE (Worker Droid) 23 33}
        {GENERIC_GUARDIAN_AUTOSIDE (Worker Droid) 15 38}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Gutwrencher Imp) 5 31}
        {GENERIC_GUARDIAN_AUTOSIDE (Psy Crawler) 5 32}
        {GENERIC_GUARDIAN_AUTOSIDE (Psy Crawler) 6 31}
        {GENERIC_GUARDIAN_AUTOSIDE (Psy Crawler) 6 32}
        {GENERIC_GUARDIAN_AUTOSIDE (Psy Mindraider) 13 38}
        {GENERIC_GUARDIAN_AUTOSIDE (Blood Imp) 15 33}
        {GENERIC_GUARDIAN_AUTOSIDE (Imp) 11 37}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Blood Imp) 4 38}
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Soulhunter) 10 36}
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Headhunter) 12 24}
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Headhunter) 17 27}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Magus) 13 14}
        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Invoker) 12 10}

        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Marauder) 26 15}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Minor Imp) 7 37}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Minor Imp) 12 34}
        {GENERIC_GUARDIAN_AUTOSIDE (Minor Imp) 13 31}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Minor Imp) 18 32}
        {GENERIC_GUARDIAN_AUTOSIDE (Iron Golem) 5 24}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Worker Droid) 8 25}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Worker Droid) 10 26}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Goliath) 10 33}
        {GENERIC_GUARDIAN_AUTOSIDE (Goliath) 21 19}
        {MAKE_FACING_REVERSE}

        {GENERIC_GUARDIAN_AUTOSIDE (Chaos Lore) 25 31}
        {GENERIC_GUARDIAN_AUTOSIDE (Goliath) 7 28}
        {GENERIC_UNIT_AUTOSIDE (Hellhound) 49 38}
        {MAKE_FACING_REVERSE}

        {GENERIC_GUARDIAN_AUTOSIDE (Automaton) 9 26}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Demon Zephyr) 5 22}
        {GENERIC_GUARDIAN_AUTOSIDE (Demon) 1 17}

        {GENERIC_GUARDIAN_AUTOSIDE (Shadow Spawn) 24 11}
        {GENERIC_GUARDIAN_AUTOSIDE (Shadow Spawn) 10 11}

        {GENERIC_GUARDIAN_AUTOSIDE (Shadow Spawn) 30 3}
        {GENERIC_GUARDIAN_AUTOSIDE (Shadow Spawn) 30 1}
        {GENERIC_GUARDIAN_AUTOSIDE (Shadow Spawn) 32 3}
        {MAKE_FACING_REVERSE}
        {GENERIC_GUARDIAN_AUTOSIDE (Shadow Spawn) 32 1}
        {MAKE_FACING_REVERSE}

        {GENERIC_GUARDIAN_AUTOSIDE (Demon Zephyr) 20 11}
        {MAKE_FACING_REVERSE}

        {GENERIC_GUARDIAN_AUTOSIDE (Shaxthal Runner Drone) 16 13}
        {MAKE_FACING_REVERSE}

        {HAS_KAMIKAZE_BEHAVIOR}
    [/side]

    # Doors (fake player)
    [side]
        side=7
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {IS_NPC}
        {CHAOS_FLAG}

        {HAS_KAMIKAZE_BEHAVIOR}
    [/side]

    # Matrices
    [side]
        side=8
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {HAS_KAMIKAZE_BEHAVIOR}

        {CHAOS_FLAG}

        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 17 12}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 18 12}

        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 17 23}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 12 20}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 22 16}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 26 12}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 27 8}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 11 14}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 11 17}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 14 19}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 30 22}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 35 22}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 39 26}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 32 25}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 3 14}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 2 14}

        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Core) 37 40}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 32 38}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 30 38}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 19 10}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 7 18}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 26 10}

        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 6 9}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 7 12}
        {GENERIC_GUARDIAN_AUTOSIDE (Verlissh Matrix Flow System) 13 10}
    [/side]

    [side]
        side=9
        no_leader=yes
        team_name=foes
        {HIDDEN_TEAM}
        income=-2
        gold=0
        village_gold=0
        {HAS_KAMIKAZE_BEHAVIOR}

        {CHAOS_FLAG}

        recruit=Psy Crawler,Verlissh Spearbearer,Chaos Hound
    [/side]

    {PLACE_IMAGE ("items/barrel.png") 11 18}
    {PLACE_IMAGE ("items/barrel.png") 19 22}
    {PLACE_IMAGE ("items/barrel.png") 15 27}

    {PLACE_IMAGE ("scenery/enchantress-statue-w.png") 45 4}
    {PLACE_IMAGE ("scenery/enchantress-statue-w.png") 46 5}

    {PLACE_IMAGE ("scenery/bookshelf-full.png~FL(horiz)") 17 31}
    {PLACE_IMAGE ("scenery/bookshelf.png") 3 34}
    {PLACE_IMAGE ("scenery/dinnertable.png") 16 37}
    {PLACE_IMAGE ("scenery/chair-s.png") 16 36}
    {PLACE_IMAGE ("scenery/chair-n.png") 16 38}
    {PLACE_IMAGE ("scenery/chair-se.png") 15 37 }
    {PLACE_IMAGE ("scenery/chair-sw.png") 17 37 }
    {PLACE_IMAGE ("scenery/chair-nw.png") 17 38 }
    {PLACE_IMAGE ("items/altar-bloody.png") 11 34}
    {PLACE_IMAGE ("scenery/monolith4.png") 5 35}
    {PLACE_IMAGE ("scenery/monolith1.png") 8 37}
    {PLACE_IMAGE ("scenery/monolith2.png") 10 32}
    {PLACE_IMAGE ("scenery/monolith3.png") 13 36}
    {PLACE_IMAGE ("scenery/rock-cairn.png") 12 40}
    {PLACE_IMAGE ("scenery/hero-statue-w.png") 22 37}
    {PLACE_IMAGE ("items/bones.png~FL(horiz)") 19 36}
    {PLACE_IMAGE ("items/bones.png") 15 30}
    {PLACE_IMAGE ("items/ornate2.png") 6 38}
    {PLACE_IMAGE ("scenery/gibs1.png") 25 38}
    {PLACE_IMAGE ("scenery/gibs1.png") 21 24}
    {PLACE_IMAGE ("items/bones.png~FL(horiz)") 13 21}
    {PLACE_IMAGE ("items/bones.png") 3 16}

    {ANIMATED_BRAZIER 29 14}

    {ANIMATED_BRAZIER 29 14}
    {ANIMATED_BRAZIER 36 18}
    {ANIMATED_BRAZIER 34 8}
    {ANIMATED_BRAZIER 16 24}
    {ANIMATED_BRAZIER 2 39}
    #{ANIMATED_BRAZIER 39 36}
    #{PLACE_IMAGE ("items/brazier.png") 36 34}
    {PLACE_IMAGE ("items/brazier.png") 35 33}
    {ANIMATED_BRAZIER 40 30}
    {ANIMATED_BRAZIER 36 29}
    {PLACE_IMAGE ("items/brazier.png") 31 20}
    {PLACE_IMAGE ("items/brazier.png") 20 26}
    {ANIMATED_BRAZIER 13 27}
    {PLACE_IMAGE ("items/brazier.png") 10 24}
    {PLACE_IMAGE ("items/brazier.png") 2 25}
    {ANIMATED_BRAZIER 3 21}
    {ANIMATED_BRAZIER 10 40}
    {PLACE_IMAGE ("items/brazier.png") 19 40}
    {ANIMATED_BRAZIER 19 32}
    {ANIMATED_BRAZIER 14 29}
    {PLACE_IMAGE ("items/brazier.png") 11 30}
    {PLACE_IMAGE ("items/brazier.png") 5 30}
    {ANIMATED_BRAZIER 29 29}
    {PLACE_IMAGE ("items/brazier.png") 26 30}
    {ANIMATED_BRAZIER 22 32}
    {ANIMATED_BRAZIER 22 34}
    {PLACE_IMAGE ("items/brazier.png") 26 32}
    {PLACE_IMAGE ("items/brazier.png") 30 30}
    {ANIMATED_BRAZIER 21 35}
    {ANIMATED_BRAZIER 27 24}
    {ANIMATED_BRAZIER 33 21}
    {ANIMATED_BRAZIER 29 26}
    {PLACE_IMAGE ("items/brazier.png") 2 28}
    {ANIMATED_BRAZIER 7 27}
    {ANIMATED_BRAZIER 2 35}
    {ANIMATED_BRAZIER 10 34}
    {ANIMATED_BRAZIER 1 15}
    {ANIMATED_BRAZIER 23 18}
    {PLACE_IMAGE ("items/brazier.png") 25 15}
    {ANIMATED_BRAZIER 32 18}
    {ANIMATED_BRAZIER 39 16}
    {ANIMATED_BRAZIER 36 11}
    {ANIMATED_BRAZIER 29 7}

    {PLACE_IMAGE ("items/coffin-closed.png") 5 10}
    {PLACE_IMAGE ("items/box.png") 16 10}
    {PLACE_IMAGE ("items/altar-evil.png") 9 15}
    {PLACE_IMAGE ("items/altar-bloody.png") 27 14}
    {PLACE_IMAGE ("scenery/trash.png") 19 13}
    {PLACE_IMAGE ("items/coffin-closed.png") 23 11}

    {ANIMATED_BRAZIER 43 32}
    {ANIMATED_BRAZIER 38 34}
    {PLACE_IMAGE ("items/brazier.png") 46 33}
    {ANIMATED_BRAZIER 41 36}
    {PLACE_IMAGE ("items/brazier.png") 49 35}
    {PLACE_IMAGE ("items/brazier.png") 44 37}
    {ANIMATED_BRAZIER 52 36}
    {ANIMATED_BRAZIER 47 39}
    {PLACE_IMAGE ("items/brazier.png") 55 38}
    {ANIMATED_BRAZIER 50 40}

    {SETUP_SHAXTHAL_ROAMING_SOUND_EFFECTS}

    {FINAL_SCENARIO_PLAYER_RECRUITMENT}

    [event]
        name=turn 2
        [terrain]
            x=35,39,36 #,39
            y=30,30,32 #,32
            terrain=Re
        [/terrain]
    [/event]

    [event]
        name=prestart
        # wmllint: recognize Igor
        # wmllint: recognize Erathan
        # wmllint: recognize Elynia
        # wmllint: recognize Mal Keshar
        # wmllint: recognize Lédinor
        # wmllint: recognize Rurhló
        # wmllint: recognize Garg
        # Scatter gibs all over the place
        {EX_SCATTER_IMAGE (
            {RECT 1 1 40 40}
            terrain=Ryd,Rr,Yhr^Xp,Yhr,Yhl
        ) 32 ("scenery/gibs1.png,scenery/gibs2.png,scenery/gibs3.png")}

        {VARIABLE must_seek_prison no}
        {VARIABLE have_drake no}
        {VARIABLE have_troll no}

        # Generate door locations from the map
        {DOOR_TILES_TO_UNITS (7)}

        # Recall heroes
        {RECALL_POS Elynia 37 32}
        {RECALL_POS (Mal Keshar) 38 31}
        {RECALL_POS Erathan 36 30}
        {RECALL Igor}

        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Explore and descend deeper underground with Galas, Elynia, or Mal Keshar.")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
            {OBJECTIVE_NOTES ( _ "Your troops will not be available for recalling or recruiting once the first turn is over, so you should choose your units carefully and try to keep them alive until the end of the mission.")}
        [/objectives]
    [/event]

#ifdef EASY
    [event]
        name=prestart
        [terrain]
            x=35,39,36,39
            y=30,30,32,32
            terrain=Ce
        [/terrain]
    [/event]
    [event]
        name=turn 2
        [terrain]
            x=35,39,36,39
            y=30,30,32,32
            terrain=Re
        [/terrain]
    [/event]
#endif

    [event]
        name=start
        {MSG_UNIT (Elynia) ( _ "A presence... A strong, dark presence fills this whole place. This is not just a citadel; there is something wrong with the place itself. The floor, the ceiling, the walls...they seem alive.")}

        {MSG_UNIT (Galas) ( _ "Quickly! Someone must close the gates!")}

        {MSG_SUF (x,y="49","38") ( _ "Airz kalfa thor! Kalfa thor!")}

        {MSG_UNIT (Mal Keshar) ( _ "No! We cannot waste time with that! Onwards! We must find our way to the...")}

        {MSG_BIGBOSS2 ( _ "And then you dare to enter my stronghold... You are more foolish than I first imagined, but never mind. I have been waiting for you, especially for Galas and... Elynia...")}

        {QUAKE (cave-in.ogg)}
        {PLAY_SOUND dwarf-laugh.wav}
        {MSG_UNIT (Elynia) ( _ "Reveal yourself, you coward who hides in the darkness! Who are you?")}
        {QUAKE (rumble.ogg)}

        {MSG_UNIT (Igor) ( _ "It doesn't look like he wants to answer your questions!")}

        {MSG_UNIT (Erathan) ( _ "Whatever creature he is, he does not sound very natural with that metallic voice.")}

        {MSG_UNIT (Elynia) ( _ "I suppose he will continue hiding from us until the end. Know that we will get our answers very soon!")}

        {MSG_UNIT (Galas) ( _ "We will have to find a way to open those gigantic iron gates.")}

        {MSG_UNIT (Mal Keshar) ( _ "Oh please, this is not grandma's house. Just blow them up or beat them down - courtesy is wasted in a place like this.")}

        {MSG_UNIT (Elynia) ( _ "Galas, it would seem that some of our comrades could not resist the temptation to come inside with us.")}

        {MSG_UNIT (Galas) ( _ "We cannot do anything to stop them, but we cannot go all together. The bulk of our forces should remain here and stop any enemy reinforcements that may arrive.")}

        {MSG_NARRATOR ( _ "Choose your recruits and recalls carefully. They won't require income, but you should try to keep them alive for as long as possible.")}
    [/event]

    # ================== ITEMS' CODE ==================

#define __CHECK_PRISONERS
    [if]
        [have_unit]
            id=Lédinor
            side=1
        [/have_unit]
        {VARIABLE_BOOLEAN_EQUALS have_drake yes}
        {VARIABLE_BOOLEAN_EQUALS have_troll yes}
        [then]
            {VARIABLE must_seek_prison no}
            [objectives]
                side=1
                {OBJECTIVE_TO_WIN ( _ "Explore and descend deeper underground with Galas, Elynia, or Mal Keshar.")}
                {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
                {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
                {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
                {OBJECTIVE_TO_LOSE ( _ "Death of Lédinor")}
                {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
                {OBJECTIVE_NOTES ( _ "Your troops will not be available for recalling or recruiting once the first turn is over, so you should choose your units carefully and try to keep them alive until the end of the mission.")}
            [/objectives]
        [/then]
    [/if]
#enddef

    # Elvish prisoner
    [item]
        x,y=23,14
        image="units/elves-wood/lord.png~RC(magenta>red)"
    [/item]
    [item]
        x,y=23,14
        image="items/cage.png"
    [/item]
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                [filter_adjacent_location]
                    x,y=23,14
                [/filter_adjacent_location]
            [/filter_location]
        [/filter]
        [terrain]
            terrain=Uu
            x,y=23,14
        [/terrain]
        {REMOVE_IMAGE 23 14}
        [unit]
            type=Elvish Lord
            id=Lédinor
            name= _ "Lédinor"
            unrenamable=yes
            hitpoints=2
            upkeep=loyal
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_DEXTROUS}
            [/modifications]
            side=1
            x=23
            y=14
            {IS_HERO}
            profile=portraits/ledinor.png
        [/unit]
        {REDRAW}
        {DELAY 600}

        {MSG_UNIT Galas ( _ "My lord, Lédinor! But...what have these beasts done to you?!")}

        {MSG_UNIT Elynia ( _ "He looks awfully weak and tortured. Come, this shall heal you.")}

        [scroll_to]
            x=23
            y=14
        [/scroll_to]
        {PLAY_SOUND heal.wav}
        {FULL_HEAL (id=Lédinor)}
        {REDRAW}
        {DELAY 600}

        {MSG_UNIT Lédinor ( _ "Ah... Thanks... I feel...much better. I thought my life would slowly end...in these dark dungeons... Why did you come here? This is a very dangerous place...")}

        {MSG_UNIT Galas ( _ "We'll tell you on the way. It's a long story.")}

        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Search for prisoners and set them free.")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Lédinor")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
            {OBJECTIVE_NOTES ( _ "Your troops will not be available for recalling or recruiting once the first turn is over, so you should choose your units carefully and try to keep them alive until the end of the mission.")}
        [/objectives]
        {__CHECK_PRISONERS}
        {SCROLL_TO 23 14}
    [/event]

    # Drake prisoner
    [item]
        x,y=20,14
        image="units/drakes/sky.png~RC(magenta>red)~FL(horiz)"
    [/item]
    [item]
        x,y=20,14
        image="items/cage.png"
    [/item]
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                [filter_adjacent_location]
                    x,y=20,14
                [/filter_adjacent_location]
            [/filter_location]
        [/filter]
        {VARIABLE have_drake yes}
        [terrain]
            terrain=Uu
            x,y=20,14
        [/terrain]
        {REMOVE_IMAGE 20 14}
        {EX_LOYAL_UNIT (Sky Drake) ("Rurhló") ( _ "Rurhló") 1 20 14}
        [+unit]
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
        {REDRAW}

        {MSG_UNIT ("Rurhló") ( _ "Thank you for freeing me, noble ones. In exchange, I'll join you on your quest!")}

        {__CHECK_PRISONERS}
        {SCROLL_TO 20 14}
    [/event]

    # Troll prisoner
    [item]
        x,y=22,9
        image="units/trolls/whelp.png~RC(magenta>red)~FL(horiz)"
    [/item]
    [item]
        x,y=22,9
        image="items/cage.png"
    [/item]
    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                [filter_adjacent_location]
                    x,y=22,9
                [/filter_adjacent_location]
            [/filter_location]
        [/filter]
        {VARIABLE have_troll yes}
        {REMOVE_IMAGE 22 9}
        [terrain]
            terrain=Uu
            x,y=22,9
        [/terrain]

        {EX_LOYAL_UNIT (Troll Whelp) ("Garg") ( _ "Garg") 1 22 9}

        [+unit]
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]
        {REDRAW}

        {MSG_UNIT ("Garg") ( _ "Garg is thankful to you, good ones. Garg will follow you and get revenge on the evil ones.")}

        {__CHECK_PRISONERS}
        {SCROLL_TO $x1 $y1}
    [/event]

    # Strength potion at 28,18 (+8 HP, +1 melee damage)
    {PICK_UP (items/potion-red.png) 28 18
    ( _ "It is a strength potion. The flask contains only enough for one living being, but surely it will be very helpful as we descend deeper into this damned fortress. Who should take it?")
    (
        [object]
            id=strength_potion_25_1
            name= _ "Potion of Strength"
            image=icons/potion-red-1.png
            duration=forever
            description= _ "This potion has increased the drinker's strength until the end of this mission. Their hitpoints are increased by 8, and their melee attacks deal 1 extra damage point."
            cannot_use_message= _ "This potion can only be used by living beings. Let another take it."
            [filter]
                x,y=28,18
                [not]
                    race=undead
                [/not]
                [not]
                    race=elvish_spirits
                [/not]
                [not]
                    [filter_wml]
                        [status]
                            not_living=yes
                        [/status]
                    [/filter_wml]
                [/not]
            [/filter]
            [then]
                [removeitem]
                    x,y=28,18
                [/removeitem]
            [/then]
            [effect]
                apply_to=attack
                range=melee
                increase_damage=1
            [/effect]
            [effect]
                apply_to=hitpoints
                increase_total=8
                heal_full=yes
            [/effect]
        [/object]
    )}

    # Potion at 24,20 (+1 MP, +1 ranged attack)
    {PICK_UP (items/potion-cyan.png) 24 20
    ( _ "Interesting. I have heard of special potions that increase the agility of living beings in various ways, but I never imagined one could be hidden in these chambers. I wonder how much of it has been supplied to the enemy troops.")
    (
        [object]
            id=deftness_potion_25_1
            name= _ "Potion of Deftness"
            image=icons/potion-cyan-2.png
            duration=forever
            description= _ "This magic potion will increase the drinker's movement points by one (quick), and increase the inflicted base damage of its ranged attacks by one (dextrous), if applicable."
            cannot_use_message= _ "This potion can only be used by living beings. Let another take it."
            [filter]
                x,y=24,20
                [not]
                    race=undead
                [/not]
                [not]
                    race=elvish_spirits
                [/not]
                [not]
                    [filter_wml]
                        [status]
                            not_living=yes
                        [/status]
                    [/filter_wml]
                [/not]
            [/filter]
            [then]
                [removeitem]
                    x,y=24,20
                [/removeitem]
            [/then]
            [effect]
                apply_to=attack
                range=ranged
                increase_damage=1
            [/effect]
            [effect]
                apply_to=movement
                increase=1
            [/effect]
        [/object]
    )}

    # Amulet at 34,36
    {PICK_UP (items/ankh-necklace.png) 34 36
    ( _ "Oh, an amulet and a scroll. Let's see here... 'This amulet will imbue long-range missiles shot by the bearer with arcane energy, casting fear and despair upon their unholy enemies.' Those goons probably hid it in this well-guarded place because they could not figure out how to use it properly - but perhaps we'll have more luck.")
    (
        [object]
            id=amulet_25_1
            name= _ "Amulet of the Arcane Flows"
            image=items/ankh-necklace.png
            duration=forever
            description= _ "This amulet will grant the bearer arcane power to their ranged attacks, and increases their resistance to arcane damage by 10%."
            cannot_use_message= _ "This amulet can only be used by living beings that are not faeries or bats. Let another unit take it."
            [filter]
                x,y=34,36
                [not]
                    race=undead
                [/not]
                [not]
                    race=elvish_spirits
                [/not]
                [not]
                    race=fairy
                [/not]
                [not]
                    race=bats
                [/not]
                [not]
                    [filter_wml]
                        [status]
                            not_living=yes
                        [/status]
                    [/filter_wml]
                [/not]
            [/filter]
            [then]
                [removeitem]
                    x,y=34,36
                [/removeitem]
            [/then]
            [effect]
                apply_to=attack
                range=ranged
                set_type=arcane
            [/effect]
            [effect]
                apply_to=resistance
                replace=false
                [resistance]
                    arcane=-10%
                [/resistance]
            [/effect]
        [/object]
    )}

    # Touchgem at 3,15, and its forcefield
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=14-16
            y=17-19
            side=1
        [/filter]
        {ALLOW_UNDO}
        [if]
            {VARIABLE_NUM_EQUALS touchgem_3_15 0}
            [then]
                {MSG_NARRATOR (_"Find the touchgem trigger to deactivate this magic forcefield.")}
            [/then]
        [/if]
    [/event]
    [event]
        name=prestart
        {VARIABLE touchgem_3_15 0}
    [/event]
    [event]
        name=victory
        {CLEAR_VARIABLE touchgem_3_15}
    [/event]
    [item]
        x,y=3,15
        image="items/ball-green.png"
    [/item]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=3,15
            side=1
        [/filter]
        [allow_undo]
        [/allow_undo]
        [if]
            {VARIABLE_NUM_EQUALS touchgem_3_15 0}
            [then]
                {VARIABLE touchgem_3_15 1}
                [terrain]
                    x=14-16
                    y=18
                    terrain=Ryd # wmllint: ignore
                [/terrain]
                [terrain]
                    x,y=15,18
                    terrain=Rr
                [/terrain]
                [remove_shroud]
                    {RECT 13 17 16 18}
                    side=1
                [/remove_shroud]
                [removeitem]
                    x,y="$x1","$y1"
                [/removeitem]
                [item]
                    x,y="$x1","$y1"
                    image="items/ball-magenta.png"
                [/item]
                {MSG_NARRATOR (_"Touchgem triggered. A magic forcefield is deactivated.")}
                {SCROLL_TO_LOCATION_AND_RETURN_TO_PRIMARY_UNIT 15 18}
            [/then]
            [else]
                {MSG_NARRATOR (_"Touchgem already triggered.")}
            [/else]
        [/if]
    [/event]

    # Touchgem at random location, its forcefield, and its prestart generator
    [event]
        name=prestart
        {VARIABLE touchgem_random_location_table[0].x 3}
        {VARIABLE touchgem_random_location_table[0].y 7}

        {VARIABLE touchgem_random_location_table[1].x 5}
        {VARIABLE touchgem_random_location_table[1].y 6}

        {VARIABLE touchgem_random_location_table[2].x 12}
        {VARIABLE touchgem_random_location_table[2].y 4}

        {VARIABLE touchgem_random_location_table[3].x 16}
        {VARIABLE touchgem_random_location_table[3].y 6}

        # XXX - enable once support for 1.5.6 is dropped.
        # {VARIABLE_RANDOM touchgem_random_location_table_choice 0..$($touchgem_random_location_table.length-1)}
        {VARIABLE_RANDOM touchgem_random_location_table_choice 0..3}

        {VARIABLE touchgem_random.x $touchgem_random_location_table[$touchgem_random_location_table_choice].x}
        {VARIABLE touchgem_random.y $touchgem_random_location_table[$touchgem_random_location_table_choice].y}

        {CLEAR_VARIABLE touchgem_random_location_table_choice}
        {CLEAR_VARIABLE touchgem_random_location_table}

        {VARIABLE touchgem_random.enabled no}
        [item]
            x,y="$touchgem_random.x","$touchgem_random.y"
            image="items/ball-blue.png"
        [/item]
        [event]
            name=moveto
            first_time_only=no
            [filter]
                x,y="$touchgem_random.x","$touchgem_random.y"
                side=1
            [/filter]
            [allow_undo]
            [/allow_undo]
            [if]
                {VARIABLE_BOOLEAN_EQUALS touchgem_random.enabled no}
                [then]
                    {VARIABLE touchgem_random.enabled yes}
                    [terrain]
                        x=18,19
                        y=19,20
                        terrain=Ryd # wmllint: ignore
                    [/terrain]
                    [remove_shroud]
                        {RECT 17 19 20 20}
                        side=1
                    [/remove_shroud]
                    [removeitem]
                        x,y="$x1","$y1"
                    [/removeitem]
                    [item]
                        x,y="$x1","$y1"
                        image="items/ball-magenta.png"
                    [/item]
                    {MSG_NARRATOR (_"Touchgem triggered. A magic forcefield is deactivated.")}
                    {SCROLL_TO_LOCATION_AND_RETURN_TO_PRIMARY_UNIT 18 19}
                [/then]
                [else]
                    {MSG_NARRATOR (_"Touchgem already triggered.")}
                [/else]
            [/if]
        [/event]
    [/event]
    [event]
        name=victory
        {CLEAR_VARIABLE touchgem_random}
    [/event]
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x=17-18,19
            y=20   ,21
            side=1
        [/filter]
        [allow_undo][/allow_undo]
        [if]
            {VARIABLE_BOOLEAN_EQUALS touchgem_random.enabled no}
            [then]
                {MSG_NARRATOR (_"Find the touchgem trigger to deactivate this magic forcefield.")}
            [/then]
        [/if]
    [/event]

    # Victory code
    [event]
        name=moveto
        first_time_only=no
        [filter]
            x,y=30-32,1
            [and]
                id=Galas
                [or]
                    id=Mal Keshar
                [/or]
                [or]
                    id=Elynia
                [/or]
            [/and]
        [/filter]
        {ALLOW_UNDO}
        {REDRAW}
        [if]
            {VARIABLE_BOOLEAN_EQUALS must_seek_prison yes}
            [then]
                {MSG_SPEAKER unit ( _ "We can't keep going without searching for prisoners in the dungeon and freeing them!")}
            [/then]
            [else]
                {ENDLEVEL_CONTINUE}
            [/else]
        [/if]
    [/event]

    # Enemy boss code
    [event]
        name=moveto
        [filter]
            side=1
            x=30-39
            y=12-17
        [/filter]
        [unit]
            side=3
            id=Hell Gatekeeper
            name= _ "Hell Gatekeeper"
            type=Armageddon Imp
            canrecruit=yes
            x,y=33,15
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            id=shaxthal1
            name= _ "Hive Sentinel"
            type=Shaxthal Sentry Drone
            x,y=32,14
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            id=shaxthal2
            name= _ "Hive Defender"
            type=Shaxthal Assault Drone
            x,y=34,15
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            name= _ "Hive Defender"
            type=Shaxthal Protector Drone
            x,y=33,16
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            name= _ "Biomechanical Drone"
            type=Shaxthal Runner Drone
            x,y=34,11
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            generate_name=yes
            type=Demon Grunt
            x,y=36,12
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            name= _ "Metallic Guardian"
            type=Automaton
            x,y=38,13
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            name= _ "Biomechanical Drone"
            type=Shaxthal Runner Drone
            x,y=39,15
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            name= _ "Crawling Horror"
            type=Psy Crawler
            x,y=39,17
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            generate_name=yes
            type=Chaos Marauder
            x,y=37,18
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            generate_name=yes
            type=Blood Imp
            x,y=35,18
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            generate_name=yes
            type=Doom Guard
            x,y=33,18
            {FACING_REVERSE}
        [/unit]
        [unit]
            side=2
            name= _ "Shadow Minion"
            type=Shadow Minion
            x,y=31,18
            {FACING_REVERSE}
        [/unit]

        {MSG_UNIT (Hell Gatekeeper) ( _ "Your foolishness ends here with your death, enemies of the Master! We were sent to stop you from reaching the Gate of Inferno by the Shadow Master, and this time there is no escape.")}

        {MSG_UNIT (shaxthal1) ( _ "Ssslay... ssslash... flesshhh...")}

        {MSG_UNIT (shaxthal2) ( _ "Shriak! Greeeeshaaaahhhh...")}

        {MSG_UNIT (Galas) ( _ "Ah, the Shadow Master! I cannot wait to meet him face to face, if he dares to show his face...")}

        {MSG_UNIT (Elynia) ( _ "Get back, vile creatures!")}

        {MSG_UNIT (Hell Gatekeeper) ( _ "Never! You will not pass without killing the last of us!")}

        # Possibly breaking the 4th wall in here :)
        {MSG_UNIT (Mal Keshar) ( _ "Is this our curse? Could there be an unlimited source of enemy bosses with death wishes?")}

        {MSG_UNIT (Igor) ( _ "Aaargh, get out of our way, monsters!")}
    [/event]

    #
    # XXX - CRASH
    # This no longer causes a SIGSEGV since it is not
    # an event spawned by another event.
    #

    [event]
        name=die
        [filter]
            id=Hell Gatekeeper
        [/filter]

        {QUAKE (cave-in.ogg)}

        [terrain]
            x=31,32-33,34
            y=11,10   ,9
            terrain=Ryd # wmllint: ignore
        [/terrain]

        {MSG_NARRATOR (_"A wall moves.")}
        [unit]
            side=6
            generate_name=yes
            type=Demon Warrior
            x,y=29,8
            random_gender=yes
        [/unit]
        [unit]
            side=6
            generate_name=yes
            type=Imp
            x,y=30,7
        [/unit]
        [unit]
            side=6
            generate_name=yes
            type=Imp
            x,y=29,7
        [/unit]
        [remove_shroud]
            side=1
            {RECT 28 6 34 10}
        [/remove_shroud]
        {REDRAW}

        {MSG_SUF (x,y=29,8) ( _ "Get back, filthy rebels! No living beings should trespass these gates!")}

        {MSG_UNIT (Galas) ( _ "Aha, the entrance hall of Inferno!")}

        {MSG_UNIT (Elynia) ( _ "This place must have been severely corrupted to cause this anomaly that connects our world with the demonic homeland.")}

        {MSG_UNIT (Galas) ( _ "Can you close it?")}

        {MSG_UNIT (Elynia) ( _ "No, it is not safe until we discover who did this. Besides, bending our space-time to build this connection requires great powers; I don't think I could destroy it alone. And I certainly wouldn't doubt those evil sorcerers could reopen the connection from the other side if we closed it.")}

        {SCROLL_TO $x1 $y1}
    [/event]

    [event]
        name=victory
        {GAUNTLET_SAVE_RECALL_METALIST}
        {CLEAR_VARIABLE must_seek_prison}
        {CLEAR_VARIABLE have_drake}
        {CLEAR_VARIABLE have_troll}

        {MSG_UNIT (Lédinor) ( _ "This is a very wicked place. It is frightening.")}

        [if]
            [have_unit]
                side,id=1,Erathan
            [/have_unit]
            [then]
                {MSG_UNIT (Erathan) ( _ "And it really stinks like a whole army of corpses.")}

                {MSG_UNIT (Mal Keshar) ( _ "Should I take that as an insult?")}
            [/then]
        [/if]

        {MSG_UNIT (Elynia) ( _ "The deeper we go, and the walls seem more and more alive. Those floating creatures in metallic armor... This cannot be just the craft of the evil humans or demons. There is something much more powerful and complicated going on here. But I know not what it is.")}

        {MSG_UNIT (Galas) ( _ "Onward! Let us see what else we find here.")}
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            {RECT 7 9 24 18}
        [/filter]

        {MSG_UNIT Galas ( _ "I think I've just heard a voice, calling for help.")}

        {MSG_UNIT (Mal Keshar) ( _ "And? We cannot explore the entire place now, we lack the necessary time for that.")}

        {MSG_UNIT Galas ( _ "Yes, but if it's a prisoner, it would be cruel on our part to leave them abandoned in these dungeons.")}

        {MSG_UNIT (Mal Keshar) ( _ "(sighs) Alright, search for them...")}

        {VARIABLE must_seek_prison yes}

        [objectives]
            side=1
            {OBJECTIVE_TO_WIN ( _ "Search for prisoners and set them free.")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Galas")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Elynia")}
            {OBJECTIVE_TO_LOSE ( _ "Death of Mal Keshar")}
            {OBJECTIVE_TO_LOSE ( _ "Turns run out")}
            {OBJECTIVE_NOTES ( _ "Your troops will not be available for recalling or recruiting once the first turn is over, so you should choose your units carefully and try to keep them alive until the end of the mission.")}
        [/objectives]
    [/event]

    {SET_LABEL 14 15 ( _ "The Dungeon")}

    [event]
        name=die
        [filter]
            type=Door
            x=11,12-13
            y=12,11
        [/filter]

        [unit]
            side=9
            canrecruit=yes
            type=Psy Mindraider
            x,y=10,9
            id=Irdelkazeg
            name=_"Irdelkazeg"
        [/unit]

        [store_locations]
            terrain=*^V*
            [and]
                x,y=10,9
                radius=4
            [/and]
            variable=village_store
        [/store_locations]

        {FOREACH village_store k}
            [capture_village]
                side,x,y="9","$village_store[$k].x","$village_store[$k].y"
            [/capture_village]
        {NEXT k}

        {CLEAR_VARIABLE village_store}

        [modify_side]
            side=9
            {GOLD 75 100 125}
            {INCOME (-5) (-2) (0)}
        [/modify_side]

        [unit]
            side=9
            type=Imp
            upkeep=free
            random_traits=yes
            random_gender=yes
            generate_name=yes
            x,y=10,10
        [/unit]

#ifndef EASY
        [unit]
            side=9
            type=Imp
            upkeep=free
            random_traits=yes
            random_gender=yes
            generate_name=yes
            x,y=11,10
        [/unit]
#endif

        [remove_shroud]
            side=1
            {RECT 9 8 15 12}
        [/remove_shroud]

        [redraw][/redraw]

        {MSG_UNIT Irdelkazeg (_"Intruders! Kill them! They must not gain access to the lower corridor!")}

        {MSG_UNIT (Mal Keshar) ( _ "Persistent scum.")}
    [/event]
[/scenario]

#undef __CHECK_PRISONERS
